<% layout("/layouts/boilerplate") -%>

  <style>
    .payment-hero {
      background: linear-gradient(135deg, var(--primary-orange), var(--primary-orange-hover));
      color: var(--white);
      padding: 3rem 0;
      margin-bottom: 2rem;
    }

    .payment-title {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .payment-subtitle {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .payment-card {
      background: var(--white);
      border-radius: var(--radius-2xl);
      overflow: hidden;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--gray-200);
    }

    .payment-summary {
      background: var(--gray-50);
      padding: 2rem;
      border-bottom: 1px solid var(--gray-200);
    }

    .payment-amount {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-orange);
    }

    .booking-details {
      padding: 2rem;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--gray-200);
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      font-weight: 600;
      color: var(--gray-700);
    }

    .detail-value {
      color: var(--gray-900);
      font-weight: 500;
    }

    .wallet-option {
      border: 2px solid #eee;
      border-radius: var(--radius-xl);
      padding: 1.5rem;
      transition: all 0.3s;
      cursor: pointer;
      background: #fafafa;
    }

    .wallet-option:hover {
      border-color: var(--primary-orange);
      background: rgba(254, 107, 0, 0.05);
    }

    .wallet-option.insufficient {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .wallet-option.insufficient:hover {
      border-color: #eee;
      background: #fafafa;
    }
  </style>

  <section class="payment-hero">
    <div class="container text-center">
      <h1 class="payment-title">Complete Your Payment</h1>
      <p class="payment-subtitle">Secure payment processing for your booking</p>
    </div>
  </section>

  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="payment-card animate-fade-in">
          <div class="payment-summary text-center">
            <h3 class="mb-3">Booking Summary</h3>
            <% if (booking.type==='listing' && booking.listing) { let imgUrl=booking.listing.image?.url; if(!imgUrl &&
              booking.listing.images && booking.listing.images.length> 0) imgUrl = booking.listing.images[0].url;
              if(!imgUrl) imgUrl =
              "https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80";
              %>
              <div class="mb-4">
                <img src="<%= imgUrl %>" class="img-fluid rounded mb-3" alt="<%= booking.listing.title %>"
                  style="width: 100%; height: 200px; object-fit: cover; background-color: #f1f5f9;"
                  onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80';">
                <h4>
                  <%= booking.listing.title %>
                </h4>
                <p class="text-muted">
                  <i class="fas fa-map-marker-alt me-1"></i>
                  <%= booking.listing.location %>, <%= booking.listing.country %>
                </p>
              </div>
              <% } else if (booking.type==='vehicle' && booking.vehicle) { let imgUrl=booking.vehicle.image?.url;
                if(!imgUrl && booking.vehicle.images && booking.vehicle.images.length> 0) imgUrl =
                booking.vehicle.images[0].url;
                if(!imgUrl) imgUrl =
                "https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80";
                %>
                <div class="mb-4">
                  <img src="<%= imgUrl %>" class="img-fluid rounded mb-3"
                    alt="<%= booking.vehicle.title || booking.vehicle.brand %>"
                    style="width: 100%; height: 200px; object-fit: cover; background-color: #f1f5f9;"
                    onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80';">
                  <h4>
                    <%= booking.vehicle.title || (booking.vehicle.brand + ' ' + booking.vehicle.model) %>
                  </h4>
                  <p class="text-muted">
                    <i class="fas fa-map-marker-alt me-1"></i>
                    <%= booking.vehicle.location %>, <%= booking.vehicle.country %>
                  </p>
                </div>
                <% } else if (booking.type==='dhaba' && booking.dhaba) { let imgUrl="" ; if(booking.dhaba.images &&
                  booking.dhaba.images.length> 0) imgUrl = booking.dhaba.images[0].url;
                  else if(booking.dhaba.image && booking.dhaba.image.length > 0) imgUrl = booking.dhaba.image[0].url;

                  if(!imgUrl) imgUrl =
                  "https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=800&auto=format&fit=crop&q=80";
                  %>
                  <div class="mb-4">
                    <img src="<%= imgUrl %>" class="img-fluid rounded mb-3" alt="<%= booking.dhaba.title %>"
                      style="width: 100%; height: 200px; object-fit: cover; background-color: #f1f5f9;"
                      onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=800&auto=format&fit=crop&q=80';">
                    <h4>
                      <%= booking.dhaba.title %>
                    </h4>
                    <p class="text-muted">
                      <i class="fas fa-map-marker-alt me-1"></i>
                      <%= booking.dhaba.location %>, <%= booking.dhaba.country %>
                    </p>
                  </div>
                  <% } %>

                    <div class="payment-amount">
                      ‚Çπ<%= booking.totalPrice.toLocaleString("en-IN") %>
                    </div>
                    <p class="text-muted">Total Amount Due</p>
          </div>

          <div class="booking-details">
            <h4 class="mb-4">Booking Details</h4>

            <div class="detail-row">
              <span class="detail-label">Booking Type</span>
              <span class="detail-value">
                <% if (booking.type==='listing' ) { %>
                  <span class="badge bg-primary">üè† Stay</span>
                  <% } else if (booking.type==='vehicle' ) { %>
                    <span class="badge bg-info">üöó Rental</span>
                    <% } else { %>
                      <span class="badge bg-warning">üçΩÔ∏è Dining</span>
                      <% } %>
              </span>
            </div>

            <% if (booking.type==='dhaba' ) { %>
              <div class="detail-row">
                <span class="detail-label">Date</span>
                <span class="detail-value">
                  <%= booking.date ? booking.date.toLocaleDateString('en-IN') : 'N/A' %>
                </span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Time</span>
                <span class="detail-value">
                  <%= booking.time || 'N/A' %>
                </span>
              </div>
              <% } else { %>
                <div class="detail-row">
                  <span class="detail-label">Start Date</span>
                  <span class="detail-value">
                    <%= booking.startDate ? booking.startDate.toLocaleDateString('en-IN') : 'N/A' %>
                  </span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">End Date</span>
                  <span class="detail-value">
                    <%= booking.endDate ? booking.endDate.toLocaleDateString('en-IN') : 'N/A' %>
                  </span>
                </div>
                <% } %>

                  <div class="detail-row">
                    <span class="detail-label">Number of Guests</span>
                    <span class="detail-value">
                      <%= booking.guests %>
                    </span>
                  </div>

                  <div class="detail-row">
                    <span class="detail-label">Total Price</span>
                    <span class="detail-value">‚Çπ<%= booking.totalPrice.toLocaleString("en-IN") %></span>
                  </div>

                  <div class="detail-row">
                    <span class="detail-label">Payment Status</span>
                    <span class="detail-value">
                      <% if (booking.isPaid) { %>
                        <span class="badge bg-success">‚úì Paid</span>
                        <% } else { %>
                          <span class="badge bg-warning">‚è≥ Pending</span>
                          <% } %>
                    </span>
                  </div>
          </div>

          <div class="card-body border-top">
            <% if (!booking.isPaid) { %>
              <div class="text-center">
                <h5 class="mb-3">Payment Options</h5>
                <p class="text-muted mb-4">Choose your preferred payment method to complete the booking</p>

                <div class="row g-3">
                  <div class="col-md-12">
                    <div
                      class="wallet-option mb-3 <%= currUser.walletBalance < booking.totalPrice ? 'insufficient' : '' %>"
                      id="walletOption">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-bold"><i class="fas fa-wallet text-warning me-2"></i>WanderLust Wallet</span>
                        <span class="badge bg-light text-dark border">Balance: ‚Çπ<%= (currUser.walletBalance ||
                            0).toLocaleString() %></span>
                      </div>
                      <% if (currUser.walletBalance>= booking.totalPrice) { %>
                        <p class="small text-muted mb-3">Instant confirmation using your wallet funds.</p>
                        <button onclick="payWithWallet()" class="btn btn-warning w-100 py-3 fw-bold" id="payWalletBtn">
                          Confirm with Wallet
                        </button>
                        <% } else { %>
                          <p class="small text-danger mb-0">Insufficient balance. Need ‚Çπ<%= (booking.totalPrice -
                              currUser.walletBalance).toLocaleString() %> more.</p>
                          <a href="/trust/wallet" class="btn btn-sm btn-outline-warning mt-2 rounded-pill">Top up
                            Wallet</a>
                          <% } %>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <button class="btn btn-primary w-100 py-3" onclick="processPayment()">
                      <i class="fas fa-credit-card me-2"></i>
                      Pay with Card
                    </button>
                  </div>
                  <div class="col-md-6">
                    <button class="btn btn-outline-primary w-100 py-3" onclick="payWithUPI()">
                      <i class="fas fa-mobile-alt me-2"></i>
                      Pay with UPI
                    </button>
                  </div>
                </div>

                <div class="mt-4 p-3 bg-light rounded">
                  <h6 class="mb-2">üí≥ Secure Payment</h6>
                  <p class="small text-muted mb-0">
                    Your payment information is encrypted and secure. We accept all major credit cards and UPI payments.
                  </p>
                </div>
              </div>
              <% } else { %>
                <div class="text-center py-4">
                  <div class="mb-3">
                    <i class="fas fa-check-circle fa-4x text-success"></i>
                  </div>
                  <h4 class="text-success mb-3">Payment Successful!</h4>
                  <p class="text-muted mb-4">Your booking has been confirmed and payment has been processed
                    successfully.</p>
                  <a href="/bookings" class="btn btn-primary">
                    <i class="fas fa-arrow-left me-2"></i>Back to My Bookings
                  </a>
                </div>
                <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal and Overlay for Professional Wallet Flow -->

  <!-- 3. UPI Payment Modal -->
  <div class="modal fade" id="upiModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg" style="border-radius: 24px;">
        <div class="modal-header border-0 pb-0">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center px-4 pb-5 pt-0">
          <h4 class="fw-bold mb-3">Scan & Pay via UPI</h4>
          <p class="text-muted small mb-4">Scan the QR code below with any UPI app</p>

          <div class="bg-light p-4 rounded-4 mb-4 d-inline-block position-relative">
            <!-- Dynamic QR Code -->
            <img
              src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=upi://pay?pa=wanderlust@upi&pn=WanderLust&am=<%= booking.totalPrice %>&cu=INR"
              alt="UPI QR Code" class="img-fluid rounded-3 mb-3">
            <div class="fw-bold text-dark fs-5">‚Çπ<%= booking.totalPrice.toLocaleString("en-IN") %>
            </div>
            <p class="small text-muted mb-0">WanderLust Payments</p>
          </div>

          <div id="upiProcessing" class="d-none mb-3">
            <div class="spinner-border text-primary mb-2" role="status"></div>
            <p class="text-muted small animate-pulse">Verifying payment status...</p>
          </div>

          <button id="verifyUpiBtn" onclick="verifyUPIPayment()"
            class="btn btn-primary w-100 py-3 rounded-pill fw-bold shadow-sm">
            <i class="fas fa-check-circle me-2"></i>I have paid
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 1. Secure Wallet Confirmation Modal -->
  <div class="modal fade" id="walletConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg" style="border-radius: 24px; overflow: hidden;">
        <div class="modal-header border-0 bg-light pb-0">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center px-4 pb-5 pt-0">
          <div class="mb-3 mt-n4">
            <div
              style="width: 80px; height: 80px; background: #fff8f4; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; box-shadow: 0 10px 20px rgba(254, 107, 0, 0.1);">
              <i class="fas fa-wallet fa-2x text-warning"></i>
            </div>
          </div>

          <h4 class="fw-bold mb-1">Confirm Payment</h4>
          <p class="text-muted small mb-4">You are about to pay using your WanderLust Wallet</p>

          <div class="bg-light p-3 rounded-4 mb-4 text-start">
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted small">Total Amount</span>
              <span class="fw-bold">‚Çπ<%= booking.totalPrice.toLocaleString('en-IN') %></span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted small">Current Balance</span>
              <span class="text-dark">‚Çπ<%= (currUser.walletBalance || 0).toLocaleString('en-IN') %></span>
            </div>
            <hr class="my-2 border-secondary opacity-25">
            <div class="d-flex justify-content-between align-items-center">
              <span class="text-muted small">Balance After</span>
              <span class="fw-bold text-success">‚Çπ<%= ((currUser.walletBalance || 0) -
                  booking.totalPrice).toLocaleString('en-IN') %></span>
            </div>
          </div>

          <div class="mb-4">
            <label class="form-label small text-start w-100 fw-bold text-muted">ENTER SECURITY PIN (1234)</label>
            <div class="d-flex gap-2 justify-content-center">
              <input type="password" id="walletPin" class="form-control form-control-lg text-center fw-bold"
                maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="letter-spacing: 5px; font-size: 24px; border-radius: 12px;">
            </div>
            <div id="pinError" class="text-danger small mt-2 d-none"><i class="fas fa-exclamation-circle me-1"></i>
              Incorrect PIN</div>
          </div>

          <button onclick="processWalletConfirm()"
            class="btn btn-warning w-100 py-3 rounded-pill fw-bold shadow-sm hover-elevate">
            Pay ‚Çπ<%= booking.totalPrice.toLocaleString('en-IN') %> Securely
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 2. Professional Processing Overlay -->
  <div id="paymentOverlay"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 9999; align-items: center; justify-content: center; flex-direction: column;">
    <div class="payment-loader mb-4">
      <div class="spinner-grow text-warning" role="status" style="width: 3rem; height: 3rem; animation-duration: 0.8s;">
      </div>
      <div class="spinner-grow text-warning mx-2" role="status"
        style="width: 3rem; height: 3rem; animation-delay: 0.2s; animation-duration: 0.8s;"></div>
      <div class="spinner-grow text-warning" role="status"
        style="width: 3rem; height: 3rem; animation-delay: 0.4s; animation-duration: 0.8s;"></div>
    </div>
    <h3 class="fw-bold text-dark animate-pulse">Processing Payment...</h3>
    <p class="text-muted">Please do not close this window</p>
  </div>

  <style>
    .hover-elevate:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    .animate-pulse {
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% {
        opacity: 0.6;
      }

      50% {
        opacity: 1;
      }

      100% {
        opacity: 0.6;
      }
    }
  </style>

  <script>
    let upiModal, walletModal; // Declare globally

    document.addEventListener('DOMContentLoaded', function () {
      // Initialize Modals
      const upiEl = document.getElementById('upiModal');
      const walletEl = document.getElementById('walletConfirmModal');

      if (upiEl) upiModal = new bootstrap.Modal(upiEl);
      if (walletEl) walletModal = new bootstrap.Modal(walletEl);
    });

    // --- Updated Wallet Flow ---
    function payWithWallet() {
      // Step 1: Open Confirmation Modal
      if (walletModal) {
        walletModal.show();
        // Focus pin input
        setTimeout(() => document.getElementById('walletPin').focus(), 500);
      }
    }

    async function processWalletConfirm() {
      const pinInput = document.getElementById('walletPin');
      const errorMsg = document.getElementById('pinError');
      const overlay = document.getElementById('paymentOverlay');

      // Step 2: Validate PIN (Mock check)
      if (pinInput.value !== '1234') {
        pinInput.classList.add('is-invalid');
        errorMsg.classList.remove('d-none');
        return;
      }

      // Valid PIN
      pinInput.classList.remove('is-invalid');
      errorMsg.classList.add('d-none');
      walletModal.hide(); // Hide modal

      // Step 3: Show Premium Processing Overlay
      overlay.style.display = 'flex';

      // Artificial delay for "Processing" feel (Professionalism) - Speed up
      await new Promise(r => setTimeout(r, 800));

      // Step 4: Actual API Call
      try {
        const response = await fetch('/bookings/<%= booking._id %>/pay-wallet', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (data.success) {
          window.location.href = data.redirectUrl;
        } else {
          overlay.style.display = 'none'; // Hide overlay on error
          alert(data.message || 'Payment failed');
        }
      } catch (error) {
        console.error('Wallet Error:', error);
        overlay.style.display = 'none';
        alert('Something went wrong. Please try again.');
      }
    }

    function payWithUPI() {
      if (upiModal) {
        upiModal.show();
      } else {
        const modalEl = document.getElementById('upiModal');
        if (modalEl) {
          upiModal = new bootstrap.Modal(modalEl);
          upiModal.show();
        }
      }
    }

    async function verifyUPIPayment() {
      const btn = document.getElementById('verifyUpiBtn');
      const processing = document.getElementById('upiProcessing');

      btn.classList.add('d-none');
      processing.classList.remove('d-none');

      await new Promise(r => setTimeout(r, 2000));

      try {
        const response = await fetch('/bookings/<%= booking._id %>/pay-upi', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (data.success) {
          window.location.href = data.redirectUrl;
        } else {
          alert(data.message || 'Payment verification failed');
          btn.classList.remove('d-none');
          processing.classList.add('d-none');
        }
      } catch (error) {
        console.error('UPI Error:', error);
        alert('Something went wrong. Please try again.');
        btn.classList.remove('d-none');
        processing.classList.add('d-none');
      }
    }

    // Enhanced card payment function with better UX
    async function processPayment() {
      const btn = document.querySelector('button[onclick="processPayment()"]');
      const overlay = document.getElementById('paymentOverlay');
      const overlayTitle = overlay.querySelector('h3');
      const overlayText = overlay.querySelector('p');

      // Show loading state on button
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Preparing secure checkout...';

      // Show overlay after 500ms (if still processing)
      const overlayTimeout = setTimeout(() => {
        overlay.style.display = 'flex';
        overlayTitle.textContent = 'Preparing Your Payment...';
        overlayText.textContent = 'Please wait while we set up secure checkout';
      }, 500);

      try {
        const response = await fetch('/bookings/create-checkout-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ bookingId: '<%= booking._id %>' })
        });

        const data = await response.json();

        if (data.success && data.url) {
          // Update overlay message
          clearTimeout(overlayTimeout);
          overlay.style.display = 'flex';
          overlayTitle.textContent = 'Redirecting to Stripe Checkout...';
          overlayText.textContent = 'You will be redirected in a moment';

          // Small delay for better UX
          await new Promise(r => setTimeout(r, 800));

          // Redirect to Stripe
          window.location.href = data.url;
        } else {
          throw new Error(data.message || 'Failed to initiate payment');
        }
      } catch (error) {
        console.error('Payment error:', error);

        // Hide overlay
        clearTimeout(overlayTimeout);
        overlay.style.display = 'none';

        // Show user-friendly error
        showPaymentError(error.message || 'Payment processing failed. Please try again.');

        // Reset button
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-credit-card me-2"></i>Pay with Card';
      }
    }

    // New error display function
    function showPaymentError(message) {
      // Remove any existing error alerts
      const existingAlerts = document.querySelectorAll('.payment-error-alert');
      existingAlerts.forEach(alert => alert.remove());

      // Create new error alert
      const errorDiv = document.createElement('div');
      errorDiv.className = 'alert alert-danger alert-dismissible fade show mt-3 payment-error-alert';
      errorDiv.innerHTML = `
        <div class="d-flex align-items-center">
          <i class="fas fa-exclamation-triangle me-3 fa-2x"></i>
          <div>
            <strong>Payment Error</strong>
            <p class="mb-0 mt-1">${message}</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;

      // Insert error before payment options
      const paymentOptions = document.querySelector('.payment-card .card-body');
      if (paymentOptions) {
        paymentOptions.insertBefore(errorDiv, paymentOptions.firstChild);

        // Scroll to error
        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    // Add retry functionality
    function retryPayment() {
      const errorAlerts = document.querySelectorAll('.payment-error-alert');
      errorAlerts.forEach(alert => alert.remove());
      processPayment();
    }
  </script>