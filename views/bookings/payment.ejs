<% layout("/layouts/boilerplate") -%>

  <style>
    .payment-hero {
      background: linear-gradient(135deg, var(--primary-orange), var(--primary-orange-hover));
      color: var(--white);
      padding: 3rem 0;
      margin-bottom: 2rem;
    }

    .payment-title {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .payment-subtitle {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .payment-card {
      background: var(--white);
      border-radius: var(--radius-2xl);
      overflow: hidden;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--gray-200);
    }

    .payment-summary {
      background: var(--gray-50);
      padding: 2rem;
      border-bottom: 1px solid var(--gray-200);
    }

    .payment-amount {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-orange);
    }

    .booking-details {
      padding: 2rem;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--gray-200);
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      font-weight: 600;
      color: var(--gray-700);
    }

    .detail-value {
      color: var(--gray-900);
      font-weight: 500;
    }

    .wallet-option {
      border: 2px solid #eee;
      border-radius: var(--radius-xl);
      padding: 1.5rem;
      transition: all 0.3s;
      cursor: pointer;
      background: #fafafa;
    }

    .wallet-option:hover {
      border-color: var(--primary-orange);
      background: rgba(254, 107, 0, 0.05);
    }

    .wallet-option.insufficient {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .wallet-option.insufficient:hover {
      border-color: #eee;
      background: #fafafa;
    }

    /* --- Premium Wallet Receipt Modal --- */
    .wallet-receipt-card {
      background: white;
      border-radius: 24px;
      overflow: hidden;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      position: relative;
    }

    .wallet-receipt-header {
      background: linear-gradient(135deg, #1e293b, #0f172a);
      padding: 30px;
      text-align: center;
      color: white;
      position: relative;
    }

    .wallet-icon-large {
      font-size: 40px;
      margin-bottom: 15px;
      color: #fbbf24;
      filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.2));
    }

    .secure-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(255, 255, 255, 0.1);
      padding: 6px 16px;
      border-radius: 100px;
      font-size: 0.8rem;
      margin-top: 10px;
      backdrop-filter: blur(4px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .receipt-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px dashed #e2e8f0;
      color: #64748b;
      font-size: 0.95rem;
    }

    .receipt-row.total {
      border-top: 2px solid #f1f5f9;
      border-bottom: none;
      margin-top: 10px;
      padding-top: 20px;
      font-weight: 700;
      color: #1e293b;
      font-size: 1.1rem;
    }

    .pin-input-container {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin: 20px 0;
    }

    .pin-digit {
      width: 50px;
      height: 60px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      text-align: center;
      font-size: 24px;
      font-weight: 700;
      color: #1e293b;
      transition: all 0.2s;
      background: #f8fafc;
    }

    .pin-digit:focus {
      border-color: #fbbf24;
      /* Primary orange/yellow */
      background: white;
      outline: none;
      box-shadow: 0 0 0 4px rgba(251, 191, 36, 0.1);
      transform: translateY(-2px);
    }
  </style>

  <section class="payment-hero">
    <div class="container text-center">
      <h1 class="payment-title">Complete Your Payment</h1>
      <p class="payment-subtitle">Secure payment processing for your booking</p>
    </div>
  </section>

  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="payment-card animate-fade-in">
          <div class="payment-summary text-center">
            <h3 class="mb-3">Booking Summary</h3>
            <% if (booking.type==='listing' && booking.listing) { let imgUrl=booking.listing.image?.url; if(!imgUrl &&
              booking.listing.images && booking.listing.images.length> 0) imgUrl = booking.listing.images[0].url;
              if(!imgUrl) imgUrl =
              "https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80";
              %>
              <div class="mb-4">
                <img src="<%= imgUrl %>" class="img-fluid rounded mb-3" alt="<%= booking.listing.title %>"
                  style="width: 100%; height: 200px; object-fit: cover; background-color: #f1f5f9;"
                  onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80';">
                <h4>
                  <%= booking.listing.title %>
                </h4>
                <p class="text-muted">
                  <i class="fas fa-map-marker-alt me-1"></i>
                  <%= booking.listing.location %>, <%= booking.listing.country %>
                </p>
              </div>
              <% } else if (booking.type==='vehicle' && booking.vehicle) { let imgUrl=booking.vehicle.image?.url;
                if(!imgUrl && booking.vehicle.images && booking.vehicle.images.length> 0) imgUrl =
                booking.vehicle.images[0].url;
                if(!imgUrl) imgUrl =
                "https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80";
                %>
                <div class="mb-4">
                  <img src="<%= imgUrl %>" class="img-fluid rounded mb-3"
                    alt="<%= booking.vehicle.title || booking.vehicle.brand %>"
                    style="width: 100%; height: 200px; object-fit: cover; background-color: #f1f5f9;"
                    onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80';">
                  <h4>
                    <%= booking.vehicle.title || (booking.vehicle.brand + ' ' + booking.vehicle.model) %>
                  </h4>
                  <p class="text-muted">
                    <i class="fas fa-map-marker-alt me-1"></i>
                    <%= booking.vehicle.location %>, <%= booking.vehicle.country %>
                  </p>
                </div>
                <% } else if (booking.type==='dhaba' && booking.dhaba) { let imgUrl="" ; if(booking.dhaba.images &&
                  booking.dhaba.images.length> 0) imgUrl = booking.dhaba.images[0].url;
                  else if(booking.dhaba.image && booking.dhaba.image.length > 0) imgUrl = booking.dhaba.image[0].url;

                  if(!imgUrl) imgUrl =
                  "https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=800&auto=format&fit=crop&q=80";
                  %>
                  <div class="mb-4">
                    <img src="<%= imgUrl %>" class="img-fluid rounded mb-3" alt="<%= booking.dhaba.title %>"
                      style="width: 100%; height: 200px; object-fit: cover; background-color: #f1f5f9;"
                      onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=800&auto=format&fit=crop&q=80';">
                    <h4>
                      <%= booking.dhaba.title %>
                    </h4>
                    <p class="text-muted">
                      <i class="fas fa-map-marker-alt me-1"></i>
                      <%= booking.dhaba.location %>, <%= booking.dhaba.country %>
                    </p>
                  </div>
                  <% } %>

                    <div class="payment-amount">
                      ‚Çπ<%= booking.totalPrice.toLocaleString("en-IN") %>
                    </div>
                    <p class="text-muted">Total Amount Due</p>
          </div>

          <div class="booking-details">
            <h4 class="mb-4">Booking Details</h4>

            <div class="detail-row">
              <span class="detail-label">Booking Type</span>
              <span class="detail-value">
                <% if (booking.type==='listing' ) { %>
                  <span class="badge bg-primary">üè† Stay</span>
                  <% } else if (booking.type==='vehicle' ) { %>
                    <span class="badge bg-info">üöó Rental</span>
                    <% } else { %>
                      <span class="badge bg-warning">üçΩÔ∏è Dining</span>
                      <% } %>
              </span>
            </div>

            <% if (booking.type==='dhaba' ) { %>
              <div class="detail-row">
                <span class="detail-label">Date</span>
                <span class="detail-value">
                  <%= booking.date ? booking.date.toLocaleDateString('en-IN') : 'N/A' %>
                </span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Time</span>
                <span class="detail-value">
                  <%= booking.time || 'N/A' %>
                </span>
              </div>
              <% } else { %>
                <div class="detail-row">
                  <span class="detail-label">Start Date</span>
                  <span class="detail-value">
                    <%= booking.startDate ? booking.startDate.toLocaleDateString('en-IN') : 'N/A' %>
                  </span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">End Date</span>
                  <span class="detail-value">
                    <%= booking.endDate ? booking.endDate.toLocaleDateString('en-IN') : 'N/A' %>
                  </span>
                </div>
                <% } %>

                  <div class="detail-row">
                    <span class="detail-label">Number of Guests</span>
                    <span class="detail-value">
                      <%= booking.guests %>
                    </span>
                  </div>

                  <div class="detail-row">
                    <span class="detail-label">Total Price</span>
                    <span class="detail-value">‚Çπ<%= booking.totalPrice.toLocaleString("en-IN") %></span>
                  </div>

                  <div class="detail-row">
                    <span class="detail-label">Payment Status</span>
                    <span class="detail-value">
                      <% if (booking.isPaid) { %>
                        <span class="badge bg-success">‚úì Paid</span>
                        <% } else { %>
                          <span class="badge bg-warning">‚è≥ Pending</span>
                          <% } %>
                    </span>
                  </div>
          </div>

          <div class="card-body border-top">
            <% if (!booking.isPaid) { %>
              <div class="text-center">
                <h5 class="mb-3">Payment Options</h5>
                <p class="text-muted mb-4">Choose your preferred payment method to complete the booking</p>

                <div class="row g-3">
                  <div class="col-md-12">
                    <div
                      class="wallet-option mb-3 <%= currUser.walletBalance < booking.totalPrice ? 'insufficient' : '' %>"
                      id="walletOption">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-bold"><i class="fas fa-wallet text-warning me-2"></i>WanderLust Wallet</span>
                        <span class="badge bg-light text-dark border">Balance: ‚Çπ<%= (currUser.walletBalance ||
                            0).toLocaleString() %></span>
                      </div>
                      <% if (currUser.walletBalance>= booking.totalPrice) { %>
                        <p class="small text-muted mb-3">Instant confirmation using your wallet funds.</p>
                        <button onclick="payWithWallet()" class="btn btn-warning w-100 py-3 fw-bold" id="payWalletBtn">
                          Confirm with Wallet
                        </button>
                        <% } else { %>
                          <p class="small text-danger mb-0">Insufficient balance. Need ‚Çπ<%= (booking.totalPrice -
                              currUser.walletBalance).toLocaleString() %> more.</p>
                          <a href="/trust/wallet" class="btn btn-sm btn-outline-warning mt-2 rounded-pill">Top up
                            Wallet</a>
                          <% } %>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <button class="btn btn-primary w-100 py-3" onclick="processPayment()">
                      <i class="fas fa-credit-card me-2"></i>
                      Pay with Card
                    </button>
                  </div>
                  <div class="col-md-6">
                    <button class="btn btn-outline-primary w-100 py-3" onclick="payWithUPI()">
                      <i class="fas fa-mobile-alt me-2"></i>
                      Pay with UPI
                    </button>
                  </div>
                </div>

                <div class="mt-4 p-3 bg-light rounded">
                  <h6 class="mb-2">üí≥ Secure Payment</h6>
                  <p class="small text-muted mb-0">
                    Your payment information is encrypted and secure. We accept all major credit cards and UPI payments.
                  </p>
                </div>
              </div>
              <% } else { %>
                <div class="text-center py-4">
                  <div class="mb-3">
                    <i class="fas fa-check-circle fa-4x text-success"></i>
                  </div>
                  <h4 class="text-success mb-3">Payment Successful!</h4>
                  <p class="text-muted mb-4">Your booking has been confirmed and payment has been processed
                    successfully.</p>
                  <a href="/bookings" class="btn btn-primary">
                    <i class="fas fa-arrow-left me-2"></i>Back to My Bookings
                  </a>
                </div>
                <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal and Overlay for Professional Wallet Flow -->

  <!-- 3. Perfect UPI Payment Modal -->
  <link rel="stylesheet" href="/css/perfect-upi.css">

  <div class="modal fade perfect-upi-modal" id="upiModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">

        <!-- Processing Overlay -->
        <div class="upi-processing-overlay" id="upiOverlay">
          <div class="phone-animation" id="phoneAnim"></div>
          <div class="success-check" id="successCheck">
            <i class="fas fa-check"></i>
          </div>
          <h4 class="mt-4 fw-bold" id="upiStatusText">Verifying...</h4>
          <p class="text-muted small">Please do not press back or close</p>
        </div>

        <div class="modal-header">
          <h5 class="modal-title visually-hidden">Pay via UPI</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="upi-header">
            <h4>Scan & Pay</h4>
            <p>Use any UPI app to make the payment</p>
          </div>

          <div class="qr-container">
            <img
              src="https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=upi://pay?pa=wanderlust@upi&pn=WanderLust&am=<%= booking.totalPrice %>&cu=INR"
              alt="UPI QR Code" class="qr-code-img">
            <div class="payment-amount-display">‚Çπ<%= booking.totalPrice.toLocaleString("en-IN") %>
            </div>
            <div class="merchant-name">
              <i class="fas fa-store-alt"></i> WanderLust Payments
            </div>

            <!-- Timer Badge -->
            <div class="position-absolute top-0 end-0 m-3 badge bg-light text-dark border">
              ‚è±Ô∏è <span id="upiTimer">05:00</span>
            </div>
          </div>

          <div class="text-center mb-3">
            <span class="text-muted small fw-bold">OR PAY WITH APP</span>
          </div>

          <!-- Quick Intent Links (Mobile Optimized) -->
          <div class="upi-apps-grid">
            <a href="tez://upi/pay?pa=wanderlust@upi&pn=WanderLust&am=<%= booking.totalPrice %>&cu=INR"
              class="upi-app-btn">
              <i class="fab fa-google-pay upi-app-icon" style="color: #4285F4;"></i> Google Pay
            </a>
            <a href="phonepe://pay?pa=wanderlust@upi&pn=WanderLust&am=<%= booking.totalPrice %>&cu=INR"
              class="upi-app-btn">
              <span class="upi-app-icon fw-bold" style="color: #6739b7;">Pe</span> PhonePe
            </a>
            <a href="paytmmp://pay?pa=wanderlust@upi&pn=WanderLust&am=<%= booking.totalPrice %>&cu=INR"
              class="upi-app-btn">
              <span class="upi-app-icon fw-bold" style="color: #00baf2;">Pay</span> Paytm
            </a>
            <a href="upi://pay?pa=wanderlust@upi&pn=WanderLust&am=<%= booking.totalPrice %>&cu=INR" class="upi-app-btn">
              <i class="fas fa-mobile-alt upi-app-icon"></i> Other UPI
            </a>
          </div>

          <!-- UPI ID Copy -->
          <div class="upi-id-container">
            <span class="upi-id-label">UPI ID:</span>
            <span class="upi-id-value">wanderlust@upi</span>
            <button class="copy-btn" onclick="copyUpiId()" title="Copy UPI ID">
              <i class="far fa-copy"></i>
            </button>
          </div>

          <!-- UTR Input -->
          <div class="mb-4">
            <label for="utrInput" class="form-label small fw-bold text-muted">ENTER PAYMENT REFERENCE (UTR)</label>
            <input type="text" class="form-control form-control-lg text-center fw-bold bg-light border-0" id="utrInput"
              placeholder="e.g. 321456789012" maxlength="12" style="letter-spacing: 2px;">
            <div id="utrError" class="text-danger small mt-2 d-none">
              <i class="fas fa-exclamation-circle me-1"></i> Please enter a valid reference number
            </div>
          </div>

          <!-- Confirmation -->
          <button id="verifyUpiBtn" onclick="verifyUPIPayment()"
            class="btn btn-dark w-100 py-3 rounded-pill fw-bold shadow-sm" style="background: #2b2b2b;">
            <i class="fas fa-check-circle me-2"></i>I have completed the payment
          </button>

          <div class="payment-timer">
            <div class="timer-dots">
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
            </div>
            Waiting for payment verification
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function copyUpiId() {
      navigator.clipboard.writeText("wanderlust@upi");
      const btn = document.querySelector('.copy-btn');
      const originalIcon = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-check text-success"></i>';
      setTimeout(() => btn.innerHTML = originalIcon, 2000);
    }

    // Timer Logic
    let timeLeft = 300; // 5 minutes
    function startUpiTimer() {
      const timerEl = document.getElementById('upiTimer');
      if (!timerEl) return;

      const interval = setInterval(() => {
        if (timeLeft <= 0) {
          clearInterval(interval);
          timerEl.textContent = "Expired";
        } else {
          timeLeft--;
          const m = Math.floor(timeLeft / 60);
          const s = timeLeft % 60;
          timerEl.textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }
      }, 1000);
    }

    // Hook into modal show
    document.addEventListener('DOMContentLoaded', () => {
      const modalEl = document.getElementById('upiModal');
      modalEl.addEventListener('show.bs.modal', function () {
        timeLeft = 300;
        startUpiTimer();
      });
    });
  </script>

  <!-- 2. Secure Wallet Confirmation Modal (Receipt Style) -->
  <div class="modal fade" id="walletConfirmModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 bg-transparent">
        <div class="wallet-receipt-card">
          <div class="position-absolute top-0 end-0 p-3" style="z-index: 10;">
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="wallet-receipt-header">
            <div class="wallet-icon-large">
              <i class="fas fa-wallet"></i>
            </div>
            <h4 class="fw-bold mb-1">Payment Receipt</h4>
            <div class="secure-badge">
              <i class="fas fa-lock"></i> 128-bit Secured
            </div>
          </div>

          <div class="modal-body px-4 pb-4 pt-3">
            <div class="text-center mb-4">
              <p class="text-muted small mb-0">Paying to</p>
              <h6 class="fw-bold text-dark">WanderLust Bookings</h6>
            </div>

            <!-- Receipt Details -->
            <div class="mb-4">
              <div class="receipt-row">
                <span>Wallet Balance</span>
                <span class="text-success fw-bold">‚Çπ<%= (currUser.walletBalance || 0).toLocaleString('en-IN') %></span>
              </div>
              <div class="receipt-row">
                <span>Booking Amount</span>
                <span class="text-danger fw-bold">- ‚Çπ<%= booking.totalPrice.toLocaleString('en-IN') %></span>
              </div>
              <div class="receipt-row total">
                <span>Remaining Balance</span>
                <span>‚Çπ<%= ((currUser.walletBalance || 0) - booking.totalPrice).toLocaleString('en-IN') %></span>
              </div>
            </div>

            <!-- PIN Input -->
            <div class="text-center">
              <label class="small fw-bold text-muted mb-2">ENTER 4-DIGIT PIN</label>
              <div class="pin-input-container">
                <input type="password" class="pin-digit" maxlength="1" data-index="1">
                <input type="password" class="pin-digit" maxlength="1" data-index="2">
                <input type="password" class="pin-digit" maxlength="1" data-index="3">
                <input type="password" class="pin-digit" maxlength="1" data-index="4">
              </div>
              <div id="pinError" class="text-danger small mb-3 d-none">
                <i class="fas fa-exclamation-circle me-1"></i> Incorrect PIN
              </div>
            </div>

            <button onclick="processWalletConfirm()" id="payWalletConfirmBtn"
              class="btn btn-warning w-100 py-3 rounded-pill fw-bold shadow-sm mb-3">
              <i class="fas fa-fingerprint me-2"></i> Confirm Payment
            </button>

            <div class="text-center">
              <a href="#" class="text-muted small text-decoration-none">Forgot PIN?</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 3. Professional Processing Overlay (Global) -->
  <div id="paymentOverlay"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 9999; align-items: center; justify-content: center; flex-direction: column;">
    <!-- Different states can be managed nicely here -->
    <div id="paymentLoadingState" class="text-center">
      <div class="payment-loader mb-4">
        <div class="spinner-grow text-warning" role="status"
          style="width: 3rem; height: 3rem; animation-duration: 0.8s;"></div>
        <div class="spinner-grow text-warning mx-2" role="status"
          style="width: 3rem; height: 3rem; animation-delay: 0.2s; animation-duration: 0.8s;"></div>
        <div class="spinner-grow text-warning" role="status"
          style="width: 3rem; height: 3rem; animation-delay: 0.4s; animation-duration: 0.8s;"></div>
      </div>
      <h3 class="fw-bold text-dark animate-pulse">Processing...</h3>
      <p class="text-muted">Securely contacting server</p>
    </div>

    <div id="paymentSuccessState" class="text-center" style="display: none;">
      <div class="mb-4">
        <i class="fas fa-check-circle text-success" style="font-size: 5rem;"></i>
      </div>
      <h3 class="fw-bold text-success">Payment Successful!</h3>
      <p class="text-muted">Redirecting you to your booking...</p>
    </div>
  </div>

  <style>
    .hover-elevate:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    .animate-pulse {
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% {
        opacity: 0.6;
      }

      50% {
        opacity: 1;
      }

      100% {
        opacity: 0.6;
      }
    }
  </style>

  <script>
    let upiModal, walletModal;

    document.addEventListener('DOMContentLoaded', function () {
      const upiEl = document.getElementById('upiModal');
      const walletEl = document.getElementById('walletConfirmModal');

      if (upiEl) upiModal = new bootstrap.Modal(upiEl);
      if (walletEl) {
        walletModal = new bootstrap.Modal(walletEl);

        // PIN Input Logic
        const pins = walletEl.querySelectorAll('.pin-digit');
        pins.forEach((pin, idx) => {
          pin.addEventListener('input', (e) => {
            if (e.target.value.length === 1) {
              if (idx < pins.length - 1) pins[idx + 1].focus();
            }
          });

          pin.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && !e.target.value && idx > 0) {
              pins[idx - 1].focus();
            }
          });
        });

        walletEl.addEventListener('shown.bs.modal', () => {
          // Clear pins
          pins.forEach(p => p.value = '');
          document.getElementById('pinError').classList.add('d-none');
          pins[0].focus();
        });
      }
    });

    function payWithWallet() {
      if (walletModal) walletModal.show();
    }

    async function processWalletConfirm() {
      const pins = document.querySelectorAll('.pin-digit');
      let pinValue = '';
      pins.forEach(p => pinValue += p.value);

      const errorMsg = document.getElementById('pinError');
      const overlay = document.getElementById('paymentOverlay');
      const loadingState = document.getElementById('paymentLoadingState');
      const successState = document.getElementById('paymentSuccessState');

      // 1. PIN Validation (Mock: 1234)
      if (pinValue !== '1234') {
        errorMsg.classList.remove('d-none');
        pins.forEach(p => {
          p.classList.add('border-danger');
          p.value = '';
        });
        pins[0].focus();
        setTimeout(() => pins.forEach(p => p.classList.remove('border-danger')), 1000);
        return;
      }

      // Valid PIN
      walletModal.hide();

      // 2. Show Overlay
      overlay.style.display = 'flex';
      loadingState.style.display = 'block';
      successState.style.display = 'none';

      // 3. API Call
      try {
        await new Promise(r => setTimeout(r, 1000)); // UX Delay

        const response = await fetch('/bookings/<%= booking._id %>/pay-wallet', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (data.success) {
          // 4. Success Animation
          loadingState.style.display = 'none';
          successState.style.display = 'block';

          await new Promise(r => setTimeout(r, 1500)); // Let them see success
          window.location.href = data.redirectUrl;
        } else {
          overlay.style.display = 'none';
          alert(data.message || 'Payment failed');
        }
      } catch (error) {
        console.error('Wallet Error:', error);
        overlay.style.display = 'none';
        alert('Something went wrong. Please try again.');
      }
    }

    // ... UPI Functions (Kept as is or referenced if separate) ...
    function payWithUPI() {
      if (upiModal) upiModal.show();
    }

    // ... Verify UPI Function (Kept as is) ...
    async function verifyUPIPayment() {
      // (Existing Logic from previous steps)
      const utrInput = document.getElementById('utrInput');
      const utrError = document.getElementById('utrError');
      const overlay = document.getElementById('upiOverlay');
      const statusText = document.getElementById('upiStatusText');
      const phoneAnim = document.getElementById('phoneAnim');
      const successCheck = document.getElementById('successCheck');

      if (!utrInput) return; // safety

      const utrValue = utrInput.value.trim();
      if (utrValue.length < 4) {
        utrError.classList.remove('d-none');
        utrInput.focus();
        return;
      }
      utrError.classList.add('d-none');

      overlay.classList.add('active');
      statusText.textContent = "Verifying Transaction...";

      await new Promise(r => setTimeout(r, 2000));

      try {
        const response = await fetch('/bookings/<%= booking._id %>/pay-upi', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ paymentReference: utrValue })
        });

        const data = await response.json();

        if (data.success) {
          phoneAnim.style.display = 'none';
          successCheck.classList.add('show');
          statusText.textContent = "Payment Verified!";

          await new Promise(r => setTimeout(r, 1000));
          window.location.href = data.redirectUrl;
        } else {
          overlay.classList.remove('active');
          alert(data.message || 'Payment verification failed');
        }
      } catch (error) {
        console.error('UPI Error:', error);
        overlay.classList.remove('active');
        alert('Something went wrong. Please try again.');
      }
    }

    // Card Payment (Keep existing simple for now or refactor similarly)
    async function processPayment() {
      // ... (Existing Process Payment Logic) ...
      const btn = document.querySelector('button[onclick="processPayment()"]');
      // ... existing code ...
      // Re-implement basic fetch for Stripe here or ensure it's preserved if not replaced.
      // For brevity in this replacement block, I'll ensure the key existing logic is preserved.

      const overlay = document.getElementById('paymentOverlay');
      const loadingState = document.getElementById('paymentLoadingState');

      if (btn) btn.disabled = true;

      overlay.style.display = 'flex';
      loadingState.querySelector('h3').textContent = "Redirecting to Stripe...";

      try {
        const response = await fetch('/bookings/create-checkout-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ bookingId: '<%= booking._id %>' })
        });
        const data = await response.json();
        if (data.success && data.url) {
          window.location.href = data.url;
        } else {
          throw new Error(data.message);
        }
      } catch (e) {
        overlay.style.display = 'none';
        if (btn) btn.disabled = false;
        alert("Payment Error: " + e.message);
      }
    }
  </script>