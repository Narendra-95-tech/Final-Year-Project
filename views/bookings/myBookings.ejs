<% layout("/layouts/boilerplate") -%>

  <style>
    /* Premium Bookings Dashboard */
    .bookings-header {
      background: linear-gradient(135deg, #198754 0%, #20c997 100%);
      padding: 60px 0 80px;
      color: white;
      margin-bottom: -40px;
      border-radius: 0 0 30px 30px;
      text-align: center;
    }

    .bookings-title {
      font-weight: 800;
      font-size: 32px;
      margin-bottom: 10px;
      letter-spacing: -0.5px;
    }

    .bookings-subtitle {
      opacity: 0.9;
      font-size: 16px;
      max-width: 600px;
      margin: 0 auto;
    }

    .bookings-container {
      max-width: 1000px;
      margin: 0 auto 60px;
      padding: 0 20px;
    }

    /* Booking Card */
    .booking-card {
      background: white;
      border-radius: 20px;
      border: 1px solid #f0f0f0;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
      margin-bottom: 25px;
      overflow: hidden;
      transition: transform 0.3s, box-shadow 0.3s;
      position: relative;
    }

    .booking-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.08);
    }

    .booking-card-header {
      padding: 20px 25px;
      background: #fcfcfc;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .booking-type-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 30px;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .type-listing {
      background: #e0f2fe;
      color: #0284c7;
    }

    .type-vehicle {
      background: #fef3c7;
      color: #d97706;
    }

    .type-dhaba {
      background: #fee2e2;
      color: #dc2626;
    }

    .booking-id {
      color: #888;
      font-size: 13px;
      font-family: monospace;
    }

    .booking-card-body {
      padding: 25px;
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
    }

    .booking-info {
      flex: 1;
      min-width: 280px;
    }

    .booking-title {
      font-size: 20px;
      font-weight: 700;
      color: #1a1a1a;
      margin-bottom: 15px;
    }

    .info-group {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
    }

    .info-item {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #555;
      font-size: 14px;
    }

    .info-item i {
      width: 25px;
      height: 25px;
      background: #f8f9fa;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #198754;
      font-size: 12px;
    }

    .booking-price {
      font-size: 24px;
      font-weight: 800;
      color: #1a1a1a;
      margin-top: 10px;
    }

    .booking-price small {
      font-size: 14px;
      font-weight: 500;
      color: #888;
    }

    /* Actions Area */
    .booking-actions {
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 12px;
      min-width: 150px;
      border-left: 1px solid #f0f0f0;
      padding-left: 30px;
    }

    @media (max-width: 768px) {
      .booking-actions {
        border-left: none;
        padding-left: 0;
        width: 100%;
        flex-direction: row;
      }
    }

    .status-badge {
      text-align: center;
      padding: 8px 16px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 10px;
    }

    .status-paid {
      background: #d1fae5;
      color: #059669;
    }

    .status-pending {
      background: #ffedd5;
      color: #ea580c;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.05);
    }

    /* Chat Integration */
    .booking-chat-toggle {
      background: #f0fdf4;
      color: #198754;
      border: none;
      padding: 10px 20px;
      border-radius: 12px;
      font-weight: 600;
      width: 100%;
      transition: all 0.2s;
    }

    .booking-chat-toggle:hover {
      background: #dcfce7;
      transform: translateY(-2px);
    }
  </style>

  <div class="bookings-header">
    <h1 class="bookings-title">My Bookings</h1>
    <p class="bookings-subtitle">Manage your upcoming trips, rentals, and reservations.</p>
  </div>

  <div class="bookings-container">

    <% if(bookings.length===0) { %>
      <div class="empty-state">
        <img src="https://cdni.iconscout.com/illustration/premium/thumb/empty-cart-2130356-1800917.png"
          alt="No Bookings" style="height: 200px; opacity: 0.8; margin-bottom: 20px;">
        <h3>No bookings found</h3>
        <p class="text-muted mb-4">You haven't made any reservations yet. Start exploring now!</p>
        <a href="/listings" class="btn btn-success rounded-pill px-4 py-2 fw-bold">Explore Listings</a>
      </div>
      <% } else { %>
        <% bookings.forEach(booking=> { %>
          <div class="booking-card">
            <!-- Card Header -->
            <div class="booking-card-header">
              <div class="booking-type-badge type-<%= booking.type %>">
                <% if(booking.type==='listing' ) { %> <i class="fas fa-home"></i> Stay
                  <% } else if(booking.type==='vehicle' ) { %> <i class="fas fa-car"></i> Rental
                    <% } else { %> <i class="fas fa-utensils"></i> Dining <% } %>
              </div>
              <span class="booking-id">ID: <%= booking._id.toString().slice(-6).toUpperCase() %></span>
            </div>

            <!-- Card Body -->
            <div class="booking-card-body">
              <!-- Left Info -->
              <div class="booking-info">
                <h3 class="booking-title">
                  <%= booking.listing ? booking.listing.title : booking.dhaba ? booking.dhaba.title : booking.vehicle ?
                    booking.vehicle.title : 'Details Unavailable' %>
                </h3>

                <div class="info-group">
                  <% if (booking.type==='listing' ) { %>
                    <div class="info-item" title="Check-in">
                      <i class="fas fa-calendar-alt"></i>
                      <span>
                        <%= new Date(booking.startDate).toLocaleDateString('en-US', { month: 'short' , day: 'numeric' })
                          %>
                      </span>
                    </div>
                    <div class="info-item">
                      <i class="fas fa-arrow-right" style="width: auto; background: none; color: #ccc;"></i>
                    </div>
                    <div class="info-item" title="Check-out">
                      <i class="fas fa-calendar-check"></i>
                      <span>
                        <%= new Date(booking.endDate).toLocaleDateString('en-US', { month: 'short' , day: 'numeric' })
                          %>
                      </span>
                    </div>
                    <% } else if (booking.type==='vehicle' ) { %>
                      <div class="info-item">
                        <i class="fas fa-clock"></i>
                        <span>
                          <%= new Date(booking.startDate).toLocaleDateString() %> - <%= new
                              Date(booking.endDate).toLocaleDateString() %>
                        </span>
                      </div>
                      <% } else { %>
                        <div class="info-item">
                          <i class="fas fa-clock"></i>
                          <span>
                            <%= new Date(booking.startDate).toLocaleDateString() %> at <%= booking.time %>
                          </span>
                        </div>
                        <% } %>

                          <div class="info-item ms-3">
                            <i class="fas fa-user-friends"></i>
                            <span>
                              <%= booking.guests %> Guest(s)
                            </span>
                          </div>
                </div>

                <% if(booking.pickupLocation) { %>
                  <div class="info-item mb-2">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>Pickup: <%= booking.pickupLocation %></span>
                  </div>
                  <% } %>

                    <div class="booking-price">
                      â‚¹<%= booking.totalPrice.toLocaleString('en-IN') %>
                        <small>Total</small>
                    </div>
              </div>

              <!-- Right Actions -->
              <div class="booking-actions">
                <div class="status-badge <%= booking.isPaid ? 'status-paid' : 'status-pending' %>">
                  <%= booking.isPaid ? 'Confirmed' : 'Payment Pending' %>
                </div>

                <% if(!booking.isPaid) { %>
                  <form method="POST" action="/bookings/<%= booking._id %>/pay" style="width: 100%;">
                    <button class="btn btn-success w-100 rounded-3 fw-bold">Pay Now</button>
                  </form>
                  <% } else { %>
                    <button class="booking-chat-toggle" onclick="toggleChat('<%= booking._id %>')">
                      <i class="fas fa-comments me-2"></i> Chat
                    </button>
                    <% } %>

                      <% if(new Date(booking.startDate)> new Date()) { %>
                        <form method="POST" action="/bookings/<%= booking._id %>/cancel" style="width: 100%;">
                          <button class="btn btn-outline-danger w-100 rounded-3 btn-sm">Cancel</button>
                        </form>
                        <% } %>
              </div>
            </div>

            <!-- Embedded Chat (Hidden by Default) -->
            <div class="booking-chat-container p-3 bg-light border-top d-none" id="chat-container-<%= booking._id %>">
              <h6>Chat with Host</h6>
              <!-- Chat implementation to be connected -->
              <div class="text-muted small">Chat feature loading...</div>
            </div>

          </div>
          <% }); %>
            <% } %>
  </div>

  <script>
    function toggleChat(id) {
      const chatBox = document.getElementById(`chat-container-${id}`);
      chatBox.classList.toggle('d-none');
    }
  </script>

  <!-- Keep existing chatbot script if needed -->
  <script src="/chatbot.js"></script>