<% layout("/layouts/boilerplate") -%>

  <style>
    :root {
      --primary-orange: #fe6b00;
      --primary-dark: #1a1a1a;
      --bg-light: #fdfdfd;
      --status-confirmed: #10b981;
      --status-pending: #f59e0b;
      --status-cancelled: #ef4444;
    }

    .bookings-page {
      background-color: #fdfdfd;
      min-height: 100vh;
      padding-bottom: 60px;
    }

    /* Premium Header */
    .bookings-hero {
      background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
      padding: 80px 0 100px;
      color: white;
      text-align: center;
      position: relative;
      overflow: hidden;
      margin-bottom: -60px;
      border-radius: 0 0 50px 50px;
    }

    .hero-pattern {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: radial-gradient(circle at 2px 2px, rgba(255, 255, 255, 0.05) 1px, transparent 0);
      background-size: 30px 30px;
    }

    .hero-content {
      position: relative;
      z-index: 2;
    }

    .hero-content h1 {
      font-weight: 800;
      font-size: 3.5rem;
      margin-bottom: 15px;
      letter-spacing: -1px;
    }

    .hero-content p {
      font-size: 1.1rem;
      opacity: 0.8;
      max-width: 600px;
      margin: 0 auto;
    }

    /* Stats Summary Bar */
    .bookings-stats {
      max-width: 1100px;
      margin: 0 auto 40px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      padding: 0 20px;
      position: relative;
      z-index: 3;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
      border: 1px solid rgba(0, 0, 0, 0.02);
    }

    .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    /* Booking Cards Grid */
    .bookings-grid {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 24px 60px;
      display: flex;
      flex-direction: column;
      flex-wrap: nowrap;
      align-items: stretch;
      gap: 32px;
      width: 100%;
      min-height: auto;
      height: auto;
      overflow: visible;
    }

    @media (max-width: 1280px) {
      .bookings-grid {
        max-width: 1000px;
        padding: 0 20px 50px;
        gap: 28px;
      }
    }

    @media (max-width: 1024px) {
      .bookings-grid {
        max-width: 95%;
        padding: 0 16px 40px;
        gap: 24px;
      }
    }

    .premium-booking-card {
      background: white;
      border-radius: 24px;
      overflow: hidden;
      display: flex;
      flex-direction: row;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.04);
      border: 1px solid #f0f0f0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      width: 100%;
      max-width: 100%;
      min-width: 0;
      margin: 0 0 32px 0;
      clear: both;
      z-index: 1;
      cursor: pointer;
    }

    .premium-booking-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.08);
      border-color: rgba(254, 107, 0, 0.2);
      z-index: 10;
    }

    .booking-image-wrapper {
      width: 350px;
      height: 260px;
      position: relative;
      overflow: hidden;
      flex-shrink: 0;
      background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
    }

    @media (max-width: 768px) {
      .premium-booking-card {
        flex-direction: column;
      }

      .booking-image-wrapper {
        width: 100%;
        height: 220px;
      }
    }

    .booking-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
      transition: transform 0.5s;
      display: block;
    }

    .premium-booking-card:hover .booking-img {
      transform: scale(1.05);
    }

    .booking-type-tag {
      position: absolute;
      top: 16px;
      left: 16px;
      background: linear-gradient(135deg, rgba(254, 107, 0, 0.95) 0%, rgba(255, 142, 83, 0.95) 100%);
      backdrop-filter: blur(12px);
      color: white;
      padding: 8px 18px;
      border-radius: 100px;
      font-size: 11px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      z-index: 2;
      box-shadow: 0 4px 12px rgba(254, 107, 0, 0.3);
      border: 2px solid rgba(255, 255, 255, 0.8);
    }

    .booking-details {
      flex: 1;
      padding: 30px;
      display: flex;
      flex-direction: column;
    }

    .booking-header-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
    }

    .booking-title-main {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--primary-dark);
      margin: 0;
      letter-spacing: -0.5px;
      text-decoration: none;
      transition: color 0.2s;
    }

    .booking-title-main:hover {
      color: var(--primary-orange);
    }

    .booking-id-tag {
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 13px;
      font-weight: 700;
      color: #666;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 6px 14px;
      border-radius: 8px;
      border: 1px solid #dee2e6;
      letter-spacing: 0.5px;
    }

    .booking-info-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 25px;
    }

    .info-item-box {
      display: flex;
      align-items: center;
      gap: 12px;
      color: #555;
    }

    .info-icon-circle {
      width: 36px;
      height: 36px;
      background: #fff8f4;
      color: var(--primary-orange);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    .info-labels {
      display: flex;
      flex-direction: column;
    }

    .info-label {
      font-size: 11px;
      text-transform: uppercase;
      font-weight: 700;
      color: #aaa;
      letter-spacing: 0.5px;
    }

    .info-value {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }

    .booking-footer {
      margin-top: auto;
      padding-top: 20px;
      border-top: 1px solid #f5f5f5;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .price-display {
      display: flex;
      flex-direction: column;
    }

    .price-amount {
      font-size: 1.6rem;
      font-weight: 800;
      color: var(--primary-dark);
    }

    .price-currency {
      font-size: 13px;
      color: #888;
      font-weight: 500;
    }

    .status-capsule {
      padding: 8px 20px;
      border-radius: 100px;
      font-size: 13px;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .capsule-confirmed {
      background: #ecfdf5;
      color: #059669;
    }

    .capsule-pending {
      background: #fffbeb;
      color: #d97706;
    }

    .capsule-cancelled {
      background: #fef2f2;
      color: #dc2626;
    }

    .action-group {
      display: flex;
      gap: 12px;
    }

    .btn-premium-action {
      padding: 12px 26px;
      border-radius: 14px;
      font-weight: 700;
      font-size: 15px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      border: none;
      cursor: pointer;
      white-space: nowrap;
    }

    .btn-pay {
      background: linear-gradient(135deg, #fe6b00 0%, #ff8e53 100%);
      color: white;
      box-shadow: 0 8px 24px rgba(254, 107, 0, 0.25);
      font-size: 16px;
      padding: 13px 30px;
    }

    .btn-pay:hover {
      background: linear-gradient(135deg, #e66000 0%, #ff7a3d 100%);
      transform: translateY(-3px);
      box-shadow: 0 14px 32px rgba(254, 107, 0, 0.35);
      color: white;
    }

    .btn-outline {
      background: white;
      color: #555;
      border: 2px solid #e0e0e0;
      padding: 11px 24px;
    }

    .btn-outline:hover {
      background: #f8f9fa;
      border-color: #bbb;
      color: #222;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .empty-bookings-stage {
      text-align: center;
      padding: 100px 20px;
      background: white;
      border-radius: 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.05);
    }

    /* Pulse for pending */
    @keyframes pulse-orange {
      0% {
        box-shadow: 0 0 0 0 rgba(254, 107, 0, 0.4);
      }

      70% {
        box-shadow: 0 0 0 10px rgba(254, 107, 0, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(254, 107, 0, 0);
      }
    }

    .pulse-pay {
      animation: pulse-orange 2s infinite;
    }

    /* Multi-select Styles */
    .bulk-actions-bar {
      position: sticky;
      top: 80px;
      z-index: 100;
      background: white;
      padding: 15px 30px;
      margin: -20px auto 30px;
      max-width: 1200px;
      width: calc(100% - 48px);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      display: none;
      /* Hidden by default */
      align-items: center;
      justify-content: space-between;
      border: 1px solid #f0f0f0;
      transition: all 0.3s ease;
    }

    .bulk-actions-bar.active {
      display: flex;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .selection-info {
      font-weight: 700;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .booking-checkbox-wrapper {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 15;
      pointer-events: auto;
    }

    .custom-checkbox {
      width: 24px;
      height: 24px;
      border: 2px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      background: white;
    }

    .custom-checkbox i {
      color: white;
      font-size: 12px;
      display: none;
    }

    .booking-checkbox input:checked+.custom-checkbox {
      background: var(--primary-orange);
      border-color: var(--primary-orange);
    }

    .booking-checkbox input:checked+.custom-checkbox i {
      display: block;
    }

    .booking-checkbox input {
      display: none;
    }

    .premium-booking-card.selected {
      border-color: var(--primary-orange);
      background: #fff9f5;
    }

    .btn-bulk-delete {
      background: #fef2f2;
      color: #dc2626;
      border: 1px solid #fee2e2;
      padding: 10px 20px;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-bulk-delete:hover {
      background: #fee2e2;
      transform: translateY(-2px);
    }
  </style>

  <div class="bookings-page">
    <header class="bookings-hero">
      <div class="hero-pattern"></div>
      <div class="hero-content">
        <h1>My Bookings</h1>
        <p>Your ultimate travel history and upcoming adventures in one professional place.</p>
      </div>
    </header>

    <div class="bookings-stats">
      <div class="stat-card">
        <div class="stat-icon" style="background: #e0f2fe; color: #0284c7;">
          <i class="fas fa-suitcase-rolling"></i>
        </div>
        <div>
          <div style="font-size: 13px; color: #888; font-weight: 600;">Active Trips</div>
          <div style="font-size: 24px; font-weight: 800;">
            <%= bookings.filter(b=> b.status === 'Confirmed' && new Date(b.startDate) >= new Date()).length %>
          </div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background: #fef3c7; color: #d97706;">
          <i class="fas fa-history"></i>
        </div>
        <div>
          <div style="font-size: 13px; color: #888; font-weight: 600;">Total Bookings</div>
          <div style="font-size: 24px; font-weight: 800;">
            <%= bookings.length %>
          </div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background: #ecfdf5; color: #059669;">
          <i class="fas fa-wallet"></i>
        </div>
        <div>
          <div style="font-size: 13px; color: #888; font-weight: 600;">Spending</div>
          <div style="font-size: 24px; font-weight: 800;">‚Çπ<%= bookings.reduce((acc, b)=> acc + (b.totalPrice || 0),
              0).toLocaleString('en-IN') %></div>
        </div>
      </div>
    </div>

    <!-- Bulk Actions Bar -->
    <div id="bulkActionsBar" class="bulk-actions-bar">
      <div class="selection-info">
        <label class="booking-checkbox" style="display: flex; align-items: center; cursor: pointer;">
          <input type="checkbox" id="selectAllBookings">
          <div class="custom-checkbox me-3">
            <i class="fas fa-check"></i>
          </div>
          Select All
        </label>
        <span id="selectedCount" class="badge rounded-pill bg-light text-dark border ms-3"
          style="font-size: 14px; padding: 8px 15px;">0 Selected</span>
      </div>
      <button id="deleteSelectedBtn" class="btn-bulk-delete">
        <i class="fas fa-trash-alt"></i> Delete Selected
      </button>
    </div>

    <div class="bookings-grid">
      <% if(bookings.length===0) { %>
        <div class="empty-state-wrapper"
          style="max-width: 800px; margin: 40px auto 100px; perspective: 1000px; grid-column: 1 / -1;">
          <div class="empty-bookings-card"
            style="position: relative; padding: 100px 40px 80px; border-radius: 40px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 40px 100px rgba(0,0,0,0.08); text-align: center; overflow: hidden;">

            <!-- Floating Decorative Elements -->
            <div class="decorative-blob"
              style="position: absolute; top: -100px; right: -100px; width: 300px; height: 300px; background: rgba(254, 107, 0, 0.05); border-radius: 50%; filter: blur(60px); z-index: -1;">
            </div>
            <div class="decorative-blob"
              style="position: absolute; bottom: -100px; left: -100px; width: 300px; height: 300px; background: rgba(255, 142, 83, 0.05); border-radius: 50%; filter: blur(60px); z-index: -1;">
            </div>

            <div class="illustration-container" style="position: relative; display: inline-block; margin-bottom: 40px;">
              <img src="/images/empty-bookings.png" alt="No Bookings"
                style="width: 340px; height: auto; border-radius: 30px; animation: float-booking 6s ease-in-out infinite; box-shadow: 0 30px 60px rgba(0,0,0,0.1);">
              <div class="calendar-badge"
                style="position: absolute; -right: 20px; top: 20px; background: white; padding: 12px; border-radius: 18px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); animation: float-badge 4s ease-in-out infinite;">
                <i class="fas fa-calendar-alt text-primary-orange fs-4"></i>
              </div>
            </div>

            <h2 style="font-weight: 800; font-size: 34px; color: #1a1a1a; margin-bottom: 15px; letter-spacing: -1px;">No
              adventures yet!</h2>
            <p class="text-muted mb-5"
              style="font-size: 19px; max-width: 500px; margin: 0 auto 40px; line-height: 1.6;">Your travel history is a
              blank canvas. Let's fill it with unforgettable stays and unique experiences.</p>

            <div class="cta-wrapper"
              style="display: flex; gap: 20px; justify-content: center; align-items: center; flex-wrap: wrap;">
              <a href="/listings" class="btn btn-primary rounded-pill px-5 py-3 fw-bold"
                style="background: linear-gradient(135deg, #FE6B00 0%, #FF8E53 100%); border: none; box-shadow: 0 20px 40px rgba(254, 107, 0, 0.3); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); font-size: 18px; display: inline-flex; align-items: center; gap: 10px; color: white; text-decoration: none;">
                <i class="fas fa-search-location"></i> Discover Stays
              </a>
              <a href="/vehicles" class="btn btn-outline-dark rounded-pill px-5 py-3 fw-bold"
                style="border: 2px solid #222; transition: all 0.3s;">
                <i class="fas fa-car me-2"></i> Find a Ride
              </a>
            </div>
          </div>

          <!-- Personalized Discovery Section -->
          <div class="discovery-section text-center mt-5 pt-4"
            style="animation: fadeInUpBooking 1s ease-out forwards; animation-delay: 0.5s;">
            <h6 class="text-uppercase fw-bold text-muted mb-4" style="letter-spacing: 2px; font-size: 13px;">What are
              you looking for?</h6>
            <div class="d-flex justify-content-center gap-3 flex-wrap">
              <a href="/listings" class="discovery-pill">üèòÔ∏è Villa</a>
              <a href="/listings" class="discovery-pill">üèñÔ∏è Beach</a>
              <a href="/vehicles" class="discovery-pill">üèéÔ∏è Exotic</a>
              <a href="/dhabas" class="discovery-pill">üç≤ Local Eats</a>
            </div>
          </div>
        </div>

        <style>
          @keyframes float-booking {

            0%,
            100% {
              transform: translateY(0) rotate(0);
            }

            50% {
              transform: translateY(-15px) rotate(1deg);
            }
          }

          @keyframes float-badge {

            0%,
            100% {
              transform: translate(0, 0);
            }

            50% {
              transform: translate(-5px, -10px);
            }
          }

          @keyframes fadeInUpBooking {
            from {
              opacity: 0;
              transform: translateY(30px);
            }

            to {
              opacity: 1;
              transform: translateY(0);
            }
          }

          .discovery-pill {
            background: white;
            color: #222;
            padding: 10px 24px;
            border-radius: 100px;
            font-weight: 600;
            font-size: 15px;
            text-decoration: none;
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
            transition: all 0.3s;
          }

          .discovery-pill:hover {
            background: #f8f9fa;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            color: var(--primary-orange);
          }

          .btn-primary:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 25px 50px rgba(254, 107, 0, 0.4);
            color: white;
          }
        </style>
        <% } else { %>
          <% bookings.forEach(booking=> {
            let item = booking.listing || booking.dhaba || booking.vehicle;
            let imgUrl = "";
            let typeLabel = "";
            let detailLink = "";

            if (booking.type === 'listing') {
            imgUrl = item?.image?.url || item?.images?.find(img => img.isPrimary)?.url || item?.images?.[0]?.url;
            typeLabel = "Stay";
            detailLink = `/listings/${item?._id}`;
            } else if (booking.type === 'dhaba') {
            // Dhaba model uses 'image' as an array
            imgUrl = item?.image?.[0]?.url || item?.images?.[0]?.url;
            typeLabel = "Dining";
            detailLink = `/dhabas/${item?._id}`;
            } else if (booking.type === 'vehicle') {
            imgUrl = item?.image?.url || item?.images?.[0]?.url;
            typeLabel = "Rental";
            detailLink = `/vehicles/${item?._id}`;
            }

            if (!imgUrl) imgUrl =
            "https://images.unsplash.com/photo-1436491865332-7a61a109c0f3?auto=format&fit=crop&q=80&w=800";
            %>

            <div class="premium-booking-card" data-link="<%= detailLink %>" data-id="<%= booking._id %>">
              <div class="booking-checkbox-wrapper">
                <label class="booking-checkbox">
                  <input type="checkbox" class="booking-select" data-id="<%= booking._id %>">
                  <div class="custom-checkbox">
                    <i class="fas fa-check"></i>
                  </div>
                </label>
              </div>
              <div class="booking-type-tag">
                <% if(booking.type==='listing' ) { %> <i class="fas fa-home me-1"></i>
                  <% } else if(booking.type==='dhaba' ) { %> <i class="fas fa-utensils me-1"></i>
                    <% } else { %> <i class="fas fa-car me-1"></i>
                      <% } %>
                        <%= typeLabel %>
              </div>

              <div class="booking-image-wrapper">
                <img src="<%= imgUrl %>" alt="Booking Preview" class="booking-img">
              </div>

              <div class="booking-details">
                <div class="booking-header-row">
                  <div>
                    <a href="<%= detailLink %>" class="booking-title-main">
                      <%= item ? (item.title || `${item.brand} ${item.model}`) : 'Reserved Option' %>
                    </a>
                    <p class="text-muted small mt-1 mb-0">
                      <i class="fas fa-map-marker-alt me-1"></i>
                      <%= item?.location || item?.address || 'Worldwide' %>
                    </p>
                  </div>
                  <span class="booking-id-tag">#<%= booking._id.toString().slice(-6).toUpperCase() %></span>
                </div>

                <div class="booking-info-row">
                  <div class="info-item-box">
                    <div class="info-icon-circle"><i class="fas fa-calendar-day"></i></div>
                    <div class="info-labels">
                      <span class="info-label">Check In / Date</span>
                      <span class="info-value">
                        <%= new Date(booking.startDate || booking.date).toLocaleDateString('en-US', { month: 'short' ,
                          day: 'numeric' , year: 'numeric' }) %>
                      </span>
                    </div>
                  </div>
                  <div class="info-item-box">
                    <div class="info-icon-circle"><i class="fas fa-users"></i></div>
                    <div class="info-labels">
                      <span class="info-label">Reservation for</span>
                      <span class="info-value">
                        <%= booking.guests %> Guest<%= booking.guests> 1 ? 's' : '' %>
                      </span>
                    </div>
                  </div>
                  <% if (booking.endDate) { %>
                    <div class="info-item-box">
                      <div class="info-icon-circle"><i class="fas fa-calendar-check"></i></div>
                      <div class="info-labels">
                        <span class="info-label">Check Out</span>
                        <span class="info-value">
                          <%= new Date(booking.endDate).toLocaleDateString('en-US', { month: 'short' , day: 'numeric' ,
                            year: 'numeric' }) %>
                        </span>
                      </div>
                    </div>
                    <% } %>
                      <% if (booking.time) { %>
                        <div class="info-item-box">
                          <div class="info-icon-circle"><i class="fas fa-clock"></i></div>
                          <div class="info-labels">
                            <span class="info-label">Arrival Time</span>
                            <span class="info-value">
                              <%= booking.time %>
                            </span>
                          </div>
                        </div>
                        <% } %>
                </div>

                <div class="booking-footer">
                  <div class="price-display">
                    <span class="price-currency">Total Amount</span>
                    <span class="price-amount">‚Çπ<%= booking.totalPrice?.toLocaleString('en-IN') || '0' %></span>
                  </div>

                  <div class="action-group">
                    <% if (booking.status==='Cancelled' ) { %>
                      <span class="status-capsule capsule-cancelled">
                        <i class="fas fa-times-circle"></i> Cancelled
                      </span>
                      <% if (booking.paymentStatus==='Refunded' ) { %>
                        <span class="status-capsule capsule-confirmed">
                          <i class="fas fa-undo"></i> Refunded
                        </span>
                        <% } else if (booking.paymentStatus==='Refund Pending' ) { %>
                          <span class="status-capsule capsule-pending">
                            <i class="fas fa-clock"></i> Refund Pending
                          </span>
                          <% } %>
                            <% } else { %>
                              <% if (booking.isPaid) { %>
                                <a href="/bookings/<%= booking._id %>" class="text-decoration-none">
                                  <span class="status-capsule capsule-confirmed" style="cursor: pointer;">
                                    <i class="fas fa-check-circle"></i> Paid
                                  </span>
                                </a>
                                <% } else { %>
                                  <span class="status-capsule capsule-pending">
                                    <i class="fas fa-clock"></i>
                                    <%= booking.status || 'Pending' %>
                                  </span>
                                  <% } %>
                                    <% } %>

                                      <% if (!booking.isPaid && booking.status !=='Cancelled' ) { %>
                                        <form action="/bookings/<%= booking._id %>/pay" method="POST">
                                          <button class="btn-premium-action btn-pay pulse-pay">
                                            Pay Now <i class="fas fa-arrow-right"></i>
                                          </button>
                                        </form>
                                        <% } %>

                                          <div class="dropdown">
                                            <button class="btn-premium-action btn-outline" type="button"
                                              data-bs-toggle="dropdown">
                                              <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end shadow border-0 p-2"
                                              style="border-radius: 12px;">
                                              <li><a class="dropdown-item rounded-2" href="<%= detailLink %>"><i
                                                    class="fas fa-eye me-2"></i> View Details</a></li>

                                              <% if (booking.status !=='Cancelled' && booking.isPaid) { %>
                                                <li>
                                                  <form action="/bookings/<%= booking._id %>/cancel" method="POST"
                                                    id="cancel-form-<%= booking._id %>">
                                                    <button type="button"
                                                      onclick="handleBookingAction('cancel-form-<%= booking._id %>', 'Cancel Booking', 'Are you sure you want to cancel this booking? This action cannot be undone and may be subject to policies.', 'Cancel Booking')"
                                                      class="dropdown-item rounded-2 text-warning border-0 bg-transparent w-100 text-start">
                                                      <i class="fas fa-times-circle me-2"></i> Cancel Booking
                                                    </button>
                                                  </form>
                                                </li>
                                                <% } %>

                                                  <li>
                                                    <hr class="dropdown-divider">
                                                  </li>
                                                  <li>
                                                    <form action="/bookings/<%= booking._id %>?_method=DELETE"
                                                      method="POST" id="delete-form-<%= booking._id %>">
                                                      <button type="button"
                                                        onclick="handleBookingAction('delete-form-<%= booking._id %>', 'Confirm Deletion', 'Are you sure you want to delete this booking history? This action cannot be undone.', 'Delete')"
                                                        class="dropdown-item rounded-2 text-danger border-0 bg-transparent w-100 text-start">
                                                        <i class="fas fa-trash-alt me-2"></i> Delete History
                                                      </button>
                                                    </form>
                                                  </li>
                                            </ul>
                                          </div>
                  </div>
                </div>
              </div>
            </div>
            <% }); %>
              <% } %>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script>
    async function handleBookingAction(formId, title, message, confirmText) {
      const confirmed = await window.wanderConfirm(title, message, confirmText);
      if (confirmed) {
        document.getElementById(formId).submit();
      }
    }

    // Subtle entry animation
    document.addEventListener('DOMContentLoaded', () => {
      const cards = document.querySelectorAll('.premium-booking-card');
      const bulkBar = document.getElementById('bulkActionsBar');
      const selectAll = document.getElementById('selectAllBookings');
      const deleteBtn = document.getElementById('deleteSelectedBtn');
      const countDisplay = document.getElementById('selectedCount');
      const checkboxes = document.querySelectorAll('.booking-select');

      function updateBulkBar() {
        const selected = document.querySelectorAll('.booking-select:checked');
        const count = selected.length;

        if (count > 0) {
          bulkBar.classList.add('active');
          countDisplay.textContent = `${count} Selected`;
        } else {
          bulkBar.classList.remove('active');
          selectAll.checked = false;
        }

        // Update card styles
        checkboxes.forEach(cb => {
          const card = cb.closest('.premium-booking-card');
          if (cb.checked) {
            card.classList.add('selected');
          } else {
            card.classList.remove('selected');
          }
        });
      }

      // Checkbox click handler
      checkboxes.forEach(cb => {
        cb.addEventListener('change', updateBulkBar);
        // Prevent card click when clicking checkbox
        cb.parentElement.addEventListener('click', (e) => e.stopPropagation());
      });

      // Select All handler
      selectAll.addEventListener('change', (e) => {
        checkboxes.forEach(cb => cb.checked = e.target.checked);
        updateBulkBar();
      });

      // Delete Selected handler
      deleteBtn.addEventListener('click', async () => {
        const selected = Array.from(document.querySelectorAll('.booking-select:checked'))
          .map(cb => cb.getAttribute('data-id'));

        if (selected.length === 0) return;

        const confirmed = await window.wanderConfirm(
          'Confirm Bulk Deletion',
          `Are you sure you want to delete ${selected.length} selected bookings? This action cannot be undone.`,
          'Delete All'
        );

        if (confirmed) {
          try {
            const response = await fetch('/bookings/bulk', {
              method: 'DELETE',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ bookingIds: selected })
            });

            const result = await response.json();
            if (result.success) {
              window.location.reload();
            } else {
              alert(result.message || 'Failed to delete bookings');
            }
          } catch (error) {
            console.error('Bulk delete error:', error);
            alert('Something went wrong. Please try again.');
          }
        }
      });

      cards.forEach((card, index) => {
        // Entry Animation
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        setTimeout(() => {
          card.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
          card.style.opacity = '1';
          card.style.transform = 'translateY(0)';
        }, index * 100);

        // Click Handler
        card.addEventListener('click', (e) => {
          // Don't navigate if clicking a button, form, link, or dropdown
          if (e.target.closest('button') ||
            e.target.closest('form') ||
            e.target.closest('a') ||
            e.target.closest('.dropdown-menu')) {
            return;
          }

          const link = card.getAttribute('data-link');
          if (link) {
            window.location.href = link;
          }
        });
      });
    });
  </script>