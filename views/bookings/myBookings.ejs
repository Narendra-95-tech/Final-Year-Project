<% layout("/layouts/boilerplate") -%>

  <style>
    :root {
      --primary-orange: #fe6b00;
      --primary-dark: #1a1a1a;
      --bg-light: #f3f4f6;
      --text-main: #334155;
      --text-light: #64748b;
    }

    body {
      background-color: var(--bg-light);
    }

    .dashboard-container {
      padding-bottom: 80px;
      max-width: 1200px;
      margin: -40px auto 0;
      /* Overlap hero */
      padding-left: 20px;
      padding-right: 20px;
      position: relative;
      z-index: 10;
    }

    /* --- Hero Section & Countdown --- */
    .dashboard-hero {
      background: #111827;
      padding: 60px 40px 100px;
      /* Extra bottom padding for overlap */
      color: white;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .hero-pattern {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      opacity: 0.1;
      background-image: radial-gradient(#ffffff 1px, transparent 1px);
      background-size: 30px 30px;
    }

    .hero-greeting {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 10px;
      letter-spacing: -1px;
      position: relative;
      z-index: 2;
    }

    .hero-sub {
      font-size: 1.1rem;
      color: #9ca3af;
      margin-bottom: 40px;
      position: relative;
      z-index: 2;
    }

    /* --- Next Trip Card --- */
    .next-trip-card {
      background: linear-gradient(135deg, #fe6b00 0%, #ea580c 100%);
      color: white;
      border-radius: 24px;
      padding: 30px 40px;
      max-width: 800px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 25px 50px -12px rgba(234, 88, 12, 0.4);
      position: relative;
      overflow: hidden;
      text-align: left;
    }

    @media (max-width: 768px) {
      .next-trip-card {
        flex-direction: column;
        text-align: center;
        gap: 30px;
        padding: 30px 20px;
      }
    }

    .nt-info h3 {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: rgba(255, 255, 255, 0.8);
      margin-bottom: 8px;
      font-weight: 700;
    }

    .nt-title {
      font-size: 2.2rem;
      font-weight: 800;
      margin-bottom: 5px;
      line-height: 1.1;
    }

    .nt-date {
      font-size: 1.1rem;
      color: rgba(255, 255, 255, 0.95);
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: flex-start;
      font-weight: 500;
    }

    @media (max-width: 768px) {
      .nt-date {
        justify-content: center;
      }
    }

    .countdown-box {
      display: flex;
      gap: 20px;
      background: rgba(0, 0, 0, 0.1);
      padding: 15px 25px;
      border-radius: 20px;
      backdrop-filter: blur(5px);
    }

    .cd-item {
      text-align: center;
    }

    .cd-num {
      font-size: 2.2rem;
      font-weight: 800;
      line-height: 1;
      margin-bottom: 4px;
    }

    .cd-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      opacity: 0.8;
    }

    /* --- Stats Bar --- */
    .stats-bar {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      background: white;
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.05);
    }

    .stat-item {
      text-align: center;
      border-right: 1px solid #e2e8f0;
    }

    .stat-item:last-child {
      border-right: none;
    }

    .stat-val {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--text-main);
      line-height: 1;
      margin-bottom: 5px;
    }

    .stat-lbl {
      font-size: 0.85rem;
      color: var(--text-light);
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    @media (max-width: 600px) {
      .stats-bar {
        gap: 15px;
        padding: 15px;
      }

      .stat-val {
        font-size: 1.2rem;
      }

      .stat-lbl {
        font-size: 0.7rem;
      }
    }

    /* --- Search & Tabs --- */
    .controls-row {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      margin-bottom: 40px;
    }

    .search-wrap {
      width: 100%;
      max-width: 500px;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 16px 20px 16px 50px;
      border-radius: 100px;
      border: none;
      background: white;
      outline: none;
      font-size: 1rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      transition: all 0.2s;
    }

    .search-input:focus {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08);
      transform: translateY(-1px);
    }

    .search-icon {
      position: absolute;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      color: #94a3b8;
      font-size: 1.1rem;
      pointer-events: none;
    }

    .nav-pills {
      background: #e2e8f0;
      padding: 5px;
      border-radius: 100px;
      display: inline-flex;
      gap: 0;
    }

    .nav-pills .nav-link {
      background: transparent;
      color: #64748b;
      border-radius: 100px;
      padding: 10px 25px;
      font-weight: 600;
      font-size: 0.95rem;
      border: none;
      box-shadow: none;
    }

    .nav-pills .nav-link.active {
      background: white;
      color: var(--primary-dark);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    /* --- Timeline Layout --- */
    .timeline-container {
      position: relative;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px 0;
    }

    .timeline-line {
      position: absolute;
      left: 20px;
      top: 20px;
      bottom: 20px;
      width: 2px;
      background: #e2e8f0;
      z-index: 1;
    }

    .timeline-item {
      position: relative;
      padding-left: 50px;
      margin-bottom: 40px;
    }

    .timeline-dot {
      position: absolute;
      left: 13px;
      top: 25px;
      width: 16px;
      height: 16px;
      background: white;
      border: 4px solid var(--primary-orange);
      border-radius: 50%;
      z-index: 2;
      box-shadow: 0 0 0 4px #fef3c7;
    }

    .timeline-card {
      background: white;
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      border: 1px solid #f1f5f9;
      display: flex;
      gap: 20px;
      transition: all 0.2s;
    }

    .timeline-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08);
    }

    .tc-img-wrap {
      width: 140px;
      height: 120px;
      border-radius: 12px;
      overflow: hidden;
      flex-shrink: 0;
    }

    .tc-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    @media (max-width: 600px) {
      .timeline-card {
        flex-direction: column;
      }

      .tc-img-wrap {
        width: 100%;
        height: 160px;
      }
    }

    /* --- Grid Layout --- */
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 25px;
    }

    .booking-card {
      background: white;
      border-radius: 20px;
      overflow: hidden;
      border: 1px solid #f1f5f9;
      transition: all 0.3s;
      height: 100%;
      display: flex;
      flex-direction: column;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
    }

    .booking-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.08);
    }

    .card-img-wrap {
      height: 180px;
      position: relative;
      background: #e2e8f0;
    }

    .card-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.5s;
    }

    .booking-card:hover .card-img {
      transform: scale(1.05);
    }

    /* --- Cancelled Card Specifics --- */
    .cancelled-card .card-img-wrap {
      position: relative;
    }

    .cancelled-badge-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(220, 38, 38, 0.95);
      color: white;
      padding: 6px 14px;
      border-radius: 50px;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 1px;
      box-shadow: 0 4px 10px rgba(220, 38, 38, 0.3);
      z-index: 10;
      pointer-events: none;
    }

    .cancelled-card .card-img {
      /* Full visibility */
      opacity: 1;
    }

    .booking-card.cancelled-card {
      opacity: 1;
      transition: all 0.3s ease;
    }

    .booking-card.cancelled-card:hover {
      transform: translateY(-5px);
    }

    /* Bulk Delete Toolbar */
    .bulk-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      padding: 15px 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      border: 1px solid #f1f5f9;
    }

    .form-check-input.select-all-check {
      width: 20px;
      height: 20px;
      cursor: pointer;
      border-color: #cbd5e1;
    }

    .form-check-input.select-all-check:checked {
      background-color: var(--primary-orange);
      border-color: var(--primary-orange);
    }

    /* Card Checkbox overlay */
    .card-select-overlay {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 20;
    }

    .card-checkbox {
      width: 24px;
      height: 24px;
      cursor: pointer;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .card-checkbox:checked {
      background-color: var(--primary-orange);
      border-color: var(--primary-orange);
    }
  </style>

  <% /* 1. Separate Bookings */ const now=new Date(); now.setHours(0,0,0,0); let upcoming=[]; let history=[]; let
    cancelled=[]; bookings.forEach(b=> {
    let d = new Date(b.startDate || b.date);
    d.setHours(0,0,0,0);

    /* Safety: ensure listing/dhaba/vehicle populated */
    b.item = b.listing || b.dhaba || b.vehicle;
    b.title = b.item ? (b.item.title || b.item.name || `${b.item.brand} ${b.item.model}`) : 'Booking Unavailable';

    /* Image fallback logic */
    b.img = "";
    if (b.item) {
    if (b.type === 'dhaba' && b.item.image && b.item.image.length > 0) b.img = b.item.image[0].url;
    else if (b.item.image && b.item.image.url) b.img = b.item.image.url;
    else if (b.item.images && b.item.images.length > 0) b.img = b.item.images[0].url;
    }

    /* Use reliable fallback if empty */
    if (!b.img || b.img === "") {
    b.img = "https://placehold.co/600x400/e2e8f0/64748b?text=WanderLust+Trip";
    }

    if (b.status === 'Cancelled') {
    cancelled.push(b);
    } else if (d >= now) {
    upcoming.push(b);
    } else {
    history.push(b);
    }
    });

    /* Sort history descending */
    history.sort((a,b) => new Date(b.startDate||b.date) - new Date(a.startDate||a.date));

    /* Identify Next Trip */
    const nextTrip = upcoming.length > 0 ? upcoming[0] : null;
    %>

    <div class="dashboard-hero">
      <div class="hero-pattern"></div>
      <div class="hero-greeting">Hello, <%= currUser.username || 'Explorer' %>!</div>
      <div class="hero-sub">Your travel journey at a glance.</div>

      <% if (nextTrip) { let nextDate=new Date(nextTrip.startDate || nextTrip.date); %>
        <div class="next-trip-card">
          <div class="nt-info">
            <h3>Ready for takeoff?</h3>
            <div class="nt-title">
              <%= nextTrip.title %>
            </div>
            <div class="nt-date">
              <i class="fas fa-calendar-day"></i>
              <%= nextDate.toLocaleDateString('en-US', { weekday: 'long' , month: 'long' , day: 'numeric' }) %>
            </div>
            <div class="mt-4">
              <a href="/bookings/<%= nextTrip._id %>" class="btn btn-light rounded-pill px-4 fw-bold text-primary">
                <i class="fas fa-ticket-alt me-2"></i> View Ticket
              </a>
            </div>
          </div>
          <div class="countdown-box" id="countdown" data-date="<%= nextDate.toISOString() %>">
            <div class="cd-item">
              <div class="cd-num" id="cd-days">00</div>
              <div class="cd-label">Days</div>
            </div>
            <div class="cd-item">
              <div class="cd-num" id="cd-hours">00</div>
              <div class="cd-label">Hours</div>
            </div>
            <div class="cd-item">
              <div class="cd-num" id="cd-mins">00</div>
              <div class="cd-label">Mins</div>
            </div>
          </div>
        </div>
        <% } else { %>
          <div
            style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); display: inline-block; padding: 15px 30px; border-radius: 100px; border: 1px solid rgba(255,255,255,0.2);">
            <span style="opacity: 0.9;">No upcoming trips.</span>
            <a href="/listings" class="text-white fw-bold text-decoration-none ms-2"
              style="border-bottom: 1px solid white;">Book your next adventure</a>
          </div>
          <% } %>
    </div>

    <div class="dashboard-container">
      <!-- Quick Stats -->
      <div class="stats-bar">
        <div class="stat-item">
          <div class="stat-val">
            <%= upcoming.length %>
          </div>
          <div class="stat-lbl">Upcoming</div>
        </div>
        <div class="stat-item">
          <div class="stat-val">
            <%= history.length %>
          </div>
          <div class="stat-lbl">Completed</div>
        </div>
        <div class="stat-item">
          <div class="stat-val">
            <%= bookings.length %>
          </div>
          <div class="stat-lbl">Total Trips</div>
        </div>
      </div>

      <div class="controls-row">
        <!-- Search -->
        <div class="search-wrap">
          <i class="fas fa-search search-icon"></i>
          <input type="text" id="tripSearch" class="search-input" placeholder="Search by destination...">
        </div>

        <!-- Tabs -->
        <ul class="nav nav-pills" id="pills-tab" role="tablist">
          <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-upcoming">Upcoming</button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-history">History</button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-cancelled">Cancelled</button>
          </li>
        </ul>
      </div>

      <!-- Tab Content -->
      <div class="tab-content" id="pills-tabContent">

        <!-- UPCOMING -->
        <div class="tab-pane fade show active" id="pills-upcoming">
          <% if (upcoming.length> 0) { %>
            <div class="timeline-container">
              <div class="timeline-line"></div>
              <% upcoming.forEach(b=> {
                let d = new Date(b.startDate || b.date);
                %>
                <div class="timeline-item searchable-item" data-search="<%= b.title %>">
                  <div class="timeline-dot"></div>
                  <div class="timeline-card">
                    <div class="tc-img-wrap">
                      <img src="<%= b.img %>" class="tc-img" alt="Trip Image"
                        onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80';">
                    </div>
                    <div class="flex-grow-1">
                      <div class="d-flex justify-content-between mb-1">
                        <h5 class="fw-bold m-0 text-dark">
                          <%= b.title %>
                        </h5>
                        <div>
                          <!-- Badge Logic: Confirmed ONLY if Paid AND Confirmed -->
                          <% if(b.status==='Confirmed' && (b.isPaid || b.paymentStatus==='Paid' )) { %>
                            <span class="badge bg-success bg-opacity-10 text-success rounded-pill px-3">Confirmed</span>
                            <% } else if (b.status==='Cancelled' ) { %>
                              <span class="badge bg-danger bg-opacity-10 text-danger rounded-pill px-3">Cancelled</span>
                              <% } else { %>
                                <span
                                  class="badge bg-warning bg-opacity-10 text-warning rounded-pill px-3">Pending</span>
                                <% } %>
                        </div>
                      </div>
                      <div class="text-muted small mb-3">
                        <i class="fas fa-calendar me-1"></i>
                        <%= d.toLocaleDateString() %>
                          <span class="mx-2">•</span>
                          <i class="fas fa-users me-1"></i>
                          <%= b.guests %> Guests
                      </div>
                      <div class="d-flex gap-2 align-items-center flex-wrap">
                        <a href="/bookings/<%= b._id %>" class="btn btn-sm btn-dark rounded-pill px-3">Details</a>
                        <% if(b.isPaid) { %>
                          <a href="/bookings/<%= b._id %>/invoice"
                            class="btn btn-sm btn-outline-secondary rounded-pill px-3"><i class="fas fa-download"></i>
                            Receipt</a>
                          <% } %>

                            <!-- Cancel Option -->
                            <form action="/bookings/<%= b._id %>/cancel" method="POST" class="d-inline ms-auto">
                              <button type="button"
                                onclick="confirmCancel(this.form, <%= b.isPaid ? b.totalPrice : 0 %>)"
                                class="btn btn-sm text-danger rounded-pill px-3 border-0 fw-bold">
                                Cancel
                              </button>
                            </form>
                      </div>
                    </div>
                  </div>
                </div>
                <% }); %>
            </div>
            <% } else { %>
              <div class="empty-state">
                <i class="fas fa-plane-departure empty-icon"></i>
                <h5>No upcoming trips scheduled</h5>
                <p>Time to pack your bags!</p>
                <a href="/listings" class="btn btn-primary rounded-pill px-4"
                  style="background: var(--primary-orange); border:none;">Explore Destinations</a>
              </div>
              <% } %>
        </div>

        <!-- HISTORY -->
        <div class="tab-pane fade" id="pills-history">
          <% if(history.length> 0) { %>
            <div class="bulk-toolbar">
              <div class="d-flex align-items-center gap-2">
                <input type="checkbox" class="form-check-input select-all-check" id="selectAllHistory"
                  onclick="toggleSelectAll(this, 'history')">
                <label class="form-check-label fw-bold text-muted small" for="selectAllHistory"
                  style="cursor: pointer;">SELECT ALL</label>
              </div>
              <button id="bulkDeleteBtnHistory" class="btn btn-sm btn-danger rounded-pill px-3 fw-bold shadow-none"
                style="display: none;" onclick="confirmBulkDelete('history')">
                <i class="fas fa-trash-alt me-1"></i> Delete Selected (<span id="selectedCountHistory">0</span>)
              </button>
            </div>
            <% } %>
              <div class="cards-grid">
                <% history.forEach(b=> {
                  let d = new Date(b.startDate || b.date);
                  %>
                  <div class="booking-card searchable-item" data-search="<%= b.title %>">
                    <div class="card-img-wrap">
                      <div class="card-select-overlay">
                        <input type="checkbox" class="form-check-input card-checkbox history-checkbox"
                          value="<%= b._id %>" onchange="updateBulkState('history')">
                      </div>
                      <img src="<%= b.img %>" class="card-img">
                    </div>
                    <div class="card-body">
                      <div class="card-title text-truncate">
                        <%= b.title %>
                      </div>
                      <div class="card-meta">
                        <i class="fas fa-check-circle text-success"></i>
                        Completed on <%= d.toLocaleDateString() %>
                      </div>
                      <div class="card-footer d-flex justify-content-between">
                        <div class="d-flex gap-1">
                          <a href="/bookings/<%= b._id %>" class="btn btn-sm btn-light rounded-pill">View Memory</a>
                          <% if(b.type==='listing' ) { %>
                            <a href="/listings/<%= b.item._id %>"
                              class="btn btn-sm btn-outline-primary rounded-pill border-0">Book Again</a>
                            <% } %>
                        </div>
                        <form action="/bookings/<%= b._id %>?_method=DELETE" method="POST" class="d-inline">
                          <button type="button" onclick="confirmDelete(this.form)"
                            class="btn btn-sm text-danger rounded-pill border-0 p-0 fs-5" title="Delete from History">
                            <i class="fas fa-trash-alt"></i>
                          </button>
                        </form>
                      </div>
                    </div>
                  </div>
                  <% }); %>
              </div>
              <% if(history.length===0) { %>
                <div class="empty-state">
                  <i class="fas fa-history empty-icon"></i>
                  <h5>No travel history yet</h5>
                  <p>Your past adventures will appear here.</p>
                </div>
                <% } %>
        </div>

        <!-- CANCELLED -->
        <div class="tab-pane fade" id="pills-cancelled">

          <% if(cancelled.length> 0) { %>
            <div class="bulk-toolbar">
              <div class="d-flex align-items-center gap-2">
                <input type="checkbox" class="form-check-input select-all-check" id="selectAllCancelled"
                  onclick="toggleSelectAll(this, 'cancelled')">
                <label class="form-check-label fw-bold text-muted small" for="selectAllCancelled"
                  style="cursor: pointer;">SELECT ALL</label>
              </div>
              <button id="bulkDeleteBtnCancelled" class="btn btn-sm btn-danger rounded-pill px-3 fw-bold shadow-none"
                style="display: none;" onclick="confirmBulkDelete('cancelled')">
                <i class="fas fa-trash-alt me-1"></i> Delete Selected (<span id="selectedCountCancelled">0</span>)
              </button>
            </div>
            <% } %>

              <div class="cards-grid">
                <% cancelled.forEach(b=> {
                  let d = new Date(b.startDate || b.date);
                  %>
                  <div class="booking-card cancelled-card searchable-item" data-search="<%= b.title %>">
                    <div class="card-img-wrap">
                      <div class="card-select-overlay">
                        <input type="checkbox" class="form-check-input card-checkbox cancelled-checkbox"
                          value="<%= b._id %>" onchange="updateBulkState('cancelled')">
                      </div>
                      <img src="<%= b.img %>" class="card-img"
                        onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1488646953014-85cb44e25828?auto=format&fit=crop&q=80&w=800';">
                      <div class="cancelled-badge-overlay">
                        <i class="fas fa-ban me-1"></i> Cancelled
                      </div>
                    </div>
                    <div class="card-body">
                      <div class="card-title text-truncate text-muted">
                        <%= b.title %>
                      </div>
                      <div class="card-meta">
                        <i class="far fa-calendar-times"></i> Was: <%= d.toLocaleDateString() %>
                      </div>
                      <div class="card-footer d-flex justify-content-between align-items-center">
                        <a href="/bookings/<%= b._id %>" class="btn btn-sm btn-light rounded-pill">Details</a>
                        <form action="/bookings/<%= b._id %>?_method=DELETE" method="POST" class="d-inline">
                          <button type="button" onclick="confirmDelete(this.form)"
                            class="btn btn-sm btn-danger rounded-pill px-3 shadow-none border-0"
                            style="background-color: #ef4444; color: white;">
                            <i class="fas fa-trash-alt me-1"></i> Delete
                          </button>
                        </form>
                      </div>
                    </div>
                  </div>
                  <% }); %>
              </div>
              <% if(cancelled.length===0) { %>
                <div class="empty-state">
                  <i class="fas fa-check empty-icon text-success"></i>
                  <h5>No cancellation history</h5>
                  <p>Your record is clean!</p>
                </div>
                <% } %>
        </div>

      </div>
    </div>

    <script>
      async function confirmCancel(form, amount) {
        let msg = 'Are you sure you want to cancel this upcoming trip? Action cannot be undone.';
        let confirmBtn = 'Yes, Cancel Trip';

        if (amount && amount > 0) {
          msg = `Are you sure? A refund of ₹${amount} will be processed to your original payment method.`;
          confirmBtn = `Yes, Cancel & Refund ₹${amount}`;
        }

        const confirmed = await window.wanderConfirm('Cancel Booking', msg, confirmBtn);
        if (confirmed) form.submit();
      }
    </script>

    <script>
      async function confirmDelete(form) {
        const confirmed = await window.wanderConfirm('Delete History', 'Are you sure you want to remove this cancelled booking from your history?', 'Delete Forever');
        if (confirmed) form.submit();
      }

      // Bulk Delete Logic
      function toggleSelectAll(source, scope) {
        const className = scope === 'history' ? '.history-checkbox' : '.cancelled-checkbox';
        const checkboxes = document.querySelectorAll(className);
        checkboxes.forEach(cb => cb.checked = source.checked);
        updateBulkState(scope);
      }

      function updateBulkState(scope) {
        const className = scope === 'history' ? '.history-checkbox' : '.cancelled-checkbox';
        const btnId = scope === 'history' ? 'bulkDeleteBtnHistory' : 'bulkDeleteBtnCancelled';
        const countId = scope === 'history' ? 'selectedCountHistory' : 'selectedCountCancelled';
        const selectAllId = scope === 'history' ? 'selectAllHistory' : 'selectAllCancelled';

        const checkboxes = document.querySelectorAll(`${className}:checked`);
        const count = checkboxes.length;
        const btn = document.getElementById(btnId);
        const countSpan = document.getElementById(countId);

        if (btn && countSpan) {
          countSpan.innerText = count;
          btn.style.display = count > 0 ? 'inline-block' : 'none';
        }

        // Update Select All Checkbox state
        const allCheckboxes = document.querySelectorAll(className);
        const selectAll = document.getElementById(selectAllId);
        if (selectAll && allCheckboxes.length > 0) {
          selectAll.checked = allCheckboxes.length === count && count > 0;
        }
      }

      async function confirmBulkDelete(scope) {
        const className = scope === 'history' ? '.history-checkbox' : '.cancelled-checkbox';
        const selected = Array.from(document.querySelectorAll(`${className}:checked`)).map(cb => cb.value);
        if (selected.length === 0) return;

        const confirmed = await window.wanderConfirm(
          'Bulk Delete',
          `Are you sure you want to delete ${selected.length} bookings permanently?`,
          'Delete Forever'
        );

        if (confirmed) {
          try {
            const response = await fetch('/bookings/bulk', {
              method: 'DELETE',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ bookingIds: selected })
            });

            const result = await response.json();
            if (result.success) {
              window.location.reload();
            } else {
              alert(result.message || 'Failed to delete bookings');
            }
          } catch (err) {
            console.error(err);
            alert('An error occurred');
          }
        }
      }
    </script>

    <script>
      // Countdown Logic
      const cdContainer = document.getElementById('countdown');
      if (cdContainer) {
        const targetDate = new Date(cdContainer.dataset.date).getTime();

        function updateTimer() {
          const now = new Date().getTime();
          const distance = targetDate - now;

          if (distance < 0) {
            cdContainer.innerHTML = "<div class='text-white fw-bold fs-4'>Trip Started!</div>";
            return;
          }

          const days = Math.floor(distance / (1000 * 60 * 60 * 24));
          const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
          const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));

          document.getElementById('cd-days').innerText = days.toString().padStart(2, '0');
          document.getElementById('cd-hours').innerText = hours.toString().padStart(2, '0');
          document.getElementById('cd-mins').innerText = minutes.toString().padStart(2, '0');
        }

        setInterval(updateTimer, 1000);
        updateTimer();
      }

      // Client-Side Search
      document.getElementById('tripSearch').addEventListener('input', function (e) {
        const term = e.target.value.toLowerCase();
        const items = document.querySelectorAll('.searchable-item');

        items.forEach(item => {
          const searchData = item.dataset.search.toLowerCase();
          if (searchData.includes(term)) {
            item.style.display = "";
          } else {
            item.style.display = "none";
          }
        });
      });
    </script>