<%- layout('layouts/boilerplate') %>
    <link rel="stylesheet" href="/css/social.css">

    <div class="social-header py-5" style="background: #fff; border-bottom: 1px solid #eee;">
        <div class="container text-center">
            <h1 class="fw-800" style="font-size: 42px; letter-spacing: -1.5px;">WanderJournal</h1>
            <p class="text-muted fs-5">Share your soul's adventures with the world.</p>
        </div>
    </div>

    <div class="container mt-4">
        <!-- Tab Navigation -->
        <div class="social-tabs">
            <a href="/social?tab=community" class="tab-item <%= activeTab === 'community' ? 'active' : '' %>">
                <i class="fas fa-globe-americas me-2"></i>Community
            </a>
            <a href="/social?tab=mine" class="tab-item <%= activeTab === 'mine' ? 'active' : '' %>">
                <i class="fas fa-bookmark me-2"></i>My Stories
            </a>
        </div>

        <div class="social-feed-container">
            <!-- Social Feed -->
            <% if (journals && journals.length> 0) { %>
                <% journals.forEach(post=> { %>
                    <div class="social-post-card" id="post-<%= post._id %>">
                        <!-- Header -->
                        <div class="post-header">
                            <% if (post.author) { %>
                                <a href="/profile/<%= post.author.username %>" class="author-info">
                                    <img src="<%= (post.author.avatar && post.author.avatar.url) ? post.author.avatar.url : '/images/default-avatar.png' %>"
                                        class="author-avatar" alt="avatar"
                                        onerror="this.src='/images/default-avatar.png'">
                                    <div>
                                        <div class="author-name">
                                            <%= post.author.username %>
                                        </div>
                                        <div class="post-location"><i class="fas fa-map-marker-alt"></i>
                                            <%= post.location %>
                                        </div>
                                    </div>
                                </a>
                                <% } else { %>
                                    <div class="author-info">
                                        <img src="/images/default-avatar.png" class="author-avatar" alt="avatar">
                                        <div>
                                            <div class="author-name text-muted">Deleted User</div>
                                            <div class="post-location"><i class="fas fa-map-marker-alt"></i>
                                                <%= post.location %>
                                            </div>
                                        </div>
                                    </div>
                                    <% } %>

                                        <div class="dropdown">
                                            <button class="btn btn-link text-dark shadow-none p-0"
                                                data-bs-toggle="dropdown">
                                                <i class="fas fa-ellipsis-h"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end border-0 shadow-sm mt-2"
                                                style="border-radius: 12px;">
                                                <% if (currentUser && post.author &&
                                                    post.author._id.toString()===currentUser._id.toString()) { %>
                                                    <li>
                                                        <button class="dropdown-item text-danger fw-600 delete-post-btn"
                                                            data-post-id="<%= post._id %>">
                                                            <i class="far fa-trash-alt me-2"></i>Delete Story
                                                        </button>
                                                    </li>
                                                    <% } %>
                                                        <li><a class="dropdown-item" href="#"><i
                                                                    class="far fa-paper-plane me-2"></i>Share</a></li>
                                                        <li><a class="dropdown-item" href="#"><i
                                                                    class="far fa-flag me-2"></i>Report</a></li>
                                            </ul>
                                        </div>
                        </div>

                        <!-- Image Carousel/Image -->
                        <div class="post-image-container">
                            <% if (post.images && post.images.length> 0) { %>
                                <img src="<%= post.images[0].url %>" class="post-image" alt="Post content">
                                <% } else { %>
                                    <div
                                        style="height: 300px; background: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-camera text-muted fs-1"></i>
                                    </div>
                                    <% } %>
                        </div>

                        <!-- Actions -->
                        <div class="post-actions">
                            <% const isLiked=post.likes && post.likes.some(u=> u && u._id && u._id.toString() ===
                                currentUser._id.toString()); %>
                                <div class="post-action-btn like-btn" data-post-id="<%= post._id %>">
                                    <i class="<%= isLiked ? 'fas text-danger' : 'far' %> fa-heart"></i>
                                </div>
                                <div class="post-action-btn"><i class="far fa-comment"></i></div>
                                <div class="post-action-btn"><i class="far fa-paper-plane"></i></div>
                        </div>

                        <!-- Content -->
                        <div class="post-content-area">
                            <div class="post-likes-text">
                                <span class="like-count" id="like-count-<%= post._id %>">
                                    <%= post.likes.length %>
                                </span> likes
                            </div>
                            <div class="post-description">
                                <strong>
                                    <%= post.author ? post.author.username : 'Deleted User' %>
                                </strong>
                                <%= post.content %>
                            </div>

                            <!-- Comments Preview -->
                            <div class="post-comments-preview">
                                <small class="text-muted text-uppercase fw-bold" style="font-size: 11px;">Comments
                                    (<span id="comment-count-<%= post._id %>">
                                        <%= post.comments.length %>
                                    </span>)</small>
                                <div class="comments-list mt-2" id="comments-<%= post._id %>">
                                    <% post.comments.slice(0, 3).forEach(comment=> { %>
                                        <% if (comment && comment.author) { %>
                                            <div class="comment-item mb-1">
                                                <strong>
                                                    <%= comment.author.username %>
                                                </strong> <span class="text-secondary">
                                                    <%= comment.content %>
                                                </span>
                                            </div>
                                            <% } %>
                                                <% }) %>
                                                    <% if (post.comments.length> 3) { %>
                                                        <a href="#" class="small text-muted text-decoration-none">View
                                                            all <%= post.comments.length %> comments</a>
                                                        <% } %>
                                </div>
                            </div>
                            <div class="mt-3">
                                <small class="text-muted text-uppercase" style="font-size: 10px;">
                                    <%= post.createdAt.toLocaleDateString('en-US', { month: 'long' , day: 'numeric' })
                                        %> â€¢ WanderJournal
                                </small>
                            </div>
                        </div>

                        <!-- Comment Input -->
                        <form class="comment-form" data-post-id="<%= post._id %>">
                            <div class="comment-input-group d-flex gap-2">
                                <input type="text" class="form-control border-0 shadow-none p-0"
                                    placeholder="Add a comment..." style="font-size: 14px;">
                                <button type="submit" class="btn text-primary fw-bold p-0">Post</button>
                            </div>
                        </form>
                    </div>
                    <% }) %>
                        <% } else { %>
                            <div class="text-center py-5 empty-journal-state">
                                <img src="/images/journal-empty.png" class="img-fluid mb-4"
                                    style="max-width: 320px; animation: float 3s ease-in-out infinite;"
                                    alt="Empty Journal">
                                <h2 class="fw-800 text-dark">No stories yet</h2>
                                <p class="text-muted fs-5">Be the first to share your soul's adventures with the world!
                                </p>
                                <button class="btn btn-primary rounded-pill px-4 py-2 mt-2" data-bs-toggle="modal"
                                    data-bs-target="#createJournalModal">
                                    <i class="fas fa-pen me-2"></i>Create My First Story
                                </button>
                            </div>
                            <% } %>
        </div>
    </div>

    <!-- Floating Action Button -->
    <a href="#" class="fab-create" data-bs-toggle="modal" data-bs-target="#createJournalModal">
        <i class="fas fa-plus"></i>
    </a>

    <!-- Create Modal -->
    <div class="modal fade" id="createJournalModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 24px;">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-800">New Journal Entry</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form action="/social" method="POST" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-uppercase">Title</label>
                            <input type="text" class="form-control rounded-3" name="title" required
                                placeholder="Give your adventure a name">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-uppercase">Where was this?</label>
                            <input type="text" class="form-control rounded-3" name="location" required
                                placeholder="e.g. Santorini, Greece">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-uppercase">The Story</label>
                            <textarea class="form-control rounded-3" name="content" rows="4" required
                                placeholder="What made this trip special?"></textarea>
                        </div>
                        <div class="mb-4">
                            <label class="form-label small fw-bold text-uppercase">Photos</label>
                            <input type="file" class="form-control rounded-3" name="images" multiple accept="image/*">
                        </div>
                        <button type="submit" class="btn btn-primary w-100 py-3 fw-bold rounded-pill"
                            style="background: var(--instagram-gradient); border: none;">Post Journey</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/social.js"></script>