<% layout("/layouts/boilerplate") -%>

<!-- Mapbox CSS & JS -->
<link href="https://api.mapbox.com/mapbox-gl-js/v2.20.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v2.20.0/mapbox-gl.js"></script>
<script type="application/json" id="dhaba-data"><%- JSON.stringify(dhaba) %></script>

<!-- Title -->
<div class="row mt-3 justify-content-center">
  <div class="col-md-10 text-center">
    <h2>üçΩÔ∏è <%= dhaba.title %></h2>
    <div class="mb-3">
      <span class="badge bg-primary me-2"><%= dhaba.category %></span>
      <span class="badge bg-success me-2"><%= dhaba.cuisine %></span>
      <% if (dhaba.establishedYear) { %>
        <span class="badge bg-secondary">Est. <%= dhaba.establishedYear %></span>
      <% } %>
    </div>
    <% if (dhaba.rating) { %>
      <div class="mb-2">
        <% for (let i = 1; i <= 5; i++) { %>
          <i class="fa fa-star <%= i <= dhaba.rating ? 'text-warning' : 'text-muted' %>"></i>
        <% } %>
        <span class="ms-2 text-muted">(<%= dhaba.rating %>)</span>
      </div>
    <% } %>
  </div>
</div>

<div class="row justify-content-center">
  <div class="col-md-10">
    <div class="row">
      <!-- Left Column - Images & Details -->
      <div class="col-lg-8">
        <!-- Main Image -->
        <div class="card listing-card mb-4">
          <% if (dhaba.image && dhaba.image.url) { %>
            <img src="<%= dhaba.image.url %>" class="card-img-top show-img" alt="<%= dhaba.title %>" />
          <% } else { %>
            <img src="https://via.placeholder.com/600x300?text=No+Image+Available" class="card-img-top show-img" alt="<%= dhaba.title %>" />
          <% } %>
          <div class="card-body">
            <p class="card-text text-muted mb-2">Owned by: <strong><%= dhaba.owner.username %></strong></p>
            <% if (dhaba.description) { %>
              <p class="card-text"><%= dhaba.description %></p>
            <% } %>
          </div>
        </div>

        <!-- Quick Info Cards -->
        <div class="row g-3 mb-4">
          <!-- Basic Info -->
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-header bg-primary text-white">
                <h6 class="mb-0">üìã Basic Information</h6>
              </div>
              <div class="card-body">
                <div class="row g-2">
                  <div class="col-6"><strong>Category:</strong></div>
                  <div class="col-6"><%= dhaba.category %></div>
                  <div class="col-6"><strong>Cuisine:</strong></div>
                  <div class="col-6"><%= dhaba.cuisine %></div>
                  <div class="col-6"><strong>Location:</strong></div>
                  <div class="col-6"><%= dhaba.location %>, <%= dhaba.country %></div>
                  <div class="col-6"><strong>Price:</strong></div>
                  <div class="col-6">‚Çπ<%= dhaba.price ? Number(dhaba.price).toLocaleString("en-IN") : "N/A" %></div>
                  <% if (dhaba.operatingHours) { %>
                    <div class="col-6"><strong>Hours:</strong></div>
                    <div class="col-6">
                      <%= dhaba.operatingHours.opens %> - <%= dhaba.operatingHours.closes %>
                      <% if (dhaba.operatingHours.isOpen24Hours) { %>
                        <span class="text-success">(24/7)</span>
                      <% } %>
                    </div>
                  <% } %>
                </div>
              </div>
            </div>
          </div>

          <!-- Rating & Features -->
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-header bg-success text-white">
                <h6 class="mb-0">‚≠ê Rating & Features</h6>
              </div>
              <div class="card-body text-center">
                <div class="display-4 text-warning mb-2">
                  <%= dhaba.rating || 4.0 %>
                </div>
                <div class="mb-3">
                  <% for (let i = 1; i <= 5; i++) { %>
                    <i class="fa fa-star <%= i <= (dhaba.rating || 4) ? 'text-warning' : 'text-muted' %>"></i>
                  <% } %>
                </div>
                <p class="text-muted">Based on customer reviews</p>

                <% if (dhaba.facilities && dhaba.facilities.length > 0) { %>
                  <div class="mt-3">
                    <h6>Facilities:</h6>
                    <div class="d-flex flex-wrap gap-1 justify-content-center">
                      <% dhaba.facilities.forEach(facility => { %>
                        <span class="badge bg-light text-dark"><%= facility %></span>
                      <% }); %>
                    </div>
                  </div>
                <% } %>

                <% if (dhaba.specialties && dhaba.specialties.length > 0) { %>
                  <div class="mt-3">
                    <h6>Specialties:</h6>
                    <div class="d-flex flex-wrap gap-1 justify-content-center">
                      <% dhaba.specialties.forEach(specialty => { %>
                        <span class="badge bg-warning text-dark"><%= specialty %></span>
                      <% }); %>
                    </div>
                  </div>
                <% } %>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column - Map & Actions -->
      <div class="col-lg-4">
        <!-- Booking Card -->
        <% if (currUser) { %>
          <!-- User is logged in - show booking form -->
          <div class="card mb-4">
            <div class="card-header bg-success text-white">
              <h6 class="mb-0">üóìÔ∏è Book a Table</h6>
            </div>
            <div class="card-body">
              <form id="booking-form" class="needs-validation" novalidate>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="startDate" class="form-label">Check-in Date</label>
                    <input type="date" class="form-control" id="startDate" name="startDate" required>
                    <div class="invalid-feedback">Please select a check-in date.</div>
                  </div>
                  <div class="col-md-6">
                    <label for="endDate" class="form-label">Check-out Date</label>
                    <input type="date" class="form-control" id="endDate" name="endDate" required>
                    <div class="invalid-feedback">Please select a check-out date.</div>
                  </div>
                  <div class="col-12">
                    <label for="guests" class="form-label">Number of Guests</label>
                    <input type="number" class="form-control" id="guests" name="guests" min="1" max="20" value="1" required>
                    <div class="invalid-feedback">Please enter number of guests.</div>
                  </div>
                  <div class="col-12">
                    <div class="d-flex align-items-center mb-2">
                      <span class="fw-semibold">Total Price: ‚Çπ</span>
                      <span id="totalPrice" class="fw-bold ms-1">0</span>
                      <span id="availability-status" class="small ms-3"></span>
                    </div>
                    <button type="submit" class="btn btn-success btn-sm w-100">Book Now</button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        <% } else { %>
          <!-- Debug: User not logged in -->
          <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
              <h6 class="mb-0">üîê Login Required</h6>
            </div>
            <div class="card-body text-center">
              <p class="mb-3">Please log in to book a table</p>
              <a href="/login" class="btn btn-primary">Login</a>
              <!-- Debug info -->
              <div class="mt-3 p-2 bg-light rounded small text-muted">
                <strong>Debug:</strong> currUser = <%= currUser ? 'LOGGED_IN' : 'NOT_LOGGED_IN' %>
              </div>
            </div>
          </div>
        <% } %>

        <!-- Contact Info -->
        <% if (dhaba.phone || dhaba.email || dhaba.website) { %>
          <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
              <h6 class="mb-0">üìû Contact Information</h6>
            </div>
            <div class="card-body">
              <% if (dhaba.phone) { %>
                <p class="mb-2"><i class="fa fa-phone me-2"></i><a href="tel:<%= dhaba.phone %>"><%= dhaba.phone %></a></p>
              <% } %>
              <% if (dhaba.email) { %>
                <p class="mb-2"><i class="fa fa-envelope me-2"></i><a href="mailto:<%= dhaba.email %>"><%= dhaba.email %></a></p>
              <% } %>
              <% if (dhaba.website) { %>
                <p class="mb-2"><i class="fa fa-globe me-2"></i><a href="<%= dhaba.website %>" target="_blank"><%= dhaba.website %></a></p>
              <% } %>
            </div>
          </div>
        <% } %>

        <!-- Owner Actions -->
        <% if (currUser && dhaba.owner && dhaba.owner.equals(currUser._id)) { %>
          <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
              <h6 class="mb-0">‚öôÔ∏è Owner Actions</h6>
            </div>
            <div class="card-body">
              <a class="btn btn-outline-primary btn-sm mb-2 w-100" href="/dhabas/<%= dhaba._id %>/edit">
                <i class="fa fa-edit"></i> Edit Dhaba
              </a>
              <form method="POST" action="/dhabas/<%= dhaba._id %>?_method=DELETE" class="d-inline">
                <button class="btn btn-outline-danger btn-sm w-100" type="submit">
                  <i class="fa fa-trash"></i> Delete Dhaba
                </button>
              </form>
            </div>
          </div>
        <% } %>

        <!-- Reviews Section -->
        <div class="card">
          <div class="card-header bg-secondary text-white">
            <h6 class="mb-0">üí¨ Reviews</h6>
          </div>
          <div class="card-body">
            <% if (dhaba.reviews && dhaba.reviews.length > 0) { %>
              <% dhaba.reviews.forEach(review => { %>
                <div class="review-card mb-3 p-2 border rounded">
                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <strong><%= review.author.username %></strong>
                    <div>
                      <% for (let i = 1; i <= 5; i++) { %>
                        <i class="fa fa-star <%= i <= review.rating ? 'text-warning' : 'text-muted' %>"></i>
                      <% } %>
                    </div>
                  </div>
                  <p class="mb-0 text-muted small"><%= review.comment %></p>
                </div>
              <% }); %>
            <% } else { %>
              <p class="text-muted mb-0">No reviews yet.</p>
            <% } %>

            <!-- Add Review Form -->
            <% if (currUser) { %>
              <hr>
              <h6>Add Review</h6>
              <form method="POST" action="/dhabas/<%= dhaba._id %>/reviews" novalidate class="needs-validation">
                <div class="mb-3">
                  <label class="form-label">Rating</label>
                  <select name="review[rating]" class="form-select" required>
                    <option value="">Select Rating</option>
                    <option value="1">1 Star</option>
                    <option value="2">2 Stars</option>
                    <option value="3">3 Stars</option>
                    <option value="4">4 Stars</option>
                    <option value="5">5 Stars</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Comment</label>
                  <textarea name="review[comment]" class="form-control" rows="3" required></textarea>
                </div>
                <button class="btn btn-primary btn-sm" type="submit">Submit Review</button>
              </form>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Map Initialization Script -->
<script>
  const dhabaData = JSON.parse(document.getElementById('dhaba-data').textContent);
  const mapToken = '<%= mapToken %>';

  // Booking functionality
  const bookingForm = document.getElementById("booking-form");
  const startDateInput = document.getElementById("startDate");
  const endDateInput = document.getElementById("endDate");
  const totalPriceInput = document.getElementById("totalPrice");
  const guestsInput = document.getElementById("guests");
  const availabilityStatus = document.getElementById("availability-status");
  const pricePerNight = dhabaData.price;

  function updateTotalPrice() {
    const startDate = new Date(startDateInput.value);
    const endDate = new Date(endDateInput.value);
    const guests = Math.max(1, Number(guestsInput.value || 1));
    if (startDate && endDate && endDate > startDate) {
      const nights = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
      totalPriceInput.textContent = (nights * pricePerNight * guests).toLocaleString("en-IN");
    } else {
      totalPriceInput.textContent = (pricePerNight * guests).toLocaleString("en-IN");
    }
  }

  async function checkAvailability(){
    availabilityStatus.textContent = "";
    const startDate = startDateInput.value;
    const endDate = endDateInput.value;
    if(!startDate || !endDate) return;
    try{
      const res = await fetch(`/bookings/${dhabaData._id}/availability`,{
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ startDate, endDate })
      });
      const data = await res.json();
      if(data.available){
        availabilityStatus.textContent = "Available";
        availabilityStatus.className = "text-success small ms-3";
      } else {
        availabilityStatus.textContent = data.error || "Unavailable";
        availabilityStatus.className = "text-danger small ms-3";
      }
    } catch(err){ console.error(err); }
  }

  const today = new Date().toISOString().split('T')[0];
  if (startDateInput) startDateInput.min = today;
  if (endDateInput) endDateInput.min = today;

  if(startDateInput && endDateInput){
    startDateInput.addEventListener("change", ()=>{ updateTotalPrice(); checkAvailability(); });
    endDateInput.addEventListener("change", ()=>{ updateTotalPrice(); checkAvailability(); });
  }
  if(guestsInput){ guestsInput.addEventListener("input", updateTotalPrice); }

  if (bookingForm) {
    bookingForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const startDate = startDateInput.value;
      const endDate = endDateInput.value;
      const guests = Math.max(1, Number(guestsInput.value || 1));
      if (!startDate || !endDate || new Date(endDate) <= new Date(startDate)) {
        alert("Please select valid dates!");
        return;
      }

      try {
        const res = await fetch(`/bookings/${dhabaData._id}/book`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ startDate, endDate, guests }),
          credentials: "same-origin"
        });
        const data = await res.json();
        if(data.error){ alert(data.error); return; }
        window.location.href = data.sessionUrl;
      } catch(err){
        console.error(err);
        alert("Something went wrong!");
      }
    });
  }

  if (mapToken && dhabaData.geometry && dhabaData.geometry.coordinates) {
    mapboxgl.accessToken = mapToken;
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v12',
      center: dhabaData.geometry.coordinates,
      zoom: 13
    });

    // Add marker
    new mapboxgl.Marker()
      .setLngLat(dhabaData.geometry.coordinates)
      .addTo(map);

    // Disable zoom and rotation
    map.scrollZoom.disable();
    map.dragPan.disable();
  }
</script>

</body>
