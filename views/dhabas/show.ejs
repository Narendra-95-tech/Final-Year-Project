<% layout("/layouts/boilerplate") -%>

  <!-- Link CSS Files -->
  <link rel="stylesheet" href="/css/listing-details.css">
  <link rel="stylesheet" href="/css/dhabas.css">
  <link rel="stylesheet" href="/css/map-premium.css">
  <!-- Flatpickr CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    /* Custom Flatpickr Visibility Improvements */
    .flatpickr-day {
      color: #222 !important;
      font-weight: 600 !important;
      font-size: 15px !important;
    }

    .flatpickr-day.flatpickr-disabled,
    .flatpickr-day.flatpickr-disabled:hover {
      color: #d1d5db !important;
      background-color: transparent !important;
      border-color: transparent !important;
      opacity: 1 !important;
      cursor: not-allowed;
      text-decoration: none !important;
    }

    .flatpickr-day.prevMonthDay,
    .flatpickr-day.nextMonthDay {
      color: #e5e7eb !important;
    }

    .flatpickr-weekday {
      color: #1a1a1a !important;
      font-weight: 700 !important;
    }

    .flatpickr-calendar {
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      border: none;
      padding: 10px;
    }

    .flatpickr-day.selected {
      background: #fe6b00 !important;
      border-color: #fe6b00 !important;
    }

    /* Premium Date Input Styling */
    .date-input-premium {
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 10px;
      width: 100%;
      font-weight: 500;
      cursor: pointer;
      background-color: #fff;
    }
  </style>
  <script src="/js/wishlist-handler.js"></script>
  <!-- Flatpickr JS -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <body class="listing-details-page">

    <!-- Sticky Scroll Header -->
    <div id="sticky-header" class="sticky-header">
      <div class="sticky-header-content">
        <div class="sticky-header-left">
          <span class="sticky-header-title">
            <%= dhaba.title %>
          </span>
          <span class="sticky-header-rating">
            <i class="fas fa-star"></i>
            <%= dhaba.rating || 'New' %>
          </span>
        </div>
        <div class="sticky-header-right">
          <button class="sticky-reserve-btn"
            onclick="document.querySelector('.card.sticky-top').scrollIntoView({behavior: 'smooth'})">
            Reserve
          </button>
        </div>
      </div>
    </div>
    <script>
      window.addEventListener('scroll', () => {
        const header = document.getElementById('sticky-header');
        if (window.scrollY > 400) {
          header.classList.add('visible');
        } else {
          header.classList.remove('visible');
        }
      });
    </script>

    <!-- Dynamic Image Gallery -->
    <div id="image-gallery-container"></div>

    <!-- Header Section -->
    <div class="container mt-4">
      <div class="row mb-4 animate-fade-up">
        <div class="col-12 d-flex justify-content-between align-items-center">
          <div>
            <h1 class="fw-bold mb-2">
              <%= dhaba.title %>
            </h1>
            <div class="d-flex align-items-center gap-3 text-muted">
              <span><i class="fas fa-map-marker-alt me-1"></i>
                <%= dhaba.location %>, <%= dhaba.country %>
              </span>
              <span>‚Ä¢</span>
              <span class="text-warning"><i class="fas fa-star"></i>
                <%= dhaba.rating || 'New' %>
              </span>
              <span>‚Ä¢</span>
              <span class="badge bg-success-subtle text-success">
                <%= dhaba.category %>
              </span>
            </div>
          </div>

          <div class="header-actions">
            <% const isWishlisted=currUser && currUser.wishlistDhabas && currUser.wishlistDhabas.some(id=> id.toString()
              === dhaba._id.toString()); %>
              <%- include('../partials/socialShare', { itemId: dhaba._id, isWishlisted, itemType: 'dhaba' ,
                iconClass: 'fas fa-share-alt' , btnClass: 'action-btn' , currentUrl: `https://${process.env.HOST
                || 'localhost:3000' }/dhabas/${dhaba._id}`, shareText: `Check out '${dhaba.title}' on WanderLust`,
                shareSubject: `Check out '${dhaba.title}' on WanderLust` }) %>
          </div>
        </div>
      </div>

      <div class="row">
        <!-- Left Column -->
        <div class="col-lg-8 animate-fade-up" style="animation-delay: 0.2s;">

          <!-- Description & Host -->
          <div class="mb-5 border-bottom pb-4">
            <h4 class="fw-bold mb-3">About this place</h4>
            <p class="text-muted">
              <%= dhaba.description || "Experience authentic flavors at " + dhaba.title
                + ". We prefer fresh ingredients and traditional cooking methods." %>
            </p>

            <!-- Host Info Row -->
            <div class="host-info-row border-bottom pb-4 mb-4">
              <img src="https://ui-avatars.com/api/?name=<%= dhaba.owner.username %>&background=random"
                class="host-avatar-large" alt="<%= dhaba.owner.username %>">
              <div class="host-text">
                <div class="host-name">Hosted by <%= dhaba.owner.username %>
                    <% if(dhaba.owner.isVerified) { %>
                      <i class="fas fa-shield-check text-info ms-1" style="font-size: 16px;"></i>
                      <% } %>
                </div>
                <div class="host-badge">
                  <%= dhaba.owner.isVerified ? 'Verified Explorer' : 'Superhost' %> ¬∑ Joined in <%= new
                      Date(dhaba.owner.createdAt).getFullYear() %>
                </div>
              </div>
            </div>

            <!-- Property Highlights -->
            <div class="property-highlights-list border-bottom pb-4 mb-4">
              <div class="highlight-list-item">
                <div class="highlight-icon"><i class="fas fa-map-marker-alt"></i></div>
                <div class="highlight-content">
                  <div class="highlight-title">Great location</div>
                  <div class="highlight-sub">100% of recent guests gave the location a 5-star rating.</div>
                </div>
              </div>
              <div class="highlight-list-item">
                <div class="highlight-icon"><i class="fas fa-utensils"></i></div>
                <div class="highlight-content">
                  <div class="highlight-title">Authentic Cuisine</div>
                  <div class="highlight-sub">Experience the true taste of local flavors.</div>
                </div>
              </div>
              <div class="highlight-list-item">
                <div class="highlight-icon"><i class="fas fa-parking"></i></div>
                <div class="highlight-content">
                  <div class="highlight-title">Free parking</div>
                  <div class="highlight-sub">Guests can park their vehicles for free.</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Amenities Section -->
          <% if (dhaba.amenities && dhaba.amenities.length> 0) { %>
            <div class="amenities-section mb-5">
              <h4 class="fw-bold mb-4">What this place offers</h4>
              <div class="amenities-grid">
                <% dhaba.amenities.slice(0, 6).forEach(amenity=> { %>
                  <div class="amenity-item">
                    <div class="amenity-icon"><i class="fas fa-check-circle"></i></div>
                    <span>
                      <%= amenity %>
                    </span>
                  </div>
                  <% }); %>
              </div>
              <% if (dhaba.amenities.length> 6) { %>
                <button class="show-all-amenities-btn">
                  Show all <%= dhaba.amenities.length %> amenities
                </button>
                <% } %>
            </div>
            <% } %>

              <!-- Signature Dishes -->
              <div class="signature-dishes mb-5 animate-fade-up">
                <div class="signature-header">
                  <h3 class="signature-title">üî• Signature Dishes</h3>
                  <p class="signature-subtitle">Must-try specials recommended by the chef</p>
                </div>
                <div class="signature-grid">
                  <!-- Dish 1 -->
                  <div class="signature-card">
                    <div class="badge-recommended"><i class="fas fa-crown"></i> Bestseller</div>
                    <span class="signature-badge badge-nonveg">Non-Veg</span>
                    <div class="signature-image-wrapper">
                      <img src="https://images.unsplash.com/photo-1588166524941-3bf61a9c41db?q=80&w=800"
                        class="signature-image" alt="Butter Chicken">
                    </div>
                    <div class="signature-info">
                      <div class="signature-name">Butter Chicken</div>
                      <div class="signature-price-row">
                        <div class="signature-price">‚Çπ350</div>
                        <button class="add-to-cart-btn" title="Add to cart">
                          <i class="fas fa-plus"></i>
                        </button>
                      </div>
                    </div>
                  </div>

                  <!-- Dish 2 -->
                  <div class="signature-card">
                    <span class="signature-badge badge-veg">Veg</span>
                    <div class="signature-image-wrapper">
                      <img src="https://images.unsplash.com/photo-1546833999-b9f581a1996d?q=80&w=800"
                        class="signature-image" alt="Dal Makhani">
                    </div>
                    <div class="signature-info">
                      <div class="signature-name">Dal Makhani</div>
                      <div class="signature-price-row">
                        <div class="signature-price">‚Çπ280</div>
                        <button class="add-to-cart-btn" title="Add to cart">
                          <i class="fas fa-plus"></i>
                        </button>
                      </div>
                    </div>
                  </div>

                  <!-- Dish 3 -->
                  <div class="signature-card">
                    <span class="signature-badge badge-veg">Veg</span>
                    <div class="signature-image-wrapper">
                      <img src="https://images.unsplash.com/photo-1599487488170-d11ec9c172f0?q=80&w=800"
                        class="signature-image" alt="Paneer Tikka">
                    </div>
                    <div class="signature-info">
                      <div class="signature-name">Paneer Tikka</div>
                      <div class="signature-price-row">
                        <div class="signature-price">‚Çπ220</div>
                        <button class="add-to-cart-btn" title="Add to cart">
                          <i class="fas fa-plus"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Menu Highlights -->
              <div class="menu-section mb-5 animate-fade-up">
                <div class="menu-header">
                  <h3 class="menu-title">Menu Highlights</h3>
                  <div class="menu-categories d-flex gap-2">
                    <button class="menu-category-btn active" data-category="breads">Breads</button>
                    <button class="menu-category-btn" data-category="curries">Curries</button>
                    <button class="menu-category-btn" data-category="rice">Rice</button>
                  </div>
                </div>

                <!-- Breads Category -->
                <div class="category-content active" id="breads-content">
                  <div class="menu-items-grid">
                    <div class="menu-item-card">
                      <img src="/images/food/garlic_naan.png" class="menu-item-image" alt="Garlic Naan">
                      <div class="menu-item-info">
                        <div class="menu-item-name">Garlic Naan</div>
                        <div class="menu-item-description">Soft leavened bread with garlic and butter.</div>
                        <div class="menu-item-footer">
                          <span class="menu-item-price">‚Çπ60</span>
                          <button class="menu-item-add-btn"><i class="fas fa-plus me-1"></i> Add</button>
                        </div>
                      </div>
                    </div>
                    <div class="menu-item-card">
                      <img src="/images/food/tandoori_roti.png" class="menu-item-image" alt="Tandoori Roti">
                      <div class="menu-item-info">
                        <div class="menu-item-name">Tandoori Roti</div>
                        <div class="menu-item-description">Whole wheat bread baked in clay oven.</div>
                        <div class="menu-item-footer">
                          <span class="menu-item-price">‚Çπ30</span>
                          <button class="menu-item-add-btn"><i class="fas fa-plus me-1"></i> Add</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Curries Category -->
                <div class="category-content" id="curries-content">
                  <div class="menu-items-grid">
                    <div class="menu-item-card">
                      <img src="https://images.unsplash.com/photo-1567188040759-fb8a883dc6d8?q=80&w=400"
                        class="menu-item-image" alt="Kadhai Paneer">
                      <div class="menu-item-info">
                        <div class="menu-item-name">Kadhai Paneer</div>
                        <div class="menu-item-description">Paneer cubes with bell peppers and spices.</div>
                        <div class="menu-item-footer">
                          <span class="menu-item-price">‚Çπ240</span>
                          <button class="menu-item-add-btn"><i class="fas fa-plus me-1"></i> Add</button>
                        </div>
                      </div>
                    </div>
                    <div class="menu-item-card">
                      <img src="https://images.unsplash.com/photo-1546833999-b9f581a1996d?q=80&w=400"
                        class="menu-item-image" alt="Mix Veg">
                      <div class="menu-item-info">
                        <div class="menu-item-name">Mix Veg</div>
                        <div class="menu-item-description">Assorted garden vegetables in a rich gravy.</div>
                        <div class="menu-item-footer">
                          <span class="menu-item-price">‚Çπ180</span>
                          <button class="menu-item-add-btn"><i class="fas fa-plus me-1"></i> Add</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Rice Category -->
                <div class="category-content" id="rice-content">
                  <div class="menu-items-grid">
                    <div class="menu-item-card">
                      <img src="https://images.unsplash.com/photo-1589302168068-964664d93dc0?q=80&w=400"
                        class="menu-item-image" alt="Veg Biryani">
                      <div class="menu-item-info">
                        <div class="menu-item-name">Veg Biryani</div>
                        <div class="menu-item-description">Fragrant basmati rice with spices and veggies.</div>
                        <div class="menu-item-footer">
                          <span class="menu-item-price">‚Çπ200</span>
                          <button class="menu-item-add-btn"><i class="fas fa-plus me-1"></i> Add</button>
                        </div>
                      </div>
                    </div>
                    <div class="menu-item-card">
                      <img src="https://cdn.pixabay.com/photo/2017/06/16/11/38/breakfast-2408818_640.jpg"
                        class="menu-item-image" alt="Jeera Rice"
                        onerror="this.src='https://via.placeholder.com/400x300/FFE4B5/8B4513?text=Jeera+Rice'">
                      <div class="menu-item-info">
                        <div class="menu-item-name">Jeera Rice</div>
                        <div class="menu-item-description">Basmati rice saut√©ed with cumin seeds.</div>
                        <div class="menu-item-footer">
                          <span class="menu-item-price">‚Çπ120</span>
                          <button class="menu-item-add-btn"><i class="fas fa-plus me-1"></i> Add</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Menu Tab Switch Script -->
              <script>
                document.querySelectorAll('.menu-category-btn').forEach(btn => {
                  btn.addEventListener('click', () => {
                    // Update active button
                    document.querySelectorAll('.menu-category-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    // Show corresponding content
                    const category = btn.getAttribute('data-category');
                    document.querySelectorAll('.category-content').forEach(content => {
                      content.classList.remove('active');
                      if (content.id === category + '-content') {
                        content.classList.add('active');
                      }
                    });
                  });
                });
              </script>



              <!-- Quick Info Cards -->
              <div class="row g-3 mb-4">
                <!-- Basic Info -->
                <div class="col-md-6">
                  <div class="card h-100 border-0 shadow-sm">
                    <div class="card-header bg-primary text-white">
                      <h6 class="mb-0">üìã Basic Information</h6>
                    </div>
                    <div class="card-body">
                      <div class="row g-2">
                        <div class="col-6"><strong>Category:</strong></div>
                        <div class="col-6">
                          <%= dhaba.category %>
                        </div>
                        <div class="col-6"><strong>Cuisine:</strong></div>
                        <div class="col-6">
                          <%= dhaba.cuisine %>
                        </div>
                        <div class="col-6"><strong>Location:</strong></div>
                        <div class="col-6">
                          <%= dhaba.location %>, <%= dhaba.country %>
                        </div>
                        <div class="col-6"><strong>Price:</strong></div>
                        <div class="col-6">‚Çπ<%= dhaba.price ? Number(dhaba.price).toLocaleString("en-IN") : "N/A" %>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Rating & Features -->
                <div class="col-md-6">
                  <div class="card h-100 border-0 shadow-sm">
                    <div class="card-header bg-success text-white">
                      <h6 class="mb-0">‚≠ê Rating & Features</h6>
                    </div>
                    <div class="card-body text-center">
                      <div class="display-4 text-warning mb-2">
                        <%= dhaba.rating || 4.0 %>
                      </div>
                      <div class="mb-3">
                        <% for (let i=1; i <=5; i++) { %>
                          <i class="fa fa-star <%= i <= (dhaba.rating || 4) ? 'text-warning' : 'text-muted' %>"></i>
                          <% } %>
                      </div>
                      <p class="text-muted">Based on customer reviews</p>
                    </div>
                  </div>
                </div>
              </div>

        </div>

        <!-- Right Column - Actions -->
        <div class="col-lg-4 animate-fade-up" style="animation-delay: 0.4s;">
          <!-- Dhaba Availability Calendar -->
          <div class="card mb-4 border-0 shadow-sm overflow-hidden" style="border-radius: 16px;">
            <div class="card-body p-0">
              <div id="wanderlust-dhaba-calendar" style="min-height: 380px;"></div>
            </div>
          </div>

          <!-- Booking Card -->
          <% if (currUser && (!dhaba.owner || !dhaba.owner.equals(currUser._id))) { %>
            <div class="card mb-4 border-0 shadow-lg sticky-top" style="top: 100px; border-radius: 16px;">
              <div
                class="card-header bg-gradient bg-success text-white d-flex justify-content-between align-items-center p-3">
                <h6 class="mb-0 fw-bold">Reserve a Table</h6>
                <span class="badge bg-white text-success fs-6">‚Çπ<%= dhaba.price ?
                    Number(dhaba.price).toLocaleString("en-IN") : "N/A" %> / guest</span>
              </div>
              <div class="card-body p-4">
                <p class="text-muted small mb-3">Secured online payment powered by Stripe. Cancel anytime before
                  the
                  booking slot.</p>
                <button class="btn btn-success w-100 py-3 fw-bold shadow-sm" data-bs-toggle="modal"
                  data-bs-target="#dhabaBookingModal">
                  <i class="fa fa-calendar-check me-2"></i>Book Now
                </button>
              </div>
            </div>
            <% } %>

              <!-- Owner Actions -->
              <% if (currUser && dhaba.owner && dhaba.owner.equals(currUser._id)) { %>
                <div class="card mb-4 border-0 shadow-sm">
                  <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">‚öôÔ∏è Owner Actions</h6>
                  </div>
                  <div class="card-body">
                    <a class="btn btn-outline-primary btn-sm mb-2 w-100" href="/dhabas/<%= dhaba._id %>/edit">
                      <i class="fa fa-edit"></i> Edit Dhaba
                    </a>
                    <form method="POST" action="/dhabas/<%= dhaba._id %>?_method=DELETE" class="d-inline">
                      <button class="btn btn-outline-danger btn-sm w-100" type="submit">
                        <i class="fa fa-trash"></i> Delete Dhaba
                      </button>
                    </form>
                  </div>
                </div>
                <% } %>
        </div>
      </div>

      <!-- Reviews Section -->
      <div class="row mt-5 animate-fade-up" style="animation-delay: 0.6s;">
        <div class="col-12">
          <% if(currUser) { %>
            <div class="review-form-card">
              <h4 class="review-form-title">Leave a Review</h4>
              <form action="/dhabas/<%= dhaba._id %>/reviews" method="POST" novalidate class="needs-validation"
                enctype="multipart/form-data">

                <div class="mb-4">
                  <label class="form-label-premium">Rate your experience</label>
                  <fieldset class="starability-slot">
                    <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="1" checked
                      aria-label="No rating." />
                    <input type="radio" id="first-rate1" name="review[rating]" value="1" />
                    <label for="first-rate1" title="Terrible"><i class="fas fa-star"></i></label>
                    <input type="radio" id="first-rate2" name="review[rating]" value="2" />
                    <label for="first-rate2" title="Not good"><i class="fas fa-star"></i></label>
                    <input type="radio" id="first-rate3" name="review[rating]" value="3" />
                    <label for="first-rate3" title="Average"><i class="fas fa-star"></i></label>
                    <input type="radio" id="first-rate4" name="review[rating]" value="4" />
                    <label for="first-rate4" title="Very good"><i class="fas fa-star"></i></label>
                    <input type="radio" id="first-rate5" name="review[rating]" value="5" />
                    <label for="first-rate5" title="Amazing"><i class="fas fa-star"></i></label>
                  </fieldset>
                </div>

                <div class="mb-4">
                  <label for="comment" class="form-label-premium">Your Feedback</label>
                  <textarea name="review[comment]" id="comment" cols="30" rows="4"
                    class="form-control form-control-premium"
                    placeholder="Share details about your dining experience and favorite dishes..." required></textarea>
                  <div class="invalid-feedback">Please add some comments for review</div>
                </div>

                <div class="mb-4">
                  <label for="images" class="form-label-premium">Add Photos</label>
                  <input type="file" name="review[images]" id="images" class="form-control form-control-premium"
                    multiple>
                </div>

                <button class="btn-submit-review">
                  Submit Review <i class="fas fa-paper-plane"></i>
                </button>
              </form>
            </div>
            <hr class="section-divider">
            <% } %>

              <% if(dhaba.reviews.length> 0) { %>
                <div class="row">
                  <p><b>All Reviews</b></p>
                  <% for(review of dhaba.reviews) { %>
                    <div class="card col-5 mb-3 ms-3">
                      <div class="card-body">
                        <h5 class="card-title mb-1">
                          @<%= review.author.username %>
                            <% if(review.isVerified) { %>
                              <i class="fas fa-shield-check text-success ms-1" title="Verified Diner"></i>
                              <span class="text-success small ms-1" style="font-weight: 600;">Verified</span>
                              <% } %>
                        </h5>
                        <p class="text-muted small mb-2">
                          <%= review.createdAt ? review.createdAt.toLocaleDateString('en-US', { month: 'short' ,
                            year: 'numeric' }) : 'Recently' %>
                        </p>
                        <p class="starability-result card-text" data-rating="<%= review.rating%>"></p>
                        <p class="card-text">
                          <%= review.comment %>
                        </p>
                        <% if(review.images && review.images.length> 0) { %>
                          <div class="review-images mt-2 d-flex flex-wrap gap-2">
                            <% review.images.forEach(img=> { %>
                              <img src="<%= img.url %>" class="rounded"
                                style="width: 80px; height: 80px; object-fit: cover;"
                                onclick="window.open('<%= img.url %>', '_blank')">
                              <% }) %>
                          </div>
                          <% } %>
                      </div>
                      <% if(currUser && review.author._id.equals(currUser._id)) { %>
                        <form class="mb-3" method="POST"
                          action="/dhabas/<%=dhaba._id %>/reviews/<%= review._id %>?_method=DELETE">
                          <button class="btn btn-sm btn-dark">Delete</button>
                        </form>
                        <% } %>
                    </div>
                    <% } %>
                </div>
                <% } %>
        </div>
      </div>

      <!-- Map Section -->
      <div class="col-8 offset-2 mb-3 mt-4 animate-fade-up" style="animation-delay: 0.8s;">
        <h3>Where you'll be</h3>
        <div id="map" class="map-container d-flex align-items-center justify-content-center bg-light"
          style="min-height: 400px;">
          <div class="text-center text-muted">
            <i class="fas fa-map-marked-alt fa-3x mb-3 text-secondary"></i>
            <h5 class="fw-bold">Map Visualization</h5>
            <p class="small mb-0">Map will appear here when <code class="text-dark">MAP_TOKEN</code> is
              configured.</p>
          </div>
        </div>
      </div>



    </div>

    <!-- Booking Modal -->
    <div class="modal fade" id="dhabaBookingModal" tabindex="-1" aria-labelledby="dhabaBookingLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="dhabaBookingLabel">Reserve a table at <%= dhaba.title %>
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <% if (!currUser) { %>
              <div class="alert alert-warning mb-0">
                Please <a href="/login" class="alert-link">log in</a> to make a reservation.
              </div>
              <% } else { %>
                <form id="dhaba-booking-form">
                  <div class="row g-3">
                    <div class="col-12">
                      <label for="booking-date" class="form-label">Date</label>
                      <input type="text" id="booking-date" name="date" class="date-input-premium"
                        placeholder="Select Date" required readonly>
                    </div>
                    <div class="col-12">
                      <label for="booking-time" class="form-label">Preferred Time</label>
                      <input type="time" id="booking-time" name="time" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                      <label for="booking-guests" class="form-label">Number of Guests</label>
                      <input type="number" id="booking-guests" name="guests" class="form-control" min="1" max="20"
                        value="2" required>
                    </div>
                    <div class="col-12">
                      <label for="booking-message" class="form-label">Special Requests <span
                          class="text-muted small">(optional)</span></label>
                      <textarea id="booking-message" name="message" class="form-control" rows="3"
                        placeholder="Allergies, celebrations, seating preference..."></textarea>
                    </div>
                  </div>
                  <div class="mt-3 p-3 bg-light rounded border">
                    <div class="d-flex justify-content-between">
                      <span class="fw-semibold">Estimated Amount</span>
                      <span id="booking-amount" class="fw-bold">‚Çπ<%= dhaba.price ?
                          Number(dhaba.price).toLocaleString("en-IN") : "0" %></span>
                    </div>
                    <small class="text-muted d-block mt-1">‚Çπ<%= dhaba.price ?
                        Number(dhaba.price).toLocaleString("en-IN") : "N/A" %> per guest ¬∑ Secure payment via
                        Stripe</small>
                  </div>
                  <div class="mt-3">
                    <div class="alert alert-danger d-none" id="booking-error"></div>
                    <div class="alert alert-success d-none" id="booking-success"></div>
                  </div>
                  <div class="modal-footer px-0">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success" id="booking-submit-btn">
                      <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"
                        id="booking-spinner"></span>
                      Proceed to Payment
                    </button>
                  </div>
                </form>
                <% } %>
          </div>
        </div>
      </div>
    </div>

    <!-- Initialize WanderLust Calendar -->
    <script src="/js/wanderlust-calendar.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const dhabaCalendar = new WanderLustCalendar('wanderlust-dhaba-calendar', {
          showHeader: true,
          showWeekdays: true,
          showToday: true,
          showClearBtn: true,
          minDate: new Date(),
          maxDate: (() => {
            const date = new Date();
            date.setMonth(date.getMonth() + 3);
            return date;
          })(),
          initialDate: new Date(),
          theme: {
            primary: '#FF6B6B',
            secondary: '#FF9E7D',
            accent: '#FFD166',
            background: 'rgba(255, 255, 255, 0.9)',
            text: '#2D3436',
            lightText: '#636E72',
            border: 'rgba(0, 0, 0, 0.08)'
          },
          onDateSelect: function (date) {
            const dateInput = document.getElementById('booking-date');
            if (dateInput) {
              const formattedDate = date.toISOString().split('T')[0];
              dateInput.value = formattedDate;
              dateInput.dispatchEvent(new Event('change'));
            }
          },
          onMonthChange: async function (month, year) {
            // Mock busy dates
            const unavailableDates = [
              ...Array.from({ length: 3 }, (_, i) => {
                const date = new Date();
                date.setDate(date.getDate() + Math.floor(Math.random() * 14) + 1);
                return date;
              })
            ];
            unavailableDates.forEach(date => {
              dhabaCalendar.markUnavailable(date);
            });
          }
        });
        dhabaCalendar.markToday();
      });
    </script>

    <!-- Dhaba Data and Map Scripts -->
    <script type="application/json" id="dhaba-data"><%- JSON.stringify(dhaba) %></script>
    <script>
      const mapToken = "<%= mapToken %>";
      const dhabaTokenData = document.getElementById('dhaba-data');
      const dhabaData = dhabaTokenData ? JSON.parse(dhabaTokenData.textContent) : null;
    </script>

    <script src="/js/image-gallery.js"></script>
    <!-- Map Initialization -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // 1. Check Data Availability
        if (!dhabaData || !dhabaData.geometry || !dhabaData.geometry.coordinates) {
          const mapContainer = document.getElementById("map");
          if (mapContainer) mapContainer.innerHTML = "<p class='text-center mt-5 text-muted'>Location coordinates not available for this Dhaba.</p>";
          return;
        }

        const dhabaCoords = dhabaData.geometry.coordinates;
        const mapContainer = document.getElementById("map");

        // 2. Initialize Enhanced Map
        // Ensure tokens are present
        if (typeof mapToken === 'undefined' || !mapToken) {
          console.error("Mapbox Token is missing.");
          return;
        }

        // Initialize Image Gallery
        const dhabaImages = dhabaData.image && dhabaData.image.length > 0
          ? dhabaData.image
          : [{ url: 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4', caption: dhabaData.title }];

        new ImageGallery('image-gallery-container', dhabaImages);

        // CLEAR PLACEHOLDER CONTENT and RESET CLASSES
        if (mapContainer) {
          mapContainer.innerHTML = ''; // Remove "Map Visualization" placeholder
          mapContainer.className = 'map-container'; // Remove flex/centering classes that might mess up map layout
          // Ensure it has dimensions (css handles this, but good to ensure)
        }

        const enhancedMap = new EnhancedMap('map', {
          mapToken: mapToken,
          center: dhabaCoords,
          zoom: 14,
          searchEnabled: true,
          clusterEnabled: false,
          mapStyle: 'mapbox://styles/mapbox/streets-v12',
          showControls: true
        });

        // 3. Add Custom Markers
        // Create custom element for Dhaba
        const markerEl = document.createElement('div');
        markerEl.className = 'dhaba-custom-marker';
        markerEl.innerHTML = '<i class="fas fa-utensils"></i>';

        // Inline styles to ensure visibility even if CSS file has loading issues
        Object.assign(markerEl.style, {
          width: '48px',
          height: '48px',
          backgroundColor: '#ffffff',
          borderRadius: '50%',
          display: 'flex',
          justifyContent: 'center',
          alignItems: 'center',
          boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
          color: '#ff385c', // Brand color
          fontSize: '20px',
          border: '2px solid #ff385c',
          cursor: 'pointer',
          zIndex: '10'
        });

        // Add Marker to Map
        enhancedMap.addMarker('dhaba', dhabaCoords, {
          customElement: markerEl,
          title: dhabaData.title,
          description: `<div style="padding:4px;">
                          <h6 style="margin:0; font-weight:700;">${dhabaData.title}</h6>
                          <span style="color:#717171; font-size:12px;">${dhabaData.cuisine}</span><br>
                          <span style="color:#ff385c; font-weight:600; font-size:12px;">‚òÖ ${dhabaData.rating || 'New'}</span>
                        </div>`,
          popup: true,
          offset: [0, -20]
        });

        // 4. (Opional) Mock Route & User Location for "Premium" Demo Feel
        // In production, use navigator.geolocation
        /*
        const userLat = 19.85; 
        const userLng = 75.93;
        const userCoords = [userLng, userLat];
        
        const userEl = document.createElement('div');
        userEl.className = 'user-location-pulse';
        userEl.innerHTML = '<div class="pulse-ring"></div><div class="user-dot"></div>';
        
        enhancedMap.addMarker('user', userCoords, {
             customElement: userEl,
             title: "Your Location"
        });
 
        setTimeout(() => {
             enhancedMap.addRoute('route-demo', [userCoords, dhabaCoords], {
                 color: '#ff385c',
                 width: 5,
                 animate: true
             });
        }, 1500);
        */
      });
    </script>

    <!-- Booking Form Script -->
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const bookingForm = document.getElementById("dhaba-booking-form");
        if (!bookingForm) return;

        const guestsInput = document.getElementById("booking-guests");
        const amountDisplay = document.getElementById("booking-amount");
        const errorBox = document.getElementById("booking-error");
        const successBox = document.getElementById("booking-success");
        const submitBtn = document.getElementById("booking-submit-btn");
        const spinner = document.getElementById("booking-spinner");
        const dateInput = document.getElementById("booking-date");
        const timeInput = document.getElementById("booking-time");
        const messageInput = document.getElementById("booking-message");

        const perGuestPrice = parseFloat('<%= dhaba.price || 0 %>') || 0;

        if (dateInput) {
          flatpickr(dateInput, {
            minDate: "today",
            dateFormat: "Y-m-d",
            altInput: true,
            altFormat: "D, d M",
            disableMobile: "true",
            onChange: function (selectedDates, dateStr, instance) {
              dateInput.dispatchEvent(new Event('change'));
            }
          });
        }

        const updateAmount = () => {
          if (!amountDisplay) return;
          const guests = Math.max(1, Number(guestsInput?.value || 1));
          const total = perGuestPrice * guests;
          amountDisplay.textContent = `‚Çπ${total.toLocaleString("en-IN")}`;
        };

        if (guestsInput) guestsInput.addEventListener("input", updateAmount);
        updateAmount();

        const setFeedback = (type, message) => {
          if (!errorBox || !successBox) return;
          errorBox.classList.add("d-none");
          successBox.classList.add("d-none");
          if (type === "error") {
            errorBox.textContent = message;
            errorBox.classList.remove("d-none");
          } else if (type === "success") {
            successBox.textContent = message;
            successBox.classList.remove("d-none");
          }
        };

        const setLoading = (loading) => {
          if (!submitBtn || !spinner) return;
          submitBtn.disabled = loading;
          spinner.classList.toggle("d-none", !loading);
        };

        bookingForm.addEventListener("submit", async (event) => {
          event.preventDefault();

          const date = dateInput?.value;
          const time = timeInput?.value;
          const guests = Math.max(1, Number(guestsInput?.value || 1));
          const message = messageInput?.value || "";

          if (!date || !time) {
            setFeedback("error", "Please select date and time.");
            return;
          }

          setFeedback();
          setLoading(true);

          try {
            const availabilityRes = await fetch(`/bookings/dhabas/<%= dhaba._id %>/availability`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ date, time })
            });
            const availability = await availabilityRes.json();
            if (!availability.available) {
              setFeedback("error", availability.error || "Selected slot is no longer available.");
              return;
            }

            const bookingRes = await fetch(`/bookings/dhabas/<%= dhaba._id %>/book`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: 'same-origin',
              body: JSON.stringify({ date, time, guests, message })
            });

            const bookingPayload = await bookingRes.json();
            if (!bookingRes.ok) {
              setFeedback("error", bookingPayload.error || "Booking failed. Try again.");
              return;
            }

            // Redirect to Confirm and Pay page
            setFeedback("success", "Booking initiated. Redirecting to payment options...");
            window.location.href = `/bookings/${bookingPayload.bookingId}/confirm`;
          } catch (err) {
            console.error(err);
            setFeedback("error", "Unexpected error while booking. Please retry.");
          } finally {
            setLoading(false);
          }
        });
      });
    </script>
  </body>