<% layout("/layouts/boilerplate") -%>

<!-- Mapbox CSS & JS -->
<link href="https://api.mapbox.com/mapbox-gl-js/v2.20.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v2.20.0/mapbox-gl.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const bookingForm = document.getElementById("dhaba-booking-form");
    if (!bookingForm) return;

    const guestsInput = document.getElementById("booking-guests");
    const amountDisplay = document.getElementById("booking-amount");
    const errorBox = document.getElementById("booking-error");
    const successBox = document.getElementById("booking-success");
    const submitBtn = document.getElementById("booking-submit-btn");
    const spinner = document.getElementById("booking-spinner");
    const dateInput = document.getElementById("booking-date");
    const timeInput = document.getElementById("booking-time");
    const messageInput = document.getElementById("booking-message");

    const perGuestPrice = parseFloat('<%= dhaba.price || 0 %>') || 0;

    if (dateInput) {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      dateInput.min = `${yyyy}-${mm}-${dd}`;
    }

    const updateAmount = () => {
      if (!amountDisplay) return;
      const guests = Math.max(1, Number(guestsInput?.value || 1));
      const total = perGuestPrice * guests;
      amountDisplay.textContent = `‚Çπ${total.toLocaleString("en-IN")}`;
    };

    guestsInput?.addEventListener("input", updateAmount);
    updateAmount();

    const setFeedback = (type, message) => {
      if (!errorBox || !successBox) return;
      errorBox.classList.add("d-none");
      successBox.classList.add("d-none");
      if (type === "error") {
        errorBox.textContent = message;
        errorBox.classList.remove("d-none");
      } else if (type === "success") {
        successBox.textContent = message;
        successBox.classList.remove("d-none");
      }
    };

    const setLoading = (loading) => {
      if (!submitBtn || !spinner) return;
      submitBtn.disabled = loading;
      spinner.classList.toggle("d-none", !loading);
    };

    bookingForm.addEventListener("submit", async (event) => {
      event.preventDefault();

      const date = dateInput?.value;
      const time = timeInput?.value;
      const guests = Math.max(1, Number(guestsInput?.value || 1));
      const message = messageInput?.value || "";

      if (!date || !time) {
        setFeedback("error", "Please select date and time.");
        return;
      }

      setFeedback();
      setLoading(true);

      try {
        const availabilityRes = await fetch(`/bookings/dhabas/<%= dhaba._id %>/availability`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ date, time })
        });
        const availability = await availabilityRes.json();
        if (!availability.available) {
          setFeedback("error", availability.error || "Selected slot is no longer available.");
          return;
        }

        const bookingRes = await fetch(`/bookings/dhabas/<%= dhaba._id %>/book`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: 'same-origin',
          body: JSON.stringify({ date, time, guests, message })
        });

        const bookingPayload = await bookingRes.json();
        console.log('Booking response:', bookingPayload);
        
        if (!bookingRes.ok) {
          setFeedback("error", bookingPayload.error || "Booking failed. Try again.");
          return;
        }

        // Now create Stripe checkout session
        console.log('Creating checkout session for bookingId:', bookingPayload.bookingId);
        const checkoutRes = await fetch('/bookings/create-checkout-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ bookingId: bookingPayload.bookingId })
        });

        const checkoutPayload = await checkoutRes.json();
        if (!checkoutRes.ok) {
          setFeedback("error", checkoutPayload.error || "Payment setup failed. Try again.");
          return;
        }

        setFeedback("success", "Redirecting to secure payment...");

        // Redirect to Stripe Checkout
        window.location.href = checkoutPayload.url;
      } catch (err) {
        console.error(err);
        setFeedback("error", "Unexpected error while booking. Please retry.");
      } finally {
        setLoading(false);
      }
    });
  });
</script>

<script type="application/json" id="dhaba-data"><%- JSON.stringify(dhaba) %></script>

<script>
  const mapToken = "<%= mapToken %>";
  const dhabaData = JSON.parse(document.getElementById('dhaba-data').textContent);
</script>

<!-- Title -->
<div class="row mt-3 justify-content-center">
  <div class="col-md-10 text-center">
    <h2>üçΩÔ∏è <%= dhaba.title %></h2>
    <div class="mb-3">
      <span class="badge bg-primary me-2"><%= dhaba.category %></span>
      <span class="badge bg-success me-2"><%= dhaba.cuisine %></span>
      <% if (dhaba.establishedYear) { %>
        <span class="badge bg-secondary">Est. <%= dhaba.establishedYear %></span>
      <% } %>
    </div>
    <% if (dhaba.rating) { %>
      <div class="mb-2">
        <% for (let i = 1; i <= 5; i++) { %>
          <i class="fa fa-star <%= i <= dhaba.rating ? 'text-warning' : 'text-muted' %>"></i>
        <% } %>
        <span class="ms-2 text-muted">(<%= dhaba.rating %>)</span>
      </div>
    <% } %>
  </div>
</div>

<div class="row justify-content-center">
  <div class="col-md-10">
    <!-- Social Sharing -->
    <div class="text-center mb-4">
      <%- include('../partials/socialShare', {
        currentUrl: `https://${process.env.HOST || 'localhost:3000'}/dhabas/${dhaba._id}`,
        shareText: `Check out '${dhaba.title}' on WanderLust - ${dhaba.description ? dhaba.description.substring(0, 100) + '...' : 'Authentic local cuisine experience!'}`,
        shareSubject: `Check out '${dhaba.title}' on WanderLust`
      }) %>
    </div>
    
    <div class="row">
      <!-- Left Column - Images & Details -->
      <div class="col-lg-8">
        <!-- Main Image -->
        <div class="card listing-card mb-4">
          <% if (dhaba.image && dhaba.image.url) { %>
            <img src="<%= dhaba.image.url %>" class="card-img-top show-img" alt="<%= dhaba.title %>" />
          <% } else { %>
            <img src="https://via.placeholder.com/600x300?text=No+Image+Available" class="card-img-top show-img" alt="<%= dhaba.title %>" />
          <% } %>
          <div class="card-body">
            <p class="card-text text-muted mb-2">Owned by: <strong><%= dhaba.owner.username %></strong></p>
            <% if (dhaba.description) { %>
              <p class="card-text"><%= dhaba.description %></p>
            <% } %>
          </div>
        </div>

        <!-- Dhaba Features -->
        <%- include('../partials/featureSection', {
          icon: 'fas fa-utensils',
          title: 'Dining Experience',
          features: [
            {
              icon: 'fas fa-map-marker-alt',
              title: 'Location',
              description: dhaba.location || 'Prime location'
            },
            {
              icon: 'fas fa-utensils',
              title: 'Cuisine',
              description: dhaba.cuisineType || 'North Indian'
            },
            {
              icon: 'fas fa-clock',
              title: 'Opening Hours',
              description: dhaba.openingHours || '9:00 AM - 11:00 PM'
            },
            {
              icon: 'fas fa-wheelchair',
              title: 'Accessibility',
              description: dhaba.accessible ? 'Wheelchair accessible' : 'Not wheelchair accessible'
            },
            {
              icon: 'fas fa-parking',
              title: 'Parking',
              description: dhaba.parking ? 'Parking available' : 'Limited parking'
            },
            {
              icon: 'fas fa-wifi',
              title: 'Amenities',
              description: dhaba.amenities && dhaba.amenities.length > 0 
                ? dhaba.amenities.slice(0, 3).join(', ') + (dhaba.amenities.length > 3 ? '...' : '')
                : 'Basic amenities available'
            }
          ]
        }) %>

        <!-- Quick Info Cards -->
        <div class="row g-3 mb-4">
          <!-- Basic Info -->
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-header bg-primary text-white">
                <h6 class="mb-0">üìã Basic Information</h6>
              </div>
              <div class="card-body">
                <div class="row g-2">
                  <div class="col-6"><strong>Category:</strong></div>
                  <div class="col-6"><%= dhaba.category %></div>
                  <div class="col-6"><strong>Cuisine:</strong></div>
                  <div class="col-6"><%= dhaba.cuisine %></div>
                  <div class="col-6"><strong>Location:</strong></div>
                  <div class="col-6"><%= dhaba.location %>, <%= dhaba.country %></div>
                  <div class="col-6"><strong>Price:</strong></div>
                  <div class="col-6">‚Çπ<%= dhaba.price ? Number(dhaba.price).toLocaleString("en-IN") : "N/A" %></div>
                  <% if (dhaba.operatingHours) { %>
                    <div class="col-6"><strong>Hours:</strong></div>
                    <div class="col-6">
                      <%= dhaba.operatingHours.opens %> - <%= dhaba.operatingHours.closes %>
                      <% if (dhaba.operatingHours.isOpen24Hours) { %>
                        <span class="text-success">(24/7)</span>
                      <% } %>
                    </div>
                  <% } %>
                </div>
              </div>
            </div>
          </div>

          <!-- Rating & Features -->
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-header bg-success text-white">
                <h6 class="mb-0">‚≠ê Rating & Features</h6>
              </div>
              <div class="card-body text-center">
                <div class="display-4 text-warning mb-2">
                  <%= dhaba.rating || 4.0 %>
                </div>
                <div class="mb-3">
                  <% for (let i = 1; i <= 5; i++) { %>
                    <i class="fa fa-star <%= i <= (dhaba.rating || 4) ? 'text-warning' : 'text-muted' %>"></i>
                  <% } %>
                </div>
                <p class="text-muted">Based on customer reviews</p>

                <% if (dhaba.facilities && dhaba.facilities.length > 0) { %>
                  <div class="mt-3">
                    <h6>Facilities:</h6>
                    <div class="d-flex flex-wrap gap-1 justify-content-center">
                      <% dhaba.facilities.forEach(facility => { %>
                        <span class="badge bg-light text-dark"><%= facility %></span>
                      <% }); %>
                    </div>
                  </div>
                <% } %>

                <% if (dhaba.specialties && dhaba.specialties.length > 0) { %>
                  <div class="mt-3">
                    <h6>Specialties:</h6>
                    <div class="d-flex flex-wrap gap-1 justify-content-center">
                      <% dhaba.specialties.forEach(specialty => { %>
                        <span class="badge bg-warning text-dark"><%= specialty %></span>
                      <% }); %>
                    </div>
                  </div>
                <% } %>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column - Actions -->
      <div class="col-lg-4">
        <!-- Dhaba Availability Calendar -->
        <div class="card mb-4">
          <div class="card-body p-0">
            <div id="wanderlust-dhaba-calendar" style="min-height: 380px;"></div>
          </div>
        </div>

        <!-- Booking Card -->
        <% if (currUser && (!dhaba.owner || !dhaba.owner.equals(currUser._id))) { %>
          <div class="card mb-4">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
              <h6 class="mb-0">Reserve a Table</h6>
              <span class="fw-semibold">‚Çπ<%= dhaba.price ? Number(dhaba.price).toLocaleString("en-IN") : "N/A" %> / guest</span>
            </div>
            <div class="card-body">
              <p class="text-muted small mb-3">Secured online payment powered by Stripe. Cancel anytime before the booking slot.</p>
              <button class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#dhabaBookingModal">
                <i class="fa fa-calendar-check me-2"></i>Book Now
              </button>
            </div>
          </div>
        <% } %>

        <!-- Owner Actions -->
        <% if (currUser && dhaba.owner && dhaba.owner.equals(currUser._id)) { %>
          <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
              <h6 class="mb-0">‚öôÔ∏è Owner Actions</h6>
            </div>
            <div class="card-body">
              <a class="btn btn-outline-primary btn-sm mb-2 w-100" href="/dhabas/<%= dhaba._id %>/edit">
                <i class="fa fa-edit"></i> Edit Dhaba
              </a>
              <form method="POST" action="/dhabas/<%= dhaba._id %>?_method=DELETE" class="d-inline">
                <button class="btn btn-outline-danger btn-sm w-100" type="submit">
                  <i class="fa fa-trash"></i> Delete Dhaba
                </button>
              </form>
            </div>
          </div>
        <% } %>

        <!-- Reviews Section -->
        <div class="col-8 offset-3 mb-3">
          <% if(currUser) { %>
            <hr>
            <h4>Leave a review</h4>
            <form action="/dhabas/<%= dhaba._id %>/reviews" method="POST" novalidate class="needs-validation">
              <div class="mb-3 mt-3">
                <label for="rating" class="form-label">Rating</label>
                <fieldset class="starability-slot">
                  <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="1" checked aria-label="No rating." />
                  <input type="radio" id="first-rate1" name="review[rating]" value="1" />
                  <label for="first-rate1" title="Terrible">1 star</label>
                  <input type="radio" id="first-rate2" name="review[rating]" value="2" />
                  <label for="first-rate2" title="Not good">2 stars</label>
                  <input type="radio" id="first-rate3" name="review[rating]" value="3" />
                  <label for="first-rate3" title="Average">3 stars</label>
                  <input type="radio" id="first-rate4" name="review[rating]" value="4" />
                  <label for="first-rate4" title="Very good">4 stars</label>
                  <input type="radio" id="first-rate5" name="review[rating]" value="5" />
                  <label for="first-rate5" title="Amazing">5 stars</label>
                </fieldset>
              </div>
              <div class="mb-3 mt-3">
                <label for="comment" class="form-label">Comments</label>
                <textarea name="review[comment]" id="comment" cols="30" rows="5" class="form-control" required></textarea>
                <div class="invalid-feedback">Please add some comments for review</div>
              </div>
              <button class="btn btn-outline-dark">Submit</button>
            </form>
            <hr>
          <% } %>

          <% if(dhaba.reviews.length > 0) { %>
            <div class="row">
              <p><b>All Reviews</b></p>
              <% for(review of dhaba.reviews) { %>
                <div class="card col-5 mb-3 ms-3">
                  <div class="card-body">
                    <h5 class="card-title">@<%= review.author.username %></h5>
                    <p class="starability-result card-text" data-rating="<%= review.rating%>"></p>
                    <p class="card-text"><%= review.comment %></p>
                  </div>
                  <form class="mb-3" method="POST" action="/dhabas/<%=dhaba._id %>/reviews/<%= review._id %>?_method=DELETE">
                    <button class="btn btn-sm btn-dark">Delete</button>
                  </form>
                </div>
              <% } %>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Initialize WanderLust Calendar -->
<script src="/js/wanderlust-calendar.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize the calendar
    const dhabaCalendar = new WanderLustCalendar('wanderlust-dhaba-calendar', {
      showHeader: true,
      showWeekdays: true,
      showToday: true,
      showClearBtn: true,
      minDate: new Date(),
      maxDate: (() => {
        const date = new Date();
        date.setMonth(date.getMonth() + 3); // Show up to 3 months in advance
        return date;
      })(),
      initialDate: new Date(),
      theme: {
        primary: '#FF6B6B', // Orange-red for dhabas
        secondary: '#FF9E7D',
        accent: '#FFD166',
        background: 'rgba(255, 255, 255, 0.9)',
        text: '#2D3436',
        lightText: '#636E72',
        border: 'rgba(0, 0, 0, 0.08)'
      },
      onDateSelect: function(date) {
        // Update the booking form when a date is selected
        const dateInput = document.getElementById('booking-date');
        if (dateInput) {
          const formattedDate = date.toISOString().split('T')[0];
          dateInput.value = formattedDate;
          // Trigger change event to update any dependent fields
          dateInput.dispatchEvent(new Event('change'));
        }
      },
      onMonthChange: async function(month, year) {
        // Here you would typically fetch availability for the month/year
        // For now, we'll simulate some unavailable dates
        const unavailableDates = [
          // Add some sample unavailable dates (next 7 days from today)
          ...Array.from({ length: 3 }, (_, i) => {
            const date = new Date();
            date.setDate(date.getDate() + Math.floor(Math.random() * 14) + 1);
            return date;
          })
        ];
        
        // Mark the unavailable dates on the calendar
        unavailableDates.forEach(date => {
          dhabaCalendar.markUnavailable(date);
        });
      }
    });
    
    // Mark today's date with a highlight
    dhabaCalendar.markToday();
    
    // Add some sample unavailable dates (in a real app, this would come from your API)
    const sampleUnavailableDates = [
      // Next 3 days from today
      ...Array.from({ length: 3 }, (_, i) => {
        const date = new Date();
        date.setDate(date.getDate() + Math.floor(Math.random() * 14) + 1);
        return date;
      })
    ];
    
    // Mark the sample unavailable dates
    sampleUnavailableDates.forEach(date => {
      dhabaCalendar.markUnavailable(date);
    });
  });
</script>

<!-- Map Section -->
<div class="col-6 offset-3 mb-3">
  <h3>Where you'll be</h3>
  <div id="map" style="height:400px;border-radius:15px;"></div>
</div>

<!-- Transport Mode Selection -->
<div class="transport-selector-container mb-3">
  <label class="transport-label fw-bold mb-2 d-block text-center">Choose Your Transport Mode:</label>
  
  <!-- Transport Comparison Bar -->
  <div class="transport-comparison d-flex justify-content-center mb-3">
    <div class="comparison-item">
      <span class="comparison-label">‚ö° Fastest:</span>
      <span class="comparison-value fastest">üöó Car</span>
    </div>
    <div class="comparison-item">
      <span class="comparison-label">üí∞ Cheapest:</span>
      <span class="comparison-value cheapest">üö∂ Walk</span>
    </div>
    <div class="comparison-item">
      <span class="comparison-label">üå± Eco-friendly:</span>
      <span class="comparison-value eco">üö¥ Bike</span>
    </div>
  </div>

  <div class="transport-modes d-flex justify-content-center gap-2 flex-wrap">
    <button class="transport-btn active" data-mode="driving" data-icon="üöó" data-color="#ff6b6b" data-cost="medium" data-speed="fast" data-eco="low">
      <span class="transport-icon">üöó</span>
      <span class="transport-text">Car</span>
      <span class="transport-time">~15 min</span>
      <span class="transport-cost">‚Çπ50-80</span>
      <div class="transport-badges">
        <span class="badge speed-fast">‚ö°</span>
        <span class="badge cost-medium">üí∞</span>
      </div>
    </button>
    <button class="transport-btn" data-mode="walking" data-icon="üö∂" data-color="#4ecdc4" data-cost="free" data-speed="slow" data-eco="high">
      <span class="transport-icon">üö∂</span>
      <span class="transport-text">Walk</span>
      <span class="transport-time">~45 min</span>
      <span class="transport-cost">Free</span>
      <div class="transport-badges">
        <span class="badge eco-high">üå±</span>
        <span class="badge cost-free">üíö</span>
      </div>
    </button>
    <button class="transport-btn" data-mode="cycling" data-icon="üö¥" data-color="#45b7d1" data-cost="low" data-speed="medium" data-eco="high">
      <span class="transport-icon">üö¥</span>
      <span class="transport-text">Bike</span>
      <span class="transport-time">~25 min</span>
      <span class="transport-cost">‚Çπ20-40</span>
      <div class="transport-badges">
        <span class="badge eco-high">üå±</span>
        <span class="badge cost-low">üí∞</span>
      </div>
    </button>
    <button class="transport-btn" data-mode="bus" data-icon="üöå" data-color="#96ceb4" data-cost="low" data-speed="medium" data-eco="medium">
      <span class="transport-icon">üöå</span>
      <span class="transport-text">Bus</span>
      <span class="transport-time">~30 min</span>
      <span class="transport-cost">‚Çπ15-25</span>
      <div class="transport-badges">
        <span class="badge cost-low">üí∞</span>
        <span class="badge eco-medium">üå±</span>
      </div>
    </button>
  </div>

  <!-- Transport Details Panel -->
  <div class="transport-details-panel mt-3" id="transport-details">
    <div class="details-header">
      <h5 class="details-title">üöó Car - Quick & Comfortable</h5>
      <button class="close-details" onclick="closeTransportDetails()">√ó</button>
    </div>
    <div class="details-content">
      <div class="detail-row">
        <span class="detail-label">‚è±Ô∏è Duration:</span>
        <span class="detail-value">15-20 minutes</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">üí∞ Cost:</span>
        <span class="detail-value">‚Çπ50-80 (including parking)</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">üåç Environment:</span>
        <span class="detail-value">Medium impact</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">üéØ Best for:</span>
        <span class="detail-value">Groups, luggage, weather protection</span>
      </div>
      <div class="detail-features">
        <span class="feature-tag">‚úì Door-to-door</span>
        <span class="feature-tag">‚úì Climate control</span>
        <span class="feature-tag">‚úì Privacy</span>
      </div>
    </div>
  </div>

  <!-- Filter Options -->
  <div class="transport-filters mt-3">
    <label class="filter-label">Quick filters:</label>
    <div class="filter-buttons">
      <button class="filter-btn" onclick="filterTransports('fastest')">
        ‚ö° Fastest
      </button>
      <button class="filter-btn" onclick="filterTransports('cheapest')">
        üí∞ Cheapest
      </button>
      <button class="filter-btn" onclick="filterTransports('eco')">
        üå± Eco-friendly
      </button>
      <button class="filter-btn active" onclick="filterTransports('all')">
        üîÑ All
      </button>
    </div>
  </div>

  <!-- Hidden select for compatibility -->
  <select id="transport-mode" class="d-none">
    <option value="driving" selected>üöó Car</option>
    <option value="walking">üö∂ Walking</option>
    <option value="cycling">üö¥ Cycling</option>
    <option value="bus">üöå Bus</option>
  </select>
</div>

<style>
.transport-selector-container {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 15px;
  padding: 20px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.08);
  border: 1px solid rgba(255,107,107,0.1);
}

.transport-label {
  color: #2c3e50;
  font-size: 1.1rem;
  margin-bottom: 15px !important;
}

/* Comparison Bar */
.transport-comparison {
  gap: 20px;
  margin-bottom: 20px !important;
}

.comparison-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 8px 12px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.comparison-label {
  font-size: 11px;
  color: #666;
  margin-bottom: 2px;
}

.comparison-value {
  font-weight: bold;
  font-size: 14px;
}

.comparison-value.fastest { color: #ff6b6b; }
.comparison-value.cheapest { color: #28a745; }
.comparison-value.eco { color: #17a2b8; }

/* Transport Buttons */
.transport-modes {
  gap: 12px;
}

.transport-btn {
  background: white;
  border: 2px solid #e9ecef;
  border-radius: 12px;
  padding: 12px 16px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  display: flex;
  flex-direction: column;
  align-items: center;
  min-width: 90px;
  position: relative;
  overflow: hidden;
}

.transport-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.15);
  border-color: #ff6b6b;
}

.transport-btn.active {
  background: linear-gradient(135deg, #ff6b6b, #ff8e53);
  color: white;
  border-color: #ff6b6b;
  transform: scale(1.05);
  box-shadow: 0 8px 25px rgba(255,107,107,0.3);
}

.transport-btn.active::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0% { left: -100%; }
  100% { left: 100%; }
}

.transport-icon {
  font-size: 24px;
  margin-bottom: 4px;
  display: block;
}

.transport-text {
  font-weight: 600;
  font-size: 14px;
  margin-bottom: 2px;
}

.transport-time {
  font-size: 11px;
  opacity: 0.8;
  font-weight: 500;
  margin-bottom: 2px;
}

.transport-cost {
  font-size: 10px;
  font-weight: 600;
  color: #666;
  margin-bottom: 4px;
}

.transport-btn:hover .transport-icon {
  transform: scale(1.1);
}

.transport-btn.active .transport-time,
.transport-btn.active .transport-cost {
  opacity: 1;
  color: white;
}

/* Badges */
.transport-badges {
  display: flex;
  gap: 2px;
  margin-top: 4px;
}

.badge {
  font-size: 9px;
  padding: 2px 4px;
  border-radius: 4px;
  background: rgba(0,0,0,0.1);
  color: #666;
}

.transport-btn.active .badge {
  background: rgba(255,255,255,0.2);
  color: white;
}

/* Details Panel */
.transport-details-panel {
  background: white;
  border-radius: 10px;
  padding: 15px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  border: 1px solid #e9ecef;
  display: none;
}

.transport-details-panel.show {
  display: block;
  animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.details-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.details-title {
  margin: 0;
  font-size: 16px;
  color: #2c3e50;
}

.close-details {
  background: none;
  border: none;
  font-size: 20px;
  cursor: pointer;
  color: #666;
  padding: 0;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.close-details:hover {
  background: #f0f0f0;
}

.detail-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
  padding: 5px 0;
  border-bottom: 1px solid #f0f0f0;
}

.detail-label {
  font-weight: 600;
  color: #666;
  font-size: 13px;
}

.detail-value {
  font-weight: 500;
  color: #333;
  font-size: 13px;
}

.detail-features {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 10px;
}

.feature-tag {
  background: #e8f5e8;
  color: #28a745;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 500;
}

/* Filters */
.transport-filters {
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px solid #e9ecef;
}

.filter-label {
  font-size: 13px;
  color: #666;
  margin-bottom: 8px;
  display: block;
}

.filter-buttons {
  display: flex;
  gap: 8px;
  justify-content: center;
  flex-wrap: wrap;
}

.filter-btn {
  background: white;
  border: 1px solid #e9ecef;
  border-radius: 20px;
  padding: 6px 12px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.filter-btn:hover {
  background: #f8f9fa;
  border-color: #ff6b6b;
}

.filter-btn.active {
  background: #ff6b6b;
  color: white;
  border-color: #ff6b6b;
}

/* Filtered states */
.transport-btn.filtered-out {
  opacity: 0.3;
  transform: scale(0.9);
  pointer-events: none;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const transportBtns = document.querySelectorAll('.transport-btn');
  const transportSelect = document.getElementById('transport-mode');
  const detailsPanel = document.getElementById('transport-details');
  
  // Transport details data
  const transportDetails = {
    driving: {
      title: 'üöó Car - Quick & Comfortable',
      duration: '15-20 minutes',
      cost: '‚Çπ50-80 (including parking)',
      environment: 'Medium impact',
      bestFor: 'Groups, luggage, weather protection',
      features: ['‚úì Door-to-door', '‚úì Climate control', '‚úì Privacy', '‚úì Flexible timing']
    },
    walking: {
      title: 'üö∂ Walking - Healthy & Free',
      duration: '40-50 minutes',
      cost: 'Completely free',
      environment: 'Zero impact',
      bestFor: 'Short distances, exercise, sightseeing',
      features: ['‚úì No cost', '‚úì Great exercise', '‚úì See the city', '‚úì Eco-friendly']
    },
    cycling: {
      title: 'üö¥ Bike - Fast & Eco-friendly',
      duration: '20-30 minutes',
      cost: '‚Çπ20-40 (bike rental)',
      environment: 'Low impact',
      bestFor: 'Moderate distances, fitness enthusiasts',
      features: ['‚úì Eco-friendly', '‚úì Avoid traffic', '‚úì Good exercise', '‚úì Easy parking']
    },
    bus: {
      title: 'üöå Bus - Economical & Convenient',
      duration: '25-35 minutes',
      cost: '‚Çπ15-25 (public transport)',
      environment: 'Low impact',
      bestFor: 'Budget travelers, longer distances',
      features: ['‚úì Very affordable', '‚úì No parking worries', '‚úì Regular service', '‚úì Climate controlled']
    }
  };
  
  transportBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      // Remove active class from all buttons
      transportBtns.forEach(b => b.classList.remove('active'));
      
      // Add active class to clicked button
      this.classList.add('active');
      
      // Update hidden select
      const mode = this.dataset.mode;
      transportSelect.value = mode;
      
      // Show transport details
      showTransportDetails(mode);
      
      // Trigger change event for existing functionality
      transportSelect.dispatchEvent(new Event('change'));
      
      // Add pulse animation
      this.style.animation = 'pulse 0.6s ease-in-out';
      setTimeout(() => {
        this.style.animation = '';
      }, 600);
    });
    
    // Add hover details preview
    btn.addEventListener('mouseenter', function() {
      const mode = this.dataset.mode;
      updateComparisonHighlight(mode);
    });
  });
  
  // Show transport details
  function showTransportDetails(mode) {
    const details = transportDetails[mode];
    if (!details) return;
    
    detailsPanel.querySelector('.details-title').textContent = details.title;
    
    const detailRows = detailsPanel.querySelectorAll('.detail-value');
    detailRows[0].textContent = details.duration;
    detailRows[1].textContent = details.cost;
    detailRows[2].textContent = details.environment;
    detailRows[3].textContent = details.bestFor;
    
    // Update features
    const featuresContainer = detailsPanel.querySelector('.detail-features');
    featuresContainer.innerHTML = details.features.map(feature => 
      `<span class="feature-tag">${feature}</span>`
    ).join('');
    
    // Show panel with animation
    detailsPanel.classList.add('show');
  }
  
  // Close transport details
  window.closeTransportDetails = function() {
    detailsPanel.classList.remove('show');
  };
  
  // Filter transports
  window.filterTransports = function(filterType) {
    // Update filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Filter transport buttons
    transportBtns.forEach(btn => {
      btn.classList.remove('filtered-out');
      
      if (filterType === 'fastest' && btn.dataset.speed !== 'fast') {
        btn.classList.add('filtered-out');
      } else if (filterType === 'cheapest' && btn.dataset.cost !== 'free' && btn.dataset.cost !== 'low') {
        btn.classList.add('filtered-out');
      } else if (filterType === 'eco' && btn.dataset.eco !== 'high') {
        btn.classList.add('filtered-out');
      }
    });
  };
  
  // Update comparison highlight
  function updateComparisonHighlight(mode) {
    const comparisons = document.querySelectorAll('.comparison-value');
    comparisons.forEach(comp => comp.style.fontWeight = 'normal');
    
    if (mode === 'driving') {
      document.querySelector('.comparison-value.fastest').style.fontWeight = 'bold';
    } else if (mode === 'walking') {
      document.querySelector('.comparison-value.cheapest').style.fontWeight = 'bold';
    } else if (mode === 'cycling') {
      document.querySelector('.comparison-value.eco').style.fontWeight = 'bold';
    }
  }
  
  // Add pulse animation
  const style = document.createElement('style');
  style.textContent = `
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
  `;
  document.head.appendChild(style);
  
  // Show details for initially selected transport
  const activeBtn = document.querySelector('.transport-btn.active');
  if (activeBtn) {
    showTransportDetails(activeBtn.dataset.mode);
  }
});
</script>


<!-- Booking Modal -->
<div class="modal fade" id="dhabaBookingModal" tabindex="-1" aria-labelledby="dhabaBookingLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="dhabaBookingLabel">Reserve a table at <%= dhaba.title %></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <% if (!currUser) { %>
          <div class="alert alert-warning mb-0">
            Please <a href="/login" class="alert-link">log in</a> to make a reservation.
          </div>
        <% } else { %>
          <form id="dhaba-booking-form">
            <div class="row g-3">
              <div class="col-12">
                <label for="booking-date" class="form-label">Date</label>
                <input type="date" id="booking-date" name="date" class="form-control" required>
              </div>
              <div class="col-12">
                <label for="booking-time" class="form-label">Preferred Time</label>
                <input type="time" id="booking-time" name="time" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label for="booking-guests" class="form-label">Number of Guests</label>
                <input type="number" id="booking-guests" name="guests" class="form-control" min="1" max="20" value="2" required>
              </div>
              <div class="col-12">
                <label for="booking-message" class="form-label">Special Requests <span class="text-muted small">(optional)</span></label>
                <textarea id="booking-message" name="message" class="form-control" rows="3" placeholder="Allergies, celebrations, seating preference..."></textarea>
              </div>
            </div>
            <div class="mt-3 p-3 bg-light rounded border">
              <div class="d-flex justify-content-between">
                <span class="fw-semibold">Estimated Amount</span>
                <span id="booking-amount" class="fw-bold">‚Çπ<%= dhaba.price ? Number(dhaba.price).toLocaleString("en-IN") : "0" %></span>
              </div>
              <small class="text-muted d-block mt-1">‚Çπ<%= dhaba.price ? Number(dhaba.price).toLocaleString("en-IN") : "N/A" %> per guest ¬∑ Secure payment via Stripe</small>
            </div>
            <div class="mt-3">
              <div class="alert alert-danger d-none" id="booking-error"></div>
              <div class="alert alert-success d-none" id="booking-success"></div>
            </div>
            <div class="modal-footer px-0">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-success" id="booking-submit-btn">
                <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true" id="booking-spinner"></span>
                Proceed to Payment
              </button>
            </div>
          </form>
        <% } %>
      </div>
    </div>
  </div>
</div>

<!-- Map Initialization Script -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const dhabaCoords = dhabaData.geometry.coordinates;
    if (!dhabaCoords || dhabaCoords.length !== 2) {
      document.getElementById("map").innerHTML = "<p class='text-center mt-3'>Map location not available</p>";
      return;
    }

    // Initialize Enhanced Map
    const enhancedMap = new EnhancedMap('map', {
      mapToken: mapToken,
      center: dhabaCoords,
      zoom: 16,
      searchEnabled: true,
      clusterEnabled: false,
      mapStyle: 'mapbox://styles/mapbox/streets-v12',
      showControls: true,
      showScale: true,
      showCompass: true,
      showZoom: true,
      showFullscreen: true,
      showGeolocate: true
    });

    // Add dhaba marker with enhanced styling
    enhancedMap.addMarker('dhaba', dhabaCoords, {
      color: '#ff6b35',
      icon: 'restaurant',
      size: 'large',
      title: dhabaData.title,
      description: `${dhabaData.cuisine} | ‚Çπ${dhabaData.price.toLocaleString("en-IN")} per guest | ‚≠ê${dhabaData.rating}`,
      popup: true,
      animate: true
    });

    // User location (default)
    const userLat = 19.85;
    const userLng = 75.93;
    const userCoords = [userLng, userLat];

    // Add user location marker with enhanced styling
    enhancedMap.addMarker('user', userCoords, {
      color: '#3b82f6',
      icon: 'user',
      size: 'medium',
      title: 'Your Location',
      description: 'Starting point',
      popup: true,
      animate: true
    });

    // Add route on transport mode change
    async function updateRoute() {
      const transportSelect = document.getElementById("transport-mode");
      const transportMode = transportSelect.value;

      try {
        const routeData = await enhancedMap.addRoute('dhaba-route', [
          userCoords,
          dhabaCoords
        ], {
          color: '#ff8c00',
          width: 4,
          transportMode: transportMode
        });

        // Route calculated successfully
      } catch (err) {
        console.error('Route error:', err);
      }
    }

    // Initial route
    updateRoute();

    // Event listeners
    document.getElementById("refresh-location").addEventListener("click", updateRoute);
    document.getElementById("transport-mode").addEventListener("change", updateRoute);
  });
</script>

</body>
