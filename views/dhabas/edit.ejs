<% layout("/layouts/boilerplate") -%>

  <div class="row justify-content-center">
    <div class="col-md-9">
      <h3 class="mb-4">üçΩÔ∏è Edit Dhaba: <%= dhaba.title %>
      </h3>
      <form action="/dhabas/<%= dhaba._id %>?_method=PUT" method="POST" enctype="multipart/form-data" novalidate
        class="needs-validation">

        <!-- Basic Information -->
        <div class="card mb-4 shadow-sm">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">üìã Basic Information</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label">Dhaba Name *</label>
                <input class="form-control" type="text" name="dhaba[title]" value="<%= dhaba.title %>" required />
                <div class="invalid-feedback">Please enter a dhaba name.</div>
              </div>
              <div class="col-12">
                <label class="form-label">Description</label>
                <textarea class="form-control" name="dhaba[description]"
                  rows="3"><%= dhaba.description || '' %></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- Food & Pricing Details -->
        <div class="card mb-4 shadow-sm">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0">üçõ Food & Pricing</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Cuisine Type *</label>
                <select name="dhaba[cuisine]" class="form-select" required>
                  <option value="">Select Cuisine</option>
                  <% ['North Indian', 'South Indian' , 'Punjabi' , 'Chinese' , 'Multi-Cuisine' , 'Street Food'
                    , 'Rajasthani' , 'Gujarati' , 'Bengali' , 'Continental' ].forEach(cuisine=> { %>
                    <option value="<%= cuisine %>" <%=dhaba.cuisine===cuisine ? 'selected' : '' %>><%= cuisine %>
                    </option>
                    <% }) %>
                </select>
                <div class="invalid-feedback">Please select a cuisine type.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Category *</label>
                <select name="dhaba[category]" class="form-select" required>
                  <option value="">Select Category</option>
                  <% ['Fine Dining', 'Casual Dining' , 'Fast Food' , 'Cafe' , 'Food Truck' , 'Buffet'
                    , 'Family Restaurant' ].forEach(cat=> { %>
                    <option value="<%= cat %>" <%=dhaba.category===cat ? 'selected' : '' %>><%= cat %>
                    </option>
                    <% }) %>
                </select>
                <div class="invalid-feedback">Please select a category.</div>
              </div>
              <div class="col-md-6 position-relative">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <label class="form-label mb-0">Average Price per Person (‚Çπ) *</label>
                  <button type="button" id="getAiPrice" class="btn btn-sm glass hover-lift"
                    style="font-size: 0.75rem; color: var(--primary-orange);">
                    <i class="fas fa-magic me-1"></i> Get AI Price
                  </button>
                </div>
                <input name="dhaba[price]" id="price" type="number" class="form-control" min="0"
                  value="<%= dhaba.price %>" required />
                <div id="ai-price-hint" class="input-hint"
                  style="display: none; color: var(--primary-orange); font-size: 0.75rem; margin-top: 4px;">
                  <i class="fas fa-sparkles"></i> AI suggested this based on your details.
                </div>
                <div class="invalid-feedback">Please enter a valid price.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Rating (1-5)</label>
                <input name="dhaba[rating]" type="number" class="form-control" min="1" max="5" step="0.1"
                  value="<%= dhaba.rating %>" />
              </div>
            </div>
          </div>
        </div>

        <!-- Location Details -->
        <div class="card mb-4 shadow-sm">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0">üìç Location</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Location *</label>
                <input class="form-control" type="text" name="dhaba[location]" value="<%= dhaba.location %>" required />
                <div class="invalid-feedback">Please enter a location.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Country *</label>
                <input class="form-control" type="text" name="dhaba[country]" value="<%= dhaba.country || 'India' %>"
                  required />
                <div class="invalid-feedback">Please enter a country.</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Contact & Hours -->
        <div class="card mb-4 shadow-sm">
          <div class="card-header bg-dark text-white">
            <h5 class="mb-0">üìû Contact & Operating Hours</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Phone Number *</label>
                <input name="dhaba[phone]" type="tel" class="form-control" value="<%= dhaba.phone %>" required />
                <div class="invalid-feedback">Please enter a phone number.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Email (optional)</label>
                <input name="dhaba[email]" type="email" class="form-control" value="<%= dhaba.email %>" />
              </div>
              <div class="col-md-6">
                <label class="form-label">Opening Time *</label>
                <input name="dhaba[operatingHours][opens]" type="time" class="form-control"
                  value="<%= dhaba.operatingHours?.opens %>" required />
              </div>
              <div class="col-md-6">
                <label class="form-label">Closing Time *</label>
                <input name="dhaba[operatingHours][closes]" type="time" class="form-control"
                  value="<%= dhaba.operatingHours?.closes %>" required />
              </div>
              <div class="col-12">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="dhaba[operatingHours][isOpen24Hours]"
                    value="true" id="isOpen24Hours" <%=dhaba.operatingHours?.isOpen24Hours ? 'checked' : '' %>>
                  <label class="form-check-label" for="isOpen24Hours">Open 24 Hours</label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Images Section -->
        <div class="card mb-4 shadow-sm border-warning">
          <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">üì∑ Media Gallery</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-12">
                <% if (dhaba.image && dhaba.image.length> 0) { %>
                  <div class="mb-3">
                    <label class="form-label fw-bold">Current Photos</label>
                    <div class="d-flex gap-3 flex-wrap p-2 bg-light rounded border">
                      <% dhaba.image.forEach((img, i)=> { %>
                        <div class="position-relative text-center">
                          <img src="<%= img.url %>" alt="Image <%= i+1 %>" class="img-thumbnail"
                            style="width: 120px; height: 120px; object-fit: cover;" />
                          <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" name="deleteImages[]"
                              value="<%= img.filename %>" id="image-<%= i %>">
                            <label class="form-check-label text-danger small fw-bold"
                              for="image-<%= i %>">DELETE</label>
                          </div>
                        </div>
                        <% }) %>
                    </div>
                  </div>
                  <% } %>
                    <div class="mt-3">
                      <label class="form-label fw-bold">Add New Images</label>
                      <input class="form-control" type="file" name="dhaba[image]" accept="image/*" multiple />
                      <small class="form-text text-muted">Upload more photos to enhance your dhaba's profile.</small>
                    </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Facilities & Specialties -->
        <div class="card mb-4 shadow-sm">
          <div class="card-header bg-secondary text-white">
            <h5 class="mb-0">ü•ó Options & Facilities</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="dhaba[isVegetarian]" value="true"
                    id="isVegetarian" <%=dhaba.isVegetarian ? 'checked' : '' %>>
                  <label class="form-check-label" for="isVegetarian">Vegetarian Options</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="dhaba[isVegan]" value="true" id="isVegan"
                    <%=dhaba.isVegan ? 'checked' : '' %>>
                  <label class="form-check-label" for="isVegan">Vegan Options</label>
                </div>
              </div>
              <div class="col-12">
                <label class="form-label">Specialties (comma separated)</label>
                <input name="dhaba[specialties]" type="text" class="form-control"
                  value="<%= dhaba.specialties?.join(', ') %>" placeholder="Dal Makhani, Butter Chicken, etc." />
              </div>
              <div class="col-12">
                <label class="form-label">Facilities</label>
                <div class="row g-2">
                  <% ['AC', 'Parking' , 'WiFi' , 'Outdoor Seating' , 'Card Payment' , 'Home Delivery' , 'Family Section'
                    , 'Live Music' ].forEach(facility=> { %>
                    <div class="col-sm-4 col-md-3">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="dhaba[facilities]" value="<%= facility %>"
                          id="<%= facility.replace(/\s+/g, '') %>" <%=dhaba.facilities?.includes(facility) ? 'checked'
                          : '' %>>
                        <label class="form-check-label small" for="<%= facility.replace(/\s+/g, '') %>">
                          <%= facility %>
                        </label>
                      </div>
                    </div>
                    <% }) %>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="card mb-5 shadow-sm">
          <div class="card-body d-flex justify-content-center gap-3">
            <button class="btn btn-primary btn-lg px-5 shadow-sm" type="submit">
              <i class="fas fa-save me-2"></i>Save Changes
            </button>
            <a class="btn btn-outline-secondary btn-lg px-5" href="/dhabas/<%= dhaba._id %>">
              <i class="fas fa-times me-2"></i>Cancel
            </a>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const aiBtn = document.getElementById('getAiPrice');
      const priceInput = document.getElementById('price');
      const aiHint = document.getElementById('ai-price-hint');

      if (aiBtn) {
        aiBtn.addEventListener('click', async () => {
          const title = document.querySelector('input[name="dhaba[title]"]').value;
          const location = document.querySelector('input[name="dhaba[location]"]').value;
          const type = document.querySelector('select[name="dhaba[cuisine]"]').value;
          const description = document.querySelector('textarea[name="dhaba[description]"]').value;

          aiBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
          aiBtn.disabled = true;

          try {
            const response = await fetch('/ai/magic/magic-price', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ title, location, type, description, currentPrice: priceInput.value })
            });
            const data = await response.json();

            if (data.suggestedPrice) {
              priceInput.value = data.suggestedPrice;
              aiHint.style.display = 'block';
              aiHint.innerHTML = `<i class="fas fa-sparkles"></i> AI suggest ‚Çπ${data.suggestedPrice}: ${data.reasoning}`;
              priceInput.classList.add('ai-updated');
              setTimeout(() => priceInput.classList.remove('ai-updated'), 1000);
            }
          } catch (err) {
            console.error('AI Price Error:', err);
          } finally {
            aiBtn.innerHTML = '<i class="fas fa-magic me-1"></i> Get AI Price';
            aiBtn.disabled = false;
          }
        });
      }
    });
  </script>

  <style>
    .ai-updated {
      animation: pulse-price 1s ease-out;
    }

    @keyframes pulse-price {
      0% {
        box-shadow: 0 0 0 0 rgba(254, 107, 0, 0.4);
      }

      70% {
        box-shadow: 0 0 0 10px rgba(254, 107, 0, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(254, 107, 0, 0);
      }
    }

    .glass {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .hover-lift:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
  </style>