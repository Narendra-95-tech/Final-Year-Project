<% layout("/layouts/boilerplate") -%>

    <!-- Link CSS Files -->
    <link rel="stylesheet" href="/css/listing-details.css">
    <link rel="stylesheet" href="/css/calendar.css">
    <script src="/js/wishlist-handler.js"></script>

    <body class="listing-details-page">

        <!-- Sticky Scroll Header -->
        <div id="sticky-header" class="sticky-header">
            <div class="sticky-header-content">
                <div class="sticky-header-left">
                    <span class="sticky-header-title">
                        <%= listing.title %>
                    </span>
                    <span class="sticky-header-rating">
                        <i class="fas fa-star"></i>
                        <%= listing.reviews && listing.reviews.length> 0
                            ? (listing.reviews.reduce((sum, r)=> sum + r.rating, 0) / listing.reviews.length).toFixed(1)
                            : 'New' %>
                    </span>
                </div>
                <div class="sticky-header-right">
                    <button class="sticky-reserve-btn"
                        onclick="document.querySelector('.booking-card').scrollIntoView({behavior: 'smooth'})">
                        Reserve
                    </button>
                </div>
            </div>
        </div>



        <!-- Listing Data (JSON) -->
        <script type="application/json" id="listing-data">
    <%- JSON.stringify(listing) %>
  </script>

        <script>
            const mapToken = "<%= process.env.MAP_TOKEN %>";
            const listing = JSON.parse(document.getElementById('listing-data').textContent);
            const currUserId = "<%= currUser ? currUser._id : '' %>";
            const isOwner = "<%= currUser && listing.owner._id.equals(currUser._id) ? 'true' : 'false' %>" === 'true';

            // Sticky Header Scroll Logic
            window.addEventListener('scroll', () => {
                const header = document.getElementById('sticky-header');
                const trigger = document.querySelector('.property-header'); // Show after passing header
                if (trigger && window.scrollY > trigger.offsetTop + trigger.offsetHeight) {
                    header.classList.add('visible');
                } else {
                    header.classList.remove('visible');
                }
            });
        </script>

        <!-- Image Gallery Section -->
        <div id="image-gallery-container"></div>

        <!-- Main Content Grid -->
        <div class="listing-details-grid">

            <!-- Left Column: Main Content -->
            <div class="listing-main-content">

                <!-- Property Header & Subtitle -->
                <div class="property-header">
                    <div class="property-header-top">
                        <h1 class="property-title">
                            <%= listing.title %>
                        </h1>
                        <div class="header-actions">
                            <% const isWishlisted=currUser && currUser.wishlist && currUser.wishlist.some(id=>
                                id.toString() === listing._id.toString()); %>
                                <%- include('../partials/socialShare', { itemId: listing._id, isWishlisted,
                                    shareTitle: 'Share this listing' , currentUrl: `https://${process.env.HOST
                                    || 'localhost:8080' }/listings/${listing._id}`, shareText: `Check
                                    out '${listing.title}' on WanderLust`, shareSubject: `Check out '${listing.title}'
                                    on WanderLust` }) %>
                        </div>
                    </div>
                    <div class="property-subtitle-row">
                        <span class="property-specs">
                            <%= listing.guests || 2 %> guests ·
                                <%= listing.bedrooms || 1 %> bedroom ·
                                    <%= listing.beds || listing.bedrooms || 1 %> bed ·
                                        <%= listing.bathrooms || 1 %> bathroom
                        </span>
                        <% if (listing.reviews && listing.reviews.length> 0) { %>
                            <span class="property-rating-row">
                                <span class="separator">·</span>
                                <i class="fas fa-star text-black"></i>
                                <span class="rating-val">
                                    <%= (listing.reviews.reduce((sum, r)=> sum + r.rating, 0) /
                                        listing.reviews.length).toFixed(1) %>
                                </span>
                                <span class="review-count underline">
                                    <%= listing.reviews.length %> reviews
                                </span>
                            </span>
                            <% } %>
                    </div>
                </div>

                <hr class="section-divider">

                <!-- Host Info Row -->
                <!-- Enhanced Host Profile Card -->
                <!-- Host Info Row -->
                <div class="host-info-row">
                    <img src="<%= listing.owner.avatar?.url || '/images/default-avatar.png' %>"
                        alt="<%= listing.owner.username %>" class="host-avatar-large" />
                    <div class="host-text">
                        <div class="host-name">Hosted by <%= listing.owner.username %>
                        </div>
                        <div class="host-badge text-secondary">Superhost · 4 years hosting</div>
                    </div>
                </div>

                <hr class="section-divider">

                <!-- Property Highlights (Vertical List) -->
                <div class="property-highlights-list">
                    <!-- Highlight 1: Property Type -->
                    <div class="highlight-list-item">
                        <i class="highlight-icon fas fa-home"></i>
                        <div class="highlight-content">
                            <div class="highlight-title">Entire <%= listing.propertyType || 'home' %>
                            </div>
                            <div class="highlight-sub">You’ll have the <%= listing.propertyType?.toLowerCase()
                                    || 'place' %> to yourself.</div>
                        </div>
                    </div>

                    <!-- Highlight 2: Self Check-in -->
                    <div class="highlight-list-item">
                        <i class="highlight-icon fas fa-door-open"></i>
                        <div class="highlight-content">
                            <div class="highlight-title">Self check-in</div>
                            <div class="highlight-sub">Check yourself in with the lockbox.</div>
                        </div>
                    </div>

                    <!-- Highlight 3: Great Location -->
                    <div class="highlight-list-item">
                        <i class="highlight-icon fas fa-map-marker-alt"></i>
                        <div class="highlight-content">
                            <div class="highlight-title">Great location</div>
                            <div class="highlight-sub">100% of recent guests gave the location a 5-star rating.</div>
                        </div>
                    </div>

                    <!-- Highlight 4: Workstation (if applicable) -->
                    <% if (listing.amenities && listing.amenities.includes('Workspace')) { %>
                        <div class="highlight-list-item">
                            <i class="highlight-icon fas fa-laptop"></i>
                            <div class="highlight-content">
                                <div class="highlight-title">Dedicated workspace</div>
                                <div class="highlight-sub">A common area with wifi that’s well-suited for working.</div>
                            </div>
                        </div>
                        <% } %>
                </div>

                <hr class="section-divider">

                <!-- Description -->
                <div class="property-description">
                    <!-- <h2 class="section-title">About this place</h2> -->
                    <p class="description-text line-clamp">
                        <%= listing.description %>
                    </p>
                    <button class="show-more-desc-btn">
                        Show more
                    </button>
                </div>

                <hr class="section-divider">

                <!-- Amenities Section -->
                <div class="amenities-section">
                    <h2 class="section-title">What this place offers</h2>
                    <div class="amenities-grid" id="amenities-grid">
                        <% const amenities=(listing.amenities && listing.amenities.length> 0) ? listing.amenities : [
                            'Kitchen',
                            'Wifi',
                            'Free parking on premises',
                            'Pool',
                            'TV',
                            'Lift',
                            'Washing machine',
                            'Air conditioning',
                            'Unavailable: Carbon monoxide alarm',
                            'Unavailable: Smoke alarm'
                            ];
                            const topAmenities = amenities.slice(0, 10);

                            const amenityIcons = {
                            'WiFi': 'fa-wifi',
                            'Kitchen': 'fa-utensils',
                            'Free parking': 'fa-car',
                            'Parking': 'fa-car',
                            'Pool': 'fa-swimming-pool',
                            'Hot tub': 'fa-water',
                            'TV': 'fa-tv',
                            'Air conditioning': 'fa-snowflake',
                            'AC': 'fa-snowflake',
                            'Heating': 'fa-temperature-high',
                            'Washing machine': 'fa-soap',
                            'Washer': 'fa-soap',
                            'Dryer': 'fa-wind',
                            'Lift': 'fa-elevator',
                            'Elevator': 'fa-elevator',
                            'Workspace': 'fa-laptop',
                            'Gym': 'fa-dumbbell',
                            'Breakfast': 'fa-coffee',
                            'Fireplace': 'fa-fire',
                            'Iron': 'fa-tshirt',
                            'Hair dryer': 'fa-wind',
                            'Shampoo': 'fa-pump-soap',
                            'Carbon monoxide alarm': 'fa-ban',
                            'Smoke alarm': 'fa-ban',
                            'First aid kit': 'fa-medkit',
                            'Fire extinguisher': 'fa-fire-extinguisher'
                            };

                            function getIcon(name) {
                            const cleanName = name.replace('Unavailable: ', '').trim();
                            const key = Object.keys(amenityIcons).find(k =>
                            cleanName.toLowerCase().includes(k.toLowerCase()));
                            return key ? amenityIcons[key] : 'fa-check-circle';
                            }
                            %>

                            <% topAmenities.forEach(amenity=> {
                                const isUnavailable = amenity.toLowerCase().includes('unavailable');
                                const iconClass = getIcon(amenity);
                                %>
                                <div class="amenity-item <%= isUnavailable ? 'amenity-unavailable' : '' %>">
                                    <i class="amenity-icon fas <%= iconClass %>"></i>
                                    <span>
                                        <%= amenity.replace('Unavailable: ', '') %></span>
                            </div>
                        <% }) %>
                    </div>
                    <% if (amenities.length> 0) { %>
                        <button class="show-all-amenities-btn" id="show-all-amenities">
                            Show all <%= amenities.length %> amenities
                        </button>
                        <% } %>
                </div>

                <!-- Calendar Section -->
                <div class="amenities-section">
                    <h2 class="section-title">Availability</h2>
                    <div class="card">
                        <div class="card-body p-4">
                            <div id="availabilityCalendar" class="wanderlust-calendar" style="min-height: 400px;"></div>
                        </div>
                    </div>
                </div>

                <!-- Reviews Section -->
                <div id="reviews-display-container"></div>

                <!-- Map Section -->
                <div class="map-section">
                    <h2 class="section-title">Where you' ll be</h2>
                                            <p class="text-secondary mb-3">
                                                <%= listing.location %>, <%= listing.country %>
                                            </p>
                                            <div class="map-container">
                                                <div id="map" style="width: 100%; height: 100%;"></div>
                                            </div>
                                </div>



                                <!-- Policies Section -->
                                <!-- Things to Know Section -->
                                <div class="policies-section">
                                    <h2 class="section-title">Things to know</h2>
                                    <div class="policies-grid">

                                        <!-- House Rules -->
                                        <div class="policy-column">
                                            <h3 class="policy-header-title">House rules</h3>
                                            <ul class="policy-list">
                                                <li>Check-in: After 2:00 PM</li>
                                                <li>Checkout: Before 11:00 AM</li>
                                                <% if (listing.houseRules && listing.houseRules.length> 0) { %>
                                                    <% listing.houseRules.slice(0, 3).forEach(rule=> { %>
                                                        <li>
                                                            <%= rule %>
                                                        </li>
                                                        <% }) %>
                                                            <% } else { %>
                                                                <li>No smoking</li>
                                                                <li>No pets</li>
                                                                <li>No parties or events</li>
                                                                <% } %>
                                            </ul>
                                            <% if (listing.houseRules && listing.houseRules.length> 3) { %>
                                                <button class="show-more-link" data-policy-trigger="houseRules">
                                                    Show more <i class="fas fa-chevron-right"></i>
                                                </button>
                                                <% } %>
                                        </div>

                                        <!-- Safety & Property -->
                                        <div class="policy-column">
                                            <h3 class="policy-header-title">Safety & property</h3>
                                            <ul class="policy-list">
                                                <% if (listing.safetyGuidelines && listing.safetyGuidelines.length> 0) {
                                                    %>
                                                    <% listing.safetyGuidelines.slice(0, 3).forEach(item=> { %>
                                                        <li>
                                                            <%= item %>
                                                        </li>
                                                        <% }) %>
                                                            <% } else { %>
                                                                <li>Smoke alarm installed</li>
                                                                <li>Carbon monoxide alarm</li>
                                                                <li>First aid kit available</li>
                                                                <% } %>
                                            </ul>
                                            <% if (listing.safetyGuidelines && listing.safetyGuidelines.length> 3) { %>
                                                <button class="show-more-link" data-policy-trigger="safety">
                                                    Show more <i class="fas fa-chevron-right"></i>
                                                </button>
                                                <% } %>
                                        </div>

                                        <!-- Cancellation Policy -->
                                        <div class="policy-column">
                                            <h3 class="policy-header-title">Cancellation policy</h3>
                                            <p class="policy-text">
                                                <%= listing.cancellationPolicy
                                                    || 'Flexible: Full refund 24 hours before check-in' %>
                                            </p>
                                            <p class="policy-subtext">Review the host's full cancellation policy for
                                                details.</p>
                                            <button class="show-more-link" data-policy-trigger="cancellation">
                                                Show more <i class="fas fa-chevron-right"></i>
                                            </button>
                                        </div>

                                    </div>
                                </div>

                                <!-- Owner Management (if owner) -->
                                <% if (currUser && listing.owner._id.equals(currUser._id)) { %>
                                    <div class="amenities-section">
                                        <h2 class="section-title">Manage Listing</h2>
                                        <div class="d-flex gap-2">
                                            <a href="/listings/<%= listing._id %>/edit" class="btn btn-dark">
                                                <i class="fas fa-edit"></i> Edit Listing
                                            </a>
                                            <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE"
                                                class="d-inline">
                                                <button class="btn btn-danger">
                                                    <i class="fas fa-trash"></i> Delete Listing
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                    <% } %>

                                        <!-- Leave a Review (if logged in and not owner) -->
                                        <% if (currUser && !listing.owner._id.equals(currUser._id)) { %>
                                            <div class="amenities-section">
                                                <h2 class="section-title">Leave a review</h2>
                                                <form action="/listings/<%= listing._id %>/reviews" method="POST"
                                                    class="needs-validation" novalidate>
                                                    <div class="mb-3">
                                                        <label for="rating" class="form-label">Rating</label>
                                                        <fieldset class="starability-slot">
                                                            <input type="radio" id="no-rate" class="input-no-rate"
                                                                name="review[rating]" value="1" checked
                                                                aria-label="No rating." />
                                                            <input type="radio" id="first-rate1" name="review[rating]"
                                                                value="1" />
                                                            <label for="first-rate1" title="Terrible">1 star</label>
                                                            <input type="radio" id="first-rate2" name="review[rating]"
                                                                value="2" />
                                                            <label for="first-rate2" title="Not good">2 stars</label>
                                                            <input type="radio" id="first-rate3" name="review[rating]"
                                                                value="3" />
                                                            <label for="first-rate3" title="Average">3 stars</label>
                                                            <input type="radio" id="first-rate4" name="review[rating]"
                                                                value="4" />
                                                            <label for="first-rate4" title="Very good">4 stars</label>
                                                            <input type="radio" id="first-rate5" name="review[rating]"
                                                                value="5" />
                                                            <label for="first-rate5" title="Amazing">5 stars</label>
                                                        </fieldset>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="comment" class="form-label">Comments</label>
                                                        <textarea name="review[comment]" id="comment" cols="30" rows="5"
                                                            class="form-control" required></textarea>
                                                        <div class="invalid-feedback">Please add some comments for
                                                            review</div>
                                                    </div>
                                                    <button class="btn btn-primary">Submit Review</button>
                                                </form>
                                            </div>
                                            <% } %>

                    </div>

                    <!-- Right Column: Sticky Booking Card -->
                    <div class="listing-sidebar">
                        <div class="booking-card">
                            <div class="booking-price">
                                <span class="price-amount">₹<%= listing.price.toLocaleString('en-IN') %></span>
                                <span class="price-period">/ night</span>
                            </div>

                            <div class="booking-dates">
                                <div class="date-input-group">
                                    <label class="date-label">Check-in</label>
                                    <input type="date" class="date-input" id="check-in-date" />
                                </div>
                                <div class="date-input-group">
                                    <label class="date-label">Checkout</label>
                                    <input type="date" class="date-input" id="check-out-date" />
                                </div>
                            </div>

                            <div class="guests-selector" id="guests-selector">
                                <div>
                                    <div class="date-label">Guests</div>
                                    <div id="guests-text">2 guests</div>
                                </div>
                                <i class="fas fa-chevron-down"></i>
                            </div>

                            <!-- Guests Dropdown -->
                            <div class="guests-dropdown" id="guests-dropdown"
                                style="display: none; border: 1px solid #ddd; border-radius: 8px; padding: 16px; margin-top: 8px;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <div class="fw-600">Adults</div>
                                        <div class="text-secondary" style="font-size: 14px;">Ages 13+</div>
                                    </div>
                                    <div class="d-flex align-items-center gap-3">
                                        <button type="button" class="btn btn-sm btn-outline-secondary"
                                            id="adults-minus">-</button>
                                        <span id="adults-count">2</span>
                                        <button type="button" class="btn btn-sm btn-outline-secondary"
                                            id="adults-plus">+</button>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-600">Children</div>
                                        <div class="text-secondary" style="font-size: 14px;">Ages 0-12</div>
                                    </div>
                                    <div class="d-flex align-items-center gap-3">
                                        <button type="button" class="btn btn-sm btn-outline-secondary"
                                            id="children-minus">-</button>
                                        <span id="children-count">0</span>
                                        <button type="button" class="btn btn-sm btn-outline-secondary"
                                            id="children-plus">+</button>
                                    </div>
                                </div>
                            </div>

                            <button class="reserve-btn" id="reserve-btn">Reserve</button>

                            <p class="booking-note">You won't be charged yet</p>

                            <div class="price-breakdown">
                                <div class="price-row">
                                    <span id="nights-display">₹<%= listing.price.toLocaleString('en-IN') %> × 1
                                            night</span>
                                    <span id="subtotal-display">₹<%= listing.price.toLocaleString('en-IN') %></span>
                                </div>
                                <div class="price-row">
                                    <span>Cleaning fee</span>
                                    <span id="cleaning-fee-display">₹<%= Math.max(Math.round(listing.price * 0.1),
                                            500).toLocaleString('en-IN') %></span>
                                </div>
                                <div class="price-row">
                                    <span>Service fee</span>
                                    <span id="service-fee-display">₹<%= Math.round((listing.price +
                                            Math.max(Math.round(listing.price * 0.1), 500)) *
                                            0.05).toLocaleString('en-IN') %>
                                    </span>
                                </div>
                                <div class="price-row" id="extra-guest-fee-row" style="display: none;">
                                    <span>Extra guest fee</span>
                                    <span id="extra-guest-fee-display">₹0</span>
                                </div>
                                <div class="price-row total">
                                    <span>Total</span>
                                    <span id="total-display">₹<%= (listing.price + Math.max(Math.round(listing.price *
                                            0.1), 500) + Math.round((listing.price + Math.max(Math.round(listing.price *
                                            0.1), 500)) * 0.05)).toLocaleString('en-IN') %></span>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Mobile Sticky Booking Bar -->
                <div class="mobile-booking-bar">
                    <div class="mobile-booking-content">
                        <div class="mobile-price">
                            <span class="mobile-price-amount" id="mobile-price-amount">₹<%=
                                    listing.price.toLocaleString('en-IN') %></span>
                            <span class="mobile-price-period">/ night</span>
                        </div>
                        <button class="mobile-reserve-btn" id="mobile-reserve-btn">Reserve</button>
                    </div>
                </div>

                <!-- Booking Modal (existing) -->
                <div class="modal fade" id="listingBookingModal" tabindex="-1" aria-labelledby="listingBookingLabel"
                    aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="listingBookingLabel">Reserve stay at <%= listing.title %>
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <% if (!currUser) { %>
                                    <div class="alert alert-warning mb-0">
                                        Please <a href="/login" class="alert-link">log in</a> to make a reservation.
                                    </div>
                                    <% } else if (listing.owner && listing.owner._id.equals(currUser._id)) { %>
                                        <div class="alert alert-info mb-0">
                                            You cannot book your own listing.
                                        </div>
                                        <% } else { %>
                                            <form id="listing-booking-form">
                                                <input type="hidden" id="listing-id" value="<%= listing._id %>">
                                                <div class="row g-3">
                                                    <div class="col-12">
                                                        <label for="booking-start-date" class="form-label">Check-in
                                                            Date</label>
                                                        <input type="date" id="booking-start-date" name="startDate"
                                                            class="form-control" required>
                                                    </div>
                                                    <div class="col-12">
                                                        <label for="booking-end-date" class="form-label">Check-out
                                                            Date</label>
                                                        <input type="date" id="booking-end-date" name="endDate"
                                                            class="form-control" required>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label for="booking-guests" class="form-label">Number of
                                                            Guests</label>
                                                        <input type="number" id="booking-guests" name="guests"
                                                            class="form-control" min="1" max="20" value="2" required>
                                                    </div>
                                                    <div class="col-12">
                                                        <label for="booking-message" class="form-label">Special Requests
                                                            <span class="text-muted small">(optional)</span></label>
                                                        <textarea id="booking-message" name="message"
                                                            class="form-control" rows="3"
                                                            placeholder="Allergies, special occasions..."></textarea>
                                                    </div>
                                                </div>
                                                <div class="mt-3 p-3 bg-light rounded border">
                                                    <div class="d-flex justify-content-between">
                                                        <span class="fw-semibold">Estimated Amount</span>
                                                        <span id="listing-booking-amount" class="fw-bold">₹<%=
                                                                listing.price.toLocaleString('en-IN') %></span>
                                                    </div>
                                                    <small class="text-muted d-block mt-1">₹<%=
                                                            listing.price.toLocaleString('en-IN') %> per night · Secure
                                                            payment
                                                            via Stripe</small>
                                                </div>
                                                <div class="mt-3">
                                                    <div class="alert alert-danger d-none" id="listing-booking-error">
                                                    </div>
                                                    <div class="alert alert-success d-none"
                                                        id="listing-booking-success"></div>
                                                </div>
                                                <div class="modal-footer px-0">
                                                    <button type="button" class="btn btn-outline-secondary"
                                                        data-bs-dismiss="modal">Cancel</button>
                                                    <button type="submit" class="btn btn-primary"
                                                        id="listing-booking-submit-btn">
                                                        <span class="spinner-border spinner-border-sm me-2 d-none"
                                                            role="status" aria-hidden="true"
                                                            id="listing-booking-spinner"></span>
                                                        Proceed to Payment
                                                    </button>
                                                </div>
                                            </form>
                                            <% } %>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- JavaScript Files -->
                <script src="/js/image-gallery.js"></script>
                <script src="/js/amenities-modal.js"></script>
                <script src="/js/policies-modal.js"></script>
                <script src="/js/contact-host.js"></script>
                <script src="/js/booking-widget.js"></script>
                <script src="/js/wishlist-handler.js"></script>
                <script src="/js/reviews-component.js"></script>
                <script src="/js/wanderlust-calendar.js"></script>


                <script>
                    document.addEventListener('DOMContentLoaded', function () {

                        // Initialize Contact Host Modal
                        new ContactHostModal();

                        // Initialize Policies Modal
                        const policiesData = {
                            houseRules: listing.houseRules || ['No smoking', 'No pets', 'No parties'],
                            safetyGuidelines: listing.safetyGuidelines || ['Smoke alarm', 'Carbon monoxide alarm'],
                            cancellationPolicy: listing.cancellationPolicy || 'Flexible: Full refund 24 hours before check-in'
                        };
                        new PoliciesModal(policiesData);

                        // Initialize Image Gallery
                        const images = listing.images && listing.images.length > 0
                            ? listing.images
                            : [{ url: listing.image.url, caption: listing.title }];

                        const gallery = new ImageGallery('image-gallery-container', images);

                        // Initialize Amenities Modal
                        const amenities = listing.amenities || [];
                        const amenitiesModal = new AmenitiesModal(amenities);

                        const showAmenitiesBtn = document.getElementById('show-all-amenities');
                        if (showAmenitiesBtn) {
                            showAmenitiesBtn.addEventListener('click', () => amenitiesModal.open());
                        }

                        // Initialize Booking Widget
                        const bookingWidget = new BookingWidget(
                            listing._id,
                            listing.price,
                            {
                                maxGuests: listing.guests || listing.capacity || 10,
                                defaultAdults: 2,
                                defaultChildren: 0
                            }
                        );

                        // Initialize Wishlist Handler
                        const wishlistHandler = new WishlistHandler();
                        wishlistHandler.updateWishlistIcon(listing._id);

                        // Initialize Reviews Component
                        const reviews = listing.reviews || [];
                        const overallRating = reviews.length > 0
                            ? reviews.reduce((sum, r) => sum + r.rating, 0) / reviews.length
                            : 0;

                        const currUserId = "<%= currUser ? currUser._id : '' %>";
                        window.reviewsComponent = new ReviewsComponent(reviews, overallRating, listing._id, currUserId);
                        reviewsComponent.render('reviews-display-container');

                        // Initialize Calendar
                        if (typeof WanderLustCalendar === 'function') {
                            const today = new Date();
                            const nextMonth = new Date(today);
                            nextMonth.setMonth(today.getMonth() + 3);

                            const calendar = new WanderLustCalendar('availabilityCalendar', {
                                showHeader: true,
                                showWeekdays: true,
                                showToday: true,
                                minDate: today,
                                maxDate: nextMonth
                            });
                        }

                        // Initialize Map
                        const listingCoords = listing.geometry.coordinates;
                        if (listingCoords && listingCoords.length === 2) {
                            const enhancedMap = new EnhancedMap('map', {
                                mapToken: mapToken,
                                center: listingCoords,
                                zoom: 14,
                                searchEnabled: false,
                                clusterEnabled: false
                            });

                            // Create Custom Marker Element (Black Home Circle)
                            const el = document.createElement('div');
                            el.className = 'custom-map-marker home-marker';
                            el.innerHTML = `
                        <div class="marker-content">
                            <i class="fas fa-home"></i>
                        </div>
                    `;

                            // Add listing marker with custom element
                            enhancedMap.addMarker('listing', listingCoords, {
                                customElement: el,
                                title: listing.title,
                                description: `Exact location provided after booking`,
                                popup: true,
                                offset: [-25, -25] // Center the 50px marker
                            });

                            // Add approximate location circle (Privacy Circle)
                            enhancedMap.map.on('load', () => {
                                enhancedMap.map.addLayer({
                                    id: 'privacy-circle',
                                    type: 'circle',
                                    source: {
                                        type: 'geojson',
                                        data: {
                                            type: 'Feature',
                                            geometry: {
                                                type: 'Point',
                                                coordinates: listingCoords
                                            }
                                        }
                                    },
                                    paint: {
                                        'circle-radius': 120,    // Good size for "approximate area"
                                        'circle-color': '#000000',
                                        'circle-opacity': 0.2,   // Greyish shading
                                        'circle-stroke-width': 0 // No border for cleaner look
                                    }
                                });
                            });

                            // Add user location and route
                            const userCoords = [75.93, 19.85]; // Default location
                            enhancedMap.addMarker('user', userCoords, {
                                color: '#3b82f6',
                                icon: 'user',
                                size: 'medium',
                                title: 'Your Location',
                                popup: true
                            });

                            // Transport mode handling removed (feature deprecated)
                        }

                        // Policy grid logic is now CSS-only, no JS needed for accordion


                        // Booking form handler (existing)
                        const bookingForm = document.getElementById('listing-booking-form');
                        if (bookingForm) {
                            bookingForm.addEventListener('submit', async (e) => {
                                e.preventDefault();

                                const startDate = document.getElementById('booking-start-date').value;
                                const endDate = document.getElementById('booking-end-date').value;
                                const guests = document.getElementById('booking-guests').value;
                                const listingId = document.getElementById('listing-id').value;

                                if (!startDate || !endDate) {
                                    document.getElementById('listing-booking-error').textContent = 'Please select dates';
                                    document.getElementById('listing-booking-error').classList.remove('d-none');
                                    return;
                                }

                                const nights = Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24));
                                const totalPrice = listing.price * nights;

                                try {
                                    const response = await fetch('/bookings/create-checkout-session', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        credentials: 'same-origin',
                                        body: JSON.stringify({
                                            type: 'listing',
                                            listingId,
                                            startDate,
                                            endDate,
                                            guests,
                                            totalPrice,
                                            nights
                                        })
                                    });

                                    const data = await response.json();
                                    if (data.url) {
                                        window.location.href = data.url;
                                    } else {
                                        throw new Error('No checkout URL');
                                    }
                                } catch (err) {
                                    console.error(err);
                                    document.getElementById('listing-booking-error').textContent = 'Booking failed. Please try again.';
                                    document.getElementById('listing-booking-error').classList.remove('d-none');
                                }
                            });
                        }

                    });
                </script>

    </body>