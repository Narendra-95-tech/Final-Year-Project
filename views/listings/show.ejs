<% layout("/layouts/boilerplate") -%>

    <!-- Link CSS Files -->
    <link rel="stylesheet" href="/css/listing-details.css">
    <link rel="stylesheet" href="/css/calendar.css">
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        /* Custom Flatpickr Visibility Improvements */
        .flatpickr-day {
            color: #222 !important;
            font-weight: 600 !important;
            font-size: 15px !important;
        }

        .flatpickr-day.flatpickr-disabled,
        .flatpickr-day.flatpickr-disabled:hover {
            color: #d1d5db !important;
            /* Lighter but still readable */
            background-color: transparent !important;
            border-color: transparent !important;
            opacity: 1 !important;
            cursor: not-allowed;
            text-decoration: none !important;
        }

        .flatpickr-day.prevMonthDay,
        .flatpickr-day.nextMonthDay {
            color: #e5e7eb !important;
        }

        .flatpickr-weekday {
            color: #1a1a1a !important;
            font-weight: 700 !important;
        }

        .flatpickr-current-month .flatpickr-monthDropdown-months {
            font-weight: 700 !important;
        }

        .flatpickr-calendar {
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border: none;
            padding: 10px;
        }

        .flatpickr-day.selected {
            background: #fe6b00 !important;
            border-color: #fe6b00 !important;
        }

        /* Premium Date Input Styling */
        .date-input {
            border: none;
            background: transparent;
            font-size: 1rem;
            font-weight: 600;
            color: #222;
            padding: 0;
            width: 100%;
            cursor: pointer;
        }

        .date-input:focus {
            outline: none;
        }
    </style>
    <script src="/js/wishlist-handler.js"></script>
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <body class="listing-details-page">





        <!-- Listing Data (JSON) -->
        <script type="application/json" id="listing-data">
    <%- JSON.stringify(listing) %>
  </script>

        <script>
            const mapToken = "<%= process.env.MAP_TOKEN %>";
            const listing = JSON.parse(document.getElementById('listing-data').textContent);
            const currUserId = "<%= currUser ? currUser._id : '' %>";
            const isOwner = "<%= currUser && listing.owner._id.equals(currUser._id) ? 'true' : 'false' %>" === 'true';

        </script>

        <!-- Image Gallery Section -->
        <div id="image-gallery-container"></div>

        <!-- Main Content Grid -->
        <div class="listing-details-grid">

            <!-- Left Column: Main Content -->
            <div class="listing-main-content">

                <!-- Property Header & Subtitle -->
                <div class="property-header">
                    <div class="property-header-top">
                        <h1 class="property-title">
                            <%= listing.title %>
                        </h1>
                        <div class="header-actions">
                            <% const isWishlisted=currUser && currUser.wishlist && currUser.wishlist.some(id=>
                                id.toString() === listing._id.toString()); %>
                                <%- include('../partials/socialShare', { itemId: listing._id, isWishlisted,
                                    shareTitle: 'Share this listing' , currentUrl: `https://${process.env.HOST
                                    || 'localhost:8080' }/listings/${listing._id}`, shareText: `Check
                                    out '${listing.title}' on WanderLust`, shareSubject: `Check out '${listing.title}'
                                    on WanderLust` }) %>
                        </div>
                    </div>
                    <div class="property-subtitle-row">
                        <span class="property-specs">
                            <%= listing.guests || 2 %> guests ·
                                <%= listing.bedrooms || 1 %> bedroom ·
                                    <%= listing.beds || listing.bedrooms || 1 %> bed ·
                                        <%= listing.bathrooms || 1 %> bathroom
                        </span>
                        <% if (listing.reviews && listing.reviews.length> 0) { %>
                            <span class="property-rating-row">
                                <span class="separator">·</span>
                                <i class="fas fa-star text-black"></i>
                                <span class="rating-val">
                                    <%= (listing.reviews.reduce((sum, r)=> sum + r.rating, 0) /
                                        listing.reviews.length).toFixed(1) %>
                                </span>
                                <span class="review-count underline">
                                    <%= listing.reviews.length %> reviews
                                </span>
                            </span>
                            <% } %>
                    </div>
                </div>

                <hr class="section-divider">

                <!-- Enhanced Host Profile Card -->
                <div class="host-profile-card-premium" data-aos="fade-up">
                    <div class="host-card-top">
                        <div class="host-avatar-wrapper">
                            <img src="<%= listing.owner.avatar?.url || '/images/default-avatar.png' %>"
                                alt="<%= listing.owner.username %>" class="host-avatar-xl" />
                            <% if(listing.owner.isVerified) { %>
                                <div class="host-verified-badge" title="Verified Explorer">
                                    <i class="fas fa-check"></i>
                                </div>
                                <% } %>
                        </div>
                        <div class="host-intro">
                            <h2 class="host-name-large">
                                Hosted by <%= listing.owner.username %>
                                    <% if(listing.owner.isVerified) { %>
                                        <i class="fas fa-shield-check text-info ms-2" style="font-size: 18px;"
                                            title="Verified Explorer"></i>
                                        <% } %>
                            </h2>
                            <p class="host-meta-text">
                                <%= listing.owner.isVerified ? 'Verified Explorer' : 'Superhost' %> · Joined in <%= new
                                        Date(listing.owner.createdAt).getFullYear() %>
                            </p>
                        </div>
                    </div>
                    <div class="host-card-stats">
                        <div class="host-stat">
                            <div class="stat-value">4.9</div>
                            <div class="stat-label">Rating</div>
                        </div>
                        <div class="host-stat">
                            <div class="stat-value">120</div>
                            <div class="stat-label">Reviews</div>
                        </div>
                        <div class="host-stat">
                            <div class="stat-value">100%</div>
                            <div class="stat-label">Response rate</div>
                        </div>
                    </div>
                </div>

                <hr class="section-divider">

                <!-- Property Highlights (Vertical List) -->
                <div class="property-highlights-list-premium">
                    <div class="highlight-item-premium" data-aos="fade-right" data-aos-delay="100">
                        <i class="highlight-icon-p fas fa-medal"></i>
                        <div class="highlight-info-p">
                            <div class="highlight-title-p">Elite Stay</div>
                            <div class="highlight-sub-p">One of the most loved homes on WanderLust based on guest
                                reviews.</div>
                        </div>
                    </div>

                    <div class="highlight-item-premium" data-aos="fade-right" data-aos-delay="200">
                        <i class="highlight-icon-p fas fa-key"></i>
                        <div class="highlight-info-p">
                            <div class="highlight-title-p">Self check-in</div>
                            <div class="highlight-sub-p">Check yourself in with the smart lock.</div>
                        </div>
                    </div>

                    <div class="highlight-item-premium" data-aos="fade-right" data-aos-delay="300">
                        <i class="highlight-icon-p fas fa-shield-alt"></i>
                        <div class="highlight-info-p">
                            <div class="highlight-title-p">Safety first</div>
                            <div class="highlight-sub-p">Equipped with smoke alarm, carbon monoxide detector, and first
                                aid kit.</div>
                        </div>
                    </div>

                    <% if (listing.amenities && (listing.amenities.includes('Workspace') ||
                        listing.amenities.includes('WiFi'))) { %>
                        <div class="highlight-item-premium" data-aos="fade-right" data-aos-delay="400">
                            <i class="highlight-icon-p fas fa-laptop-house"></i>
                            <div class="highlight-info-p">
                                <div class="highlight-title-p">Work-ready space</div>
                                <div class="highlight-sub-p">A dedicated area with fast wifi, perfect for digital
                                    nomads.</div>
                            </div>
                        </div>
                        <% } %>
                </div>

                <hr class="section-divider">

                <!-- Description -->
                <div class="property-description">
                    <!-- <h2 class="section-title">About this place</h2> -->
                    <p class="description-text line-clamp">
                        <%= listing.description %>
                    </p>
                    <button class="show-more-desc-btn">
                        Show more
                    </button>
                </div>

                <hr class="section-divider">

                <!-- Amenities Section -->
                <div class="amenities-section">
                    <h2 class="section-title">What this place offers</h2>
                    <div class="amenities-grid" id="amenities-grid">
                        <% const amenities=(listing.amenities && listing.amenities.length> 0) ? listing.amenities : [
                            'Kitchen',
                            'Wifi',
                            'Free parking on premises',
                            'Pool',
                            'TV',
                            'Lift',
                            'Washing machine',
                            'Air conditioning',
                            'Unavailable: Carbon monoxide alarm',
                            'Unavailable: Smoke alarm'
                            ];
                            const topAmenities = amenities.slice(0, 10);

                            const amenityIcons = {
                            'WiFi': 'fa-wifi',
                            'Kitchen': 'fa-utensils',
                            'Free parking': 'fa-car',
                            'Parking': 'fa-car',
                            'Pool': 'fa-swimming-pool',
                            'Hot tub': 'fa-water',
                            'TV': 'fa-tv',
                            'Air conditioning': 'fa-snowflake',
                            'AC': 'fa-snowflake',
                            'Heating': 'fa-temperature-high',
                            'Washing machine': 'fa-soap',
                            'Washer': 'fa-soap',
                            'Dryer': 'fa-wind',
                            'Lift': 'fa-elevator',
                            'Elevator': 'fa-elevator',
                            'Workspace': 'fa-laptop',
                            'Gym': 'fa-dumbbell',
                            'Breakfast': 'fa-coffee',
                            'Fireplace': 'fa-fire',
                            'Iron': 'fa-tshirt',
                            'Hair dryer': 'fa-wind',
                            'Shampoo': 'fa-pump-soap',
                            'Carbon monoxide alarm': 'fa-ban',
                            'Smoke alarm': 'fa-ban',
                            'First aid kit': 'fa-medkit',
                            'Fire extinguisher': 'fa-fire-extinguisher'
                            };

                            function getIcon(name) {
                            const cleanName = name.replace('Unavailable: ', '').trim();
                            const key = Object.keys(amenityIcons).find(k =>
                            cleanName.toLowerCase().includes(k.toLowerCase()));
                            return key ? amenityIcons[key] : 'fa-check-circle';
                            }
                            %>

                            <% topAmenities.forEach(amenity=> {
                                const isUnavailable = amenity.toLowerCase().includes('unavailable');
                                const iconClass = getIcon(amenity);
                                %>
                                <div class="amenity-item <%= isUnavailable ? 'amenity-unavailable' : '' %>">
                                    <i class="amenity-icon fas <%= iconClass %>"></i>
                                    <span>
                                        <%= amenity.replace('Unavailable: ', '') %></span>
                            </div>
                        <% }) %>
                    </div>
                    <% if (amenities.length> 0) { %>
                        <button class="show-all-amenities-btn" id="show-all-amenities">
                            Show all <%= amenities.length %> amenities
                        </button>
                        <% } %>
                </div>

                <!-- Calendar Section -->
                <div class="amenities-section">
                    <h2 class="section-title">Availability</h2>
                    <div class="card">
                        <div class="card-body p-4">
                            <div id="availabilityCalendar" class="wanderlust-calendar" style="min-height: 400px;"></div>
                        </div>
                    </div>
                </div>

                <!-- Reviews Section -->
                <div id="reviews-display-container"></div>

                <!-- Map Section -->
                <div class="map-section mt-5" data-aos="fade-up">
                    <h2 class="section-title">Where you' ll be</h2>
                                            <p class="text-secondary mb-3">
                                                <%= listing.location %>, <%= listing.country %>
                                            </p>
                                            <div class="map-container-premium">
                                                <div id="map" style="width: 100%; height: 500px; border-radius: 16px;">
                                                </div>

                                                <!-- Premium Map Overlay Controls -->
                                                <div class="map-overlay-controls">
                                                    <button id="btn-3d-tour" class="map-p-btn"
                                                        title="3D Neighborhood Tour">
                                                        <i class="fas fa-cube"></i> <span>3D Tour</span>
                                                    </button>
                                                    <button id="btn-pois-toggle" class="map-p-btn"
                                                        title="Show Local Gems">
                                                        <i class="fas fa-map-marker-alt"></i> <span>Local Gems</span>
                                                    </button>
                                                </div>

                                                <!-- Travel Time Card -->
                                                <div id="travel-time-card" class="travel-time-card-p">
                                                    <div class="eta-header-p">Travel Time from You</div>
                                                    <div class="eta-row-p">
                                                        <div class="eta-item-p"><i class="fas fa-walking"></i> <span
                                                                id="eta-walking">Calculating...</span></div>
                                                        <div class="eta-item-p"><i class="fas fa-car"></i> <span
                                                                id="eta-driving">...</span></div>
                                                        <div class="eta-item-p"><i class="fas fa-bicycle"></i> <span
                                                                id="eta-cycling">...</span></div>
                                                    </div>
                                                </div>
                                            </div>
                                </div>



                                <!-- Policies Section -->
                                <!-- Things to Know Section -->
                                <div class="policies-section">
                                    <h2 class="section-title">Things to know</h2>
                                    <div class="policies-grid">

                                        <!-- House Rules -->
                                        <div class="policy-column">
                                            <h3 class="policy-header-title">House rules</h3>
                                            <ul class="policy-list">
                                                <li>Check-in: After 2:00 PM</li>
                                                <li>Checkout: Before 11:00 AM</li>
                                                <% if (listing.houseRules && listing.houseRules.length> 0) { %>
                                                    <% listing.houseRules.slice(0, 3).forEach(rule=> { %>
                                                        <li>
                                                            <%= rule %>
                                                        </li>
                                                        <% }) %>
                                                            <% } else { %>
                                                                <li>No smoking</li>
                                                                <li>No pets</li>
                                                                <li>No parties or events</li>
                                                                <% } %>
                                            </ul>
                                            <% if (listing.houseRules && listing.houseRules.length> 3) { %>
                                                <button class="show-more-link" data-policy-trigger="houseRules">
                                                    Show more <i class="fas fa-chevron-right"></i>
                                                </button>
                                                <% } %>
                                        </div>

                                        <!-- Safety & Property -->
                                        <div class="policy-column">
                                            <h3 class="policy-header-title">Safety & property</h3>
                                            <ul class="policy-list">
                                                <% if (listing.safetyGuidelines && listing.safetyGuidelines.length> 0) {
                                                    %>
                                                    <% listing.safetyGuidelines.slice(0, 3).forEach(item=> { %>
                                                        <li>
                                                            <%= item %>
                                                        </li>
                                                        <% }) %>
                                                            <% } else { %>
                                                                <li>Smoke alarm installed</li>
                                                                <li>Carbon monoxide alarm</li>
                                                                <li>First aid kit available</li>
                                                                <% } %>
                                            </ul>
                                            <% if (listing.safetyGuidelines && listing.safetyGuidelines.length> 3) { %>
                                                <button class="show-more-link" data-policy-trigger="safety">
                                                    Show more <i class="fas fa-chevron-right"></i>
                                                </button>
                                                <% } %>
                                        </div>

                                        <!-- Cancellation Policy -->
                                        <div class="policy-column">
                                            <h3 class="policy-header-title">Cancellation policy</h3>
                                            <p class="policy-text">
                                                <%= listing.cancellationPolicy
                                                    || 'Flexible: Full refund 24 hours before check-in' %>
                                            </p>
                                            <p class="policy-subtext">Review the host's full cancellation policy for
                                                details.</p>
                                            <button class="show-more-link" data-policy-trigger="cancellation">
                                                Show more <i class="fas fa-chevron-right"></i>
                                            </button>
                                        </div>

                                    </div>
                                </div>

                                <!-- Owner Management (if owner) -->
                                <% if (currUser && listing.owner._id.equals(currUser._id)) { %>
                                    <div class="amenities-section">
                                        <h2 class="section-title">Manage Listing</h2>
                                        <div class="d-flex gap-2">
                                            <a href="/listings/<%= listing._id %>/edit" class="btn btn-dark">
                                                <i class="fas fa-edit"></i> Edit Listing
                                            </a>
                                            <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE"
                                                class="d-inline">
                                                <button class="btn btn-danger">
                                                    <i class="fas fa-trash"></i> Delete Listing
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                    <% } %>

                                        <!-- Leave a Review (if logged in and not owner) -->
                                        <% if (currUser && !listing.owner._id.equals(currUser._id)) { %>
                                            <div class="review-section">
                                                <div class="review-form-card">
                                                    <div class="review-form-header">
                                                        <i class="fas fa-star-half-alt"></i>
                                                        <h2 class="section-title mb-0">Leave a review</h2>
                                                    </div>
                                                    <p class="review-form-subtitle">Share your experience with other
                                                        guests</p>

                                                    <form action="/listings/<%= listing._id %>/reviews" method="POST"
                                                        class="needs-validation" novalidate
                                                        enctype="multipart/form-data">
                                                        <div class="mb-4">
                                                            <label for="rating" class="form-label fw-600">Your
                                                                Rating</label>
                                                            <fieldset class="starability-slot">
                                                                <input type="radio" id="no-rate" class="input-no-rate"
                                                                    name="review[rating]" value="1" checked
                                                                    aria-label="No rating." />
                                                                <input type="radio" id="first-rate1"
                                                                    name="review[rating]" value="1" />
                                                                <label for="first-rate1" title="Terrible">1 star</label>
                                                                <input type="radio" id="first-rate2"
                                                                    name="review[rating]" value="2" />
                                                                <label for="first-rate2" title="Not good">2
                                                                    stars</label>
                                                                <input type="radio" id="first-rate3"
                                                                    name="review[rating]" value="3" />
                                                                <label for="first-rate3" title="Average">3 stars</label>
                                                                <input type="radio" id="first-rate4"
                                                                    name="review[rating]" value="4" />
                                                                <label for="first-rate4" title="Very good">4
                                                                    stars</label>
                                                                <input type="radio" id="first-rate5"
                                                                    name="review[rating]" value="5" />
                                                                <label for="first-rate5" title="Amazing">5 stars</label>
                                                            </fieldset>
                                                        </div>
                                                        <div class="mb-4">
                                                            <label for="comment" class="form-label fw-600">Your
                                                                Comments</label>
                                                            <textarea name="review[comment]" id="comment" cols="30"
                                                                rows="4" class="form-control review-textarea"
                                                                placeholder="Tell us what you loved about this place..."
                                                                required></textarea>
                                                            <div class="invalid-feedback">Please share some feedback
                                                                about your stay.</div>
                                                        </div>
                                                        <div class="mb-4">
                                                            <label for="images" class="form-label fw-600">Add
                                                                Photos</label>
                                                            <input type="file" name="review[images]" id="images"
                                                                class="form-control" multiple>
                                                        </div>
                                                        <button class="btn-submit-review">
                                                            <span>Submit Review</span>
                                                            <i class="fas fa-paper-plane"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                            <% } %>

                    </div>

                    <!-- Right Column: Sticky Booking Card -->
                    <div class="listing-sidebar">
                        <div class="booking-card">
                            <div class="booking-price">
                                <span class="price-amount">₹<%= listing.price.toLocaleString('en-IN') %></span>
                                <span class="price-period">/ night</span>
                            </div>

                            <div class="booking-dates">
                                <div class="date-input-group">
                                    <label class="date-label">Check-in</label>
                                    <input type="text" class="date-input" id="check-in-date" placeholder="Add date"
                                        readonly />
                                </div>
                                <div class="date-input-group">
                                    <label class="date-label">Checkout</label>
                                    <input type="text" class="date-input" id="check-out-date" placeholder="Add date"
                                        readonly />
                                </div>
                            </div>

                            <div class="guests-selector-wrapper position-relative">
                                <div class="guests-selector" id="guests-selector">
                                    <div>
                                        <div class="date-label">Guests</div>
                                        <div id="guests-text">1 guest</div>
                                    </div>
                                    <i class="fas fa-chevron-down"></i>
                                </div>

                                <!-- Guests Dropdown -->
                                <div class="guests-dropdown" id="guests-dropdown">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <div>
                                            <div class="fw-600">Adults</div>
                                            <div class="text-secondary" style="font-size: 14px;">Ages 13+</div>
                                        </div>
                                        <div class="d-flex align-items-center gap-3">
                                            <button type="button" class="btn btn-sm btn-outline-secondary"
                                                id="adults-minus">-</button>
                                            <span id="adults-count">1</span>
                                            <button type="button" class="btn btn-sm btn-outline-secondary"
                                                id="adults-plus">+</button>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="fw-600">Children</div>
                                            <div class="text-secondary" style="font-size: 14px;">Ages 0-12</div>
                                        </div>
                                        <div class="d-flex align-items-center gap-3">
                                            <button type="button" class="btn btn-sm btn-outline-secondary"
                                                id="children-minus">-</button>
                                            <span id="children-count">0</span>
                                            <button type="button" class="btn btn-sm btn-outline-secondary"
                                                id="children-plus">+</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <% if (currUser && listing.owner._id.equals(currUser._id)) { %>
                                <div class="owner-management-card p-3 bg-light rounded-3 border mb-3">
                                    <div class="d-flex align-items-center gap-2 mb-3 text-primary">
                                        <i class="fas fa-user-shield"></i>
                                        <span class="fw-bold">Owner Management</span>
                                    </div>
                                    <div class="d-grid gap-2">
                                        <a href="/listings/<%= listing._id %>/edit"
                                            class="btn btn-primary d-flex align-items-center justify-content-center gap-2">
                                            <i class="fas fa-edit"></i> Edit Listing
                                        </a>
                                        <form action="/listings/<%= listing._id %>?_method=DELETE" method="POST"
                                            class="d-grid">
                                            <button type="submit"
                                                class="btn btn-outline-danger d-flex align-items-center justify-content-center gap-2"
                                                onclick="return confirm('Are you sure you want to delete this listing?')">
                                                <i class="fas fa-trash-alt"></i> Delete Listing
                                            </button>
                                        </form>
                                    </div>
                                </div>
                                <button class="reserve-btn w-100 opacity-50 cursor-not-allowed" disabled>Owner View
                                    Only</button>
                                <% } else { %>
                                    <button class="reserve-btn" id="reserve-btn">Reserve</button>
                                    <% } %>

                                        <p class="booking-note text-center mt-2">You won't be charged yet</p>

                                        <div class="price-breakdown">
                                            <div class="price-row">
                                                <span id="nights-display">₹<%= listing.price.toLocaleString('en-IN') %>
                                                        × 1
                                                        night</span>
                                                <span id="subtotal-display">₹<%= listing.price.toLocaleString('en-IN')
                                                        %></span>
                                            </div>
                                            <div class="price-row">
                                                <span>Cleaning fee</span>
                                                <span id="cleaning-fee-display">₹<%= Math.max(Math.round(listing.price *
                                                        0.1), 500).toLocaleString('en-IN') %></span>
                                            </div>
                                            <div class="price-row">
                                                <span>Service fee</span>
                                                <span id="service-fee-display">₹<%= Math.round((listing.price +
                                                        Math.max(Math.round(listing.price * 0.1), 500)) *
                                                        0.05).toLocaleString('en-IN') %>
                                                </span>
                                            </div>
                                            <div class="price-row" id="extra-guest-fee-row" style="display: none;">
                                                <span>Extra guest fee</span>
                                                <span id="extra-guest-fee-display">₹0</span>
                                            </div>
                                            <div class="price-row total">
                                                <span>Total</span>
                                                <span id="total-display">₹<%= (listing.price +
                                                        Math.max(Math.round(listing.price * 0.1), 500) +
                                                        Math.round((listing.price + Math.max(Math.round(listing.price *
                                                        0.1), 500)) * 0.05)).toLocaleString('en-IN') %></span>
                                            </div>
                                        </div>
                        </div>
                    </div>

                </div>

                <!-- Mobile Sticky Booking Bar -->
                <div class="mobile-booking-bar">
                    <div class="mobile-booking-content">
                        <div class="mobile-price">
                            <span class="mobile-price-amount" id="mobile-price-amount">₹<%=
                                    listing.price.toLocaleString('en-IN') %></span>
                            <span class="mobile-price-period">/ night</span>
                        </div>
                        <% if (currUser && listing.owner._id.equals(currUser._id)) { %>
                            <div class="d-flex gap-2 align-items-center">
                                <a href="/listings/<%= listing._id %>/edit"
                                    class="btn btn-outline-dark btn-sm rounded-pill">Edit</a>
                                <span class="badge bg-primary rounded-pill px-3 py-2">Owner</span>
                            </div>
                            <% } else { %>
                                <button class="mobile-reserve-btn" id="mobile-reserve-btn">Reserve</button>
                                <% } %>
                    </div>
                </div>

                <!-- Booking Modal (existing) -->
                <div class="modal fade" id="listingBookingModal" tabindex="-1" aria-labelledby="listingBookingLabel"
                    aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="listingBookingLabel">Reserve stay at <%= listing.title %>
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <% if (!currUser) { %>
                                    <div class="alert alert-warning mb-0">
                                        Please <a href="/login" class="alert-link">log in</a> to make a reservation.
                                    </div>
                                    <% } else if (listing.owner && listing.owner._id.equals(currUser._id)) { %>
                                        <div class="alert alert-info mb-0">
                                            You cannot book your own listing.
                                        </div>
                                        <% } else { %>
                                            <form id="listing-booking-form">
                                                <input type="hidden" id="listing-id" value="<%= listing._id %>">
                                                <div class="row g-3">
                                                    <div class="col-12">
                                                        <label for="booking-start-date" class="form-label">Check-in
                                                            Date</label>
                                                        <input type="date" id="booking-start-date" name="startDate"
                                                            class="form-control" required>
                                                    </div>
                                                    <div class="col-12">
                                                        <label for="booking-end-date" class="form-label">Check-out
                                                            Date</label>
                                                        <input type="date" id="booking-end-date" name="endDate"
                                                            class="form-control" required>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label for="booking-guests" class="form-label">Number of
                                                            Guests</label>
                                                        <input type="number" id="booking-guests" name="guests"
                                                            class="form-control" min="1" max="20" value="2" required>
                                                    </div>
                                                    <div class="col-12">
                                                        <label for="booking-message" class="form-label">Special Requests
                                                            <span class="text-muted small">(optional)</span></label>
                                                        <textarea id="booking-message" name="message"
                                                            class="form-control" rows="3"
                                                            placeholder="Allergies, special occasions..."></textarea>
                                                    </div>
                                                </div>
                                                <div class="mt-3 p-3 bg-light rounded border">
                                                    <div class="d-flex justify-content-between">
                                                        <span class="fw-semibold">Estimated Amount</span>
                                                        <span id="listing-booking-amount" class="fw-bold">₹<%=
                                                                listing.price.toLocaleString('en-IN') %></span>
                                                    </div>
                                                    <small class="text-muted d-block mt-1">₹<%=
                                                            listing.price.toLocaleString('en-IN') %> per night · Secure
                                                            payment
                                                            via Stripe</small>
                                                </div>
                                                <div class="mt-3">
                                                    <div class="alert alert-danger d-none" id="listing-booking-error">
                                                    </div>
                                                    <div class="alert alert-success d-none"
                                                        id="listing-booking-success"></div>
                                                </div>
                                                <div class="modal-footer px-0">
                                                    <button type="button" class="btn btn-outline-secondary"
                                                        data-bs-dismiss="modal">Cancel</button>
                                                    <button type="submit" class="btn btn-primary"
                                                        id="listing-booking-submit-btn">
                                                        <span class="spinner-border spinner-border-sm me-2 d-none"
                                                            role="status" aria-hidden="true"
                                                            id="listing-booking-spinner"></span>
                                                        Proceed to Payment
                                                    </button>
                                                </div>
                                            </form>
                                            <% } %>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- JavaScript Files -->
                <script src="/js/image-gallery.js"></script>
                <script src="/js/amenities-modal.js"></script>
                <script src="/js/policies-modal.js"></script>
                <script src="/js/contact-host.js"></script>
                <script src="/js/booking-widget.js"></script>
                <script src="/js/wishlist-handler.js"></script>
                <script src="/js/reviews-component.js"></script>
                <script src="/js/wanderlust-calendar.js"></script>


                <script>
                    document.addEventListener('DOMContentLoaded', function () {

                        // Initialize Contact Host Modal
                        new ContactHostModal();

                        // Initialize Policies Modal
                        const policiesData = {
                            houseRules: listing.houseRules || ['No smoking', 'No pets', 'No parties'],
                            safetyGuidelines: listing.safetyGuidelines || ['Smoke alarm', 'Carbon monoxide alarm'],
                            cancellationPolicy: listing.cancellationPolicy || 'Flexible: Full refund 24 hours before check-in'
                        };
                        new PoliciesModal(policiesData);

                        // Initialize Image Gallery
                        const images = listing.images && listing.images.length > 0
                            ? listing.images
                            : [{ url: listing.image.url, caption: listing.title }];

                        const gallery = new ImageGallery('image-gallery-container', images);

                        // Initialize Amenities Modal
                        const amenities = listing.amenities || [];
                        const amenitiesModal = new AmenitiesModal(amenities);

                        const showAmenitiesBtn = document.getElementById('show-all-amenities');
                        if (showAmenitiesBtn) {
                            showAmenitiesBtn.addEventListener('click', () => amenitiesModal.open());
                        }

                        // Initialize Booking Widget
                        const bookingWidget = new BookingWidget(
                            listing._id,
                            listing.price,
                            {
                                maxGuests: listing.guests || listing.capacity || 10,
                                defaultAdults: 2,
                                defaultChildren: 0
                            }
                        );

                        // Initialize Wishlist Handler
                        const wishlistHandler = new WishlistHandler();
                        wishlistHandler.updateWishlistIcon(listing._id);

                        // Initialize Reviews Component
                        const reviews = listing.reviews || [];
                        const overallRating = reviews.length > 0
                            ? reviews.reduce((sum, r) => sum + r.rating, 0) / reviews.length
                            : 0;

                        const currUserId = "<%= currUser ? currUser._id : '' %>";
                        window.reviewsComponent = new ReviewsComponent(reviews, overallRating, listing._id, currUserId, 'listings');
                        reviewsComponent.render('reviews-display-container');

                        // Initialize Flatpickr for Booking Inputs
                        const checkInInput = document.getElementById('check-in-date');
                        const checkOutInput = document.getElementById('check-out-date');

                        if (checkInInput && checkOutInput) {
                            const today = new Date();

                            const fpStart = flatpickr(checkInInput, {
                                minDate: "today",
                                dateFormat: "Y-m-d",
                                altInput: true,
                                altFormat: "D, d M",
                                showMonths: 1,
                                onChange: function (selectedDates, dateStr, instance) {
                                    if (selectedDates.length > 0) {
                                        // Update minDate for checkout
                                        // We can use the dateStr directly since it matches dateFormat (Y-m-d)
                                        fpEnd.set('minDate', dateStr);

                                        // Auto-open checkout if check-in is selected
                                        setTimeout(() => fpEnd.open(), 100);
                                    }
                                    // Trigger change for existing logic
                                    checkInInput.dispatchEvent(new Event('change'));
                                }
                            });

                            const fpEnd = flatpickr(checkOutInput, {
                                minDate: "today",
                                dateFormat: "Y-m-d",
                                altInput: true,
                                altFormat: "D, d M",
                                showMonths: 1,
                                onChange: function (selectedDates, dateStr, instance) {
                                    // Trigger change for existing logic
                                    checkOutInput.dispatchEvent(new Event('change'));
                                }
                            });

                            // Sync with main calendar if it exists
                            if (typeof WanderLustCalendar === 'function') {
                                const nextMonth = new Date(today);
                                nextMonth.setMonth(today.getMonth() + 3);

                                // Keep the main availability calendar as visual reference
                                const calendar = new WanderLustCalendar('availabilityCalendar', {
                                    showHeader: true,
                                    showWeekdays: true,
                                    showToday: true,
                                    minDate: today,
                                    maxDate: nextMonth,
                                    onDateSelect: (startDate, endDate) => {
                                        if (startDate) fpStart.setDate(startDate, true);
                                        if (endDate) fpEnd.setDate(endDate, true);
                                    }
                                });
                            }
                        }

                        // Initialize Map
                        const listingCoords = listing.geometry.coordinates;
                        if (listingCoords && listingCoords.length === 2) {
                            const enhancedMap = new EnhancedMap('map', {
                                mapToken: mapToken,
                                center: listingCoords,
                                zoom: 14,
                                searchEnabled: true,
                                clusterEnabled: false
                            });

                            // Create Custom Marker Element (Black Home Circle)
                            const el = document.createElement('div');
                            el.className = 'custom-map-marker home-marker';
                            el.innerHTML = `
                        <div class="marker-content">
                            <i class="fas fa-home"></i>
                        </div>
                    `;

                            // Add listing marker with custom element
                            enhancedMap.addMarker('listing', listingCoords, {
                                customElement: el,
                                title: listing.title,
                                description: `Exact location provided after booking`,
                                popup: true,
                                offset: [-25, -25] // Center the 50px marker
                            });

                            // Add approximate location circle (Privacy Circle)
                            enhancedMap.map.on('load', () => {
                                enhancedMap.map.addLayer({
                                    id: 'privacy-circle',
                                    type: 'circle',
                                    source: {
                                        type: 'geojson',
                                        data: {
                                            type: 'Feature',
                                            geometry: {
                                                type: 'Point',
                                                coordinates: listingCoords
                                            }
                                        }
                                    },
                                    paint: {
                                        'circle-radius': 120,    // Good size for "approximate area"
                                        'circle-color': '#000000',
                                        'circle-opacity': 0.2,   // Greyish shading
                                        'circle-stroke-width': 0 // No border for cleaner look
                                    }
                                });
                            });

                            // Add user location and route
                            const userCoords = [75.93, 19.85]; // Default location
                            enhancedMap.addMarker('user', userCoords, {
                                color: '#3b82f6',
                                icon: 'user',
                                size: 'medium',
                                title: 'Your Location',
                                popup: true
                            });

                            // 3D Tour Button
                            const btn3d = document.getElementById('btn-3d-tour');
                            let isOrbiting = false;
                            if (btn3d) {
                                btn3d.addEventListener('click', () => {
                                    if (isOrbiting) {
                                        enhancedMap.stopOrbit();
                                        btn3d.classList.remove('active');
                                        btn3d.querySelector('span').textContent = '3D Tour';
                                    } else {
                                        enhancedMap.orbitTo(listingCoords);
                                        btn3d.classList.add('active');
                                        btn3d.querySelector('span').textContent = 'Stop Tour';
                                    }
                                    isOrbiting = !isOrbiting;
                                });
                            }

                            // POIs Toggle
                            const btnPois = document.getElementById('btn-pois-toggle');
                            let poisEnabled = false;
                            if (btnPois) {
                                btnPois.addEventListener('click', () => {
                                    poisEnabled = !poisEnabled;
                                    enhancedMap.togglePOIsLayer(poisEnabled);
                                    btnPois.classList.toggle('active', poisEnabled);
                                });
                            }

                            // Calculate ETAs
                            setTimeout(async () => {
                                const etas = await enhancedMap.getTravelTimes(listingCoords);
                                if (etas) {
                                    document.getElementById('eta-walking').textContent = enhancedMap.formatDuration(etas.walking);
                                    document.getElementById('eta-driving').textContent = enhancedMap.formatDuration(etas.driving);
                                    document.getElementById('eta-cycling').textContent = enhancedMap.formatDuration(etas.cycling);
                                    document.getElementById('travel-time-card').classList.add('visible');
                                } else {
                                    document.getElementById('travel-time-card').style.display = 'none';
                                }
                            }, 2000);

                        }

                        // Policy grid logic is now CSS-only, no JS needed for accordion


                        // Booking form handler (existing)
                        const bookingForm = document.getElementById('listing-booking-form');
                        if (bookingForm) {
                            bookingForm.addEventListener('submit', async (e) => {
                                e.preventDefault();

                                const startDate = document.getElementById('booking-start-date').value;
                                const endDate = document.getElementById('booking-end-date').value;
                                const guests = document.getElementById('booking-guests').value;
                                const listingId = document.getElementById('listing-id').value;

                                if (!startDate || !endDate) {
                                    document.getElementById('listing-booking-error').textContent = 'Please select dates';
                                    document.getElementById('listing-booking-error').classList.remove('d-none');
                                    return;
                                }

                                const nights = Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24));
                                const totalPrice = listing.price * nights;

                                try {
                                    const response = await fetch('/bookings/create-checkout-session', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        credentials: 'same-origin',
                                        body: JSON.stringify({
                                            type: 'listing',
                                            listingId,
                                            startDate,
                                            endDate,
                                            guests,
                                            totalPrice,
                                            nights
                                        })
                                    });

                                    const data = await response.json();
                                    if (data.url) {
                                        window.location.href = data.url;
                                    } else {
                                        throw new Error('No checkout URL');
                                    }
                                } catch (err) {
                                    console.error(err);
                                    document.getElementById('listing-booking-error').textContent = 'Booking failed. Please try again.';
                                    document.getElementById('listing-booking-error').classList.remove('d-none');
                                }
                            });
                        }

                    });
                </script>

    </body>