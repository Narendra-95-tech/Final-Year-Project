<% layout("/layouts/boilerplate") -%>

  <body>

    <script type="application/json" id="listing-data">
    <%- JSON.stringify(listing) %>
  </script>
    <script>
      const mapToken = "<%= process.env.MAP_TOKEN %>";
      const listing = JSON.parse(document.getElementById('listing-data').textContent);
    </script>

    <!-- Listing Title -->
    <div class="row mt-3 justify-content-center">
      <div class="col-md-8 text-center">
        <h3>
          <%= listing.title %>
        </h3>
        <!-- Social Sharing -->
        <div class="mt-2">
          <%- include('../partials/socialShare', { currentUrl: `https://${process.env.HOST || 'localhost:3000'
            }/listings/${listing._id}`, shareText: `Check out '${listing.title}' on WanderLust -
            ${listing.description.substring(0, 100)}...`, shareSubject: `Check out '${listing.title}' on WanderLust` })
            %>
        </div>
      </div>
    </div>

    <!-- Listing Card -->
    <div class="row justify-content-center mb-4">
      <div class="col-md-6">
        <div class="card listing-card">
          <img src="<%= listing.image.url %>" class="card-img-top show-img" alt="listing_image">
          <div class="card-body">
            <p class="card-text"><i>Owned by <%= listing.owner.username %></i></p>
            <p class="card-text">
              <%= listing.description %>
            </p>
            <p class="card-text">&#8377;<%= listing.price.toLocaleString("en-IN") %>
            </p>
            <p class="card-text">
              <%= listing.location %>
            </p>
            <p class="card-text">
              <%= listing.country %>
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Property Features -->
    <%- include('../partials/featureSection', { icon: 'fas fa-home' , title: 'Property Features' , features: [ {
      icon: 'fas fa-users' , title: 'Guests' , description: `Up to ${listing.capacity || 'N/A' } guests` }, {
      icon: 'fas fa-bed' , title: 'Bedrooms' , description: listing.bedrooms ? `${listing.bedrooms} ${listing.bedrooms>
      1 ? 'bedrooms' : 'bedroom'}` : 'N/A'
      },
      {
      icon: 'fas fa-bath',
      title: 'Bathrooms',
      description: listing.bathrooms ? `${listing.bathrooms} ${listing.bathrooms > 1 ? 'bathrooms' : 'bathroom'}` :
      'N/A'
      },
      {
      icon: 'fas fa-wifi',
      title: 'Amenities',
      description: listing.amenities && listing.amenities.length > 0
      ? listing.amenities.slice(0, 3).join(', ') + (listing.amenities.length > 3 ? '...' : '')
      : 'Basic amenities included'
      },
      {
      icon: 'fas fa-map-marker-alt',
      title: 'Location',
      description: listing.location || 'Prime location'
      },
      {
      icon: 'fas fa-star',
      title: 'Rating',
      description: listing.rating ? `${listing.rating}/5 (${listing.reviews ? listing.reviews.length : 0} reviews)` :
      'No reviews yet'
      }
      ]
      }) %>

      <!-- Availability Calendar -->
      <div class="row justify-content-center mb-4">
        <div class="col-md-8">
          <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
              <h6 class="mb-0">Check Availability</h6>
              <div class="text-white-50 small">
                <span class="d-inline-flex align-items-center">
                  <span class="d-inline-block w-2 h-2 bg-orange-500 rounded-circle mr-1"></span>
                  Today's Date
                </span>
              </div>
            </div>
            <div class="card-body p-4">
              <div id="availabilityCalendar" class="wanderlust-calendar"
                style="min-height: 400px; color: #222222 !important;">
                <div class="calendar-container">
                  <div class="calendar-header">
                    <button class="calendar-nav-button prev-month">
                      <i class="fas fa-chevron-left"></i>
                    </button>
                    <h2 class="calendar-title">Loading Calendar...</h2>
                    <button class="calendar-nav-button next-month">
                      <i class="fas fa-chevron-right"></i>
                    </button>
                  </div>
                  <div class="calendar-weekdays"></div>
                  <div class="calendar-days"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      </div>

      <% if(true) { %>
        <!-- Booking Card -->
        <div class="row justify-content-center mb-4">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-primary text-white">
                <h6 class="mb-0">Reserve this Stay</h6>
              </div>
              <div class="card-body">
                <p class="text-muted small mb-3">Secure online payment powered by Stripe. Free cancellation up to 24
                  hours before check-in.</p>
                <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#listingBookingModal">
                  <i class="fa fa-calendar-check me-2"></i>Book Now
                </button>
              </div>
            </div>
          </div>
        </div>
        <% } %>

          <!-- Owner: Manage Listing Card -->
          <% if(currUser && listing.owner._id.equals(currUser._id)) { %>
            <div class="row justify-content-center mb-4">
              <div class="col-md-6">
                <div class="card shadow-sm p-2 compact-card">
                  <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Manage Listing</h6>
                    <div>
                      <a href="/listings/<%= listing._id %>/edit" class="btn btn-sm btn-dark me-1">Edit</a>
                      <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE" class="d-inline">
                        <button class="btn btn-sm btn-danger">Delete</button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <% } %>

              <!-- Reviews Section -->
              <div class="col-8 offset-3 mb-3">
                <% if(currUser) { %>
                  <hr>
                  <h4>Leave a review</h4>
                  <form action="/listings/<%= listing._id %>/reviews" method="POST" novalidate class="needs-validation">
                    <div class="mb-3 mt-3">
                      <label for="rating" class="form-label">Rating</label>
                      <fieldset class="starability-slot">
                        <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="1" checked
                          aria-label="No rating." />
                        <input type="radio" id="first-rate1" name="review[rating]" value="1" />
                        <label for="first-rate1" title="Terrible">1 star</label>
                        <input type="radio" id="first-rate2" name="review[rating]" value="2" />
                        <label for="first-rate2" title="Not good">2 stars</label>
                        <input type="radio" id="first-rate3" name="review[rating]" value="3" />
                        <label for="first-rate3" title="Average">3 stars</label>
                        <input type="radio" id="first-rate4" name="review[rating]" value="4" />
                        <label for="first-rate4" title="Very good">4 stars</label>
                        <input type="radio" id="first-rate5" name="review[rating]" value="5" />
                        <label for="first-rate5" title="Amazing">5 stars</label>
                      </fieldset>
                    </div>
                    <div class="mb-3 mt-3">
                      <label for="comment" class="form-label">Comments</label>
                      <textarea name="review[comment]" id="comment" cols="30" rows="5" class="form-control"
                        required></textarea>
                      <div class="invalid-feedback">Please add some comments for review</div>
                    </div>
                    <button class="btn btn-outline-dark">Submit</button>
                  </form>
                  <hr>
                  <% } %>

                    <% if(listing.reviews.length> 0) { %>
                      <div class="row">
                        <p><b>All Reviews</b></p>
                        <% for(review of listing.reviews) { %>
                          <div class="card col-5 mb-3 ms-3">
                            <div class="card-body">
                              <h5 class="card-title">@<%= review.author.username %>
                              </h5>
                              <p class="starability-result card-text" data-rating="<%= review.rating%>"></p>
                              <p class="card-text">
                                <%= review.comment %>
                              </p>
                            </div>
                            <form class="mb-3" method="POST"
                              action="/listings/<%=listing._id %>/reviews/<%= review._id %>?_method=DELETE">
                              <button class="btn btn-sm btn-dark">Delete</button>
                            </form>
                          </div>
                          <% } %>
                      </div>
                      <% } %>
              </div>

              <!-- Booking Modal -->
              <div class="modal fade" id="listingBookingModal" tabindex="-1" aria-labelledby="listingBookingLabel"
                aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="listingBookingLabel">Reserve stay at <%= listing.title %>
                      </h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <% if (!currUser) { %>
                        <div class="alert alert-warning mb-0">
                          Please <a href="/login" class="alert-link">log in</a> to make a reservation.
                        </div>
                        <% } else if (listing.owner && listing.owner._id.equals(currUser._id)) { %>
                          <div class="alert alert-info mb-0">
                            You cannot book your own listing.
                          </div>
                          <% } else { %>
                            <form id="listing-booking-form">
                              <input type="hidden" id="listing-id" value="<%= listing._id %>">
                              <div class="row g-3">
                                <div class="col-12">
                                  <label for="booking-start-date" class="form-label">Check-in Date</label>
                                  <input type="date" id="booking-start-date" name="startDate" class="form-control"
                                    required>
                                </div>
                                <div class="col-12">
                                  <label for="booking-end-date" class="form-label">Check-out Date</label>
                                  <input type="date" id="booking-end-date" name="endDate" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                  <label for="booking-guests" class="form-label">Number of Guests</label>
                                  <input type="number" id="booking-guests" name="guests" class="form-control" min="1"
                                    max="20" value="2" required>
                                </div>
                                <div class="col-12">
                                  <label for="booking-message" class="form-label">Special Requests <span
                                      class="text-muted small">(optional)</span></label>
                                  <textarea id="booking-message" name="message" class="form-control" rows="3"
                                    placeholder="Allergies, special occasions..."></textarea>
                                </div>
                              </div>
                              <div class="mt-3 p-3 bg-light rounded border">
                                <div class="d-flex justify-content-between">
                                  <span class="fw-semibold">Estimated Amount</span>
                                  <span id="listing-booking-amount" class="fw-bold">‚Çπ<%= listing.price ?
                                      Number(listing.price).toLocaleString("en-IN") : "0" %></span>
                                </div>
                                <small class="text-muted d-block mt-1">‚Çπ<%= listing.price ?
                                    Number(listing.price).toLocaleString("en-IN") : "N/A" %> per night ¬∑ Secure payment
                                    via Stripe</small>
                              </div>
                              <div class="mt-3">
                                <div class="alert alert-danger d-none" id="listing-booking-error"></div>
                                <div class="alert alert-success d-none" id="listing-booking-success"></div>
                              </div>
                              <div class="modal-footer px-0">
                                <button type="button" class="btn btn-outline-secondary"
                                  data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-primary" id="listing-booking-submit-btn">
                                  <span class="spinner-border spinner-border-sm me-2 d-none" role="status"
                                    aria-hidden="true" id="listing-booking-spinner"></span>
                                  Proceed to Payment
                                </button>
                              </div>
                            </form>
                            <% } %>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Map Section -->
              <div class="col-6 offset-3 mb-3">
                <h3>Where you'll be</h3>
                <div id="map" style="height:400px;border-radius:15px;"></div>
              </div>

              <!-- Transport Mode Selection -->
              <div class="transport-selector-container mb-3">
                <label class="transport-label fw-bold mb-2 d-block text-center">Choose Your Transport Mode:</label>

                <!-- Transport Comparison Bar -->
                <div class="transport-comparison d-flex justify-content-center mb-3">
                  <div class="comparison-item">
                    <span class="comparison-label">‚ö° Fastest:</span>
                    <span class="comparison-value fastest">üöó Car</span>
                  </div>
                  <div class="comparison-item">
                    <span class="comparison-label">üí∞ Cheapest:</span>
                    <span class="comparison-value cheapest">üö∂ Walk</span>
                  </div>
                  <div class="comparison-item">
                    <span class="comparison-label">üå± Eco-friendly:</span>
                    <span class="comparison-value eco">üö¥ Bike</span>
                  </div>
                </div>

                <div class="transport-modes d-flex justify-content-center gap-2 flex-wrap">
                  <button class="transport-btn active" data-mode="driving" data-icon="üöó" data-color="#ff6b6b"
                    data-cost="medium" data-speed="fast" data-eco="low">
                    <span class="transport-icon">üöó</span>
                    <span class="transport-text">Car</span>
                    <span class="transport-time">~15 min</span>
                    <span class="transport-cost">‚Çπ50-80</span>
                    <div class="transport-badges">
                      <span class="badge speed-fast">‚ö°</span>
                      <span class="badge cost-medium">üí∞</span>
                    </div>
                  </button>
                  <button class="transport-btn" data-mode="walking" data-icon="üö∂" data-color="#4ecdc4" data-cost="free"
                    data-speed="slow" data-eco="high">
                    <span class="transport-icon">üö∂</span>
                    <span class="transport-text">Walk</span>
                    <span class="transport-time">~45 min</span>
                    <span class="transport-cost">Free</span>
                    <div class="transport-badges">
                      <span class="badge eco-high">üå±</span>
                      <span class="badge cost-free">üíö</span>
                    </div>
                  </button>
                  <button class="transport-btn" data-mode="cycling" data-icon="üö¥" data-color="#45b7d1" data-cost="low"
                    data-speed="medium" data-eco="high">
                    <span class="transport-icon">üö¥</span>
                    <span class="transport-text">Bike</span>
                    <span class="transport-time">~25 min</span>
                    <span class="transport-cost">‚Çπ20-40</span>
                    <div class="transport-badges">
                      <span class="badge eco-high">üå±</span>
                      <span class="badge cost-low">üí∞</span>
                    </div>
                  </button>
                  <button class="transport-btn" data-mode="bus" data-icon="üöå" data-color="#96ceb4" data-cost="low"
                    data-speed="medium" data-eco="medium">
                    <span class="transport-icon">üöå</span>
                    <span class="transport-text">Bus</span>
                    <span class="transport-time">~30 min</span>
                    <span class="transport-cost">‚Çπ15-25</span>
                    <div class="transport-badges">
                      <span class="badge cost-low">üí∞</span>
                      <span class="badge eco-medium">üå±</span>
                    </div>
                  </button>
                </div>

                <!-- Transport Details Panel -->
                <div class="transport-details-panel mt-3" id="transport-details">
                  <div class="details-header">
                    <h5 class="details-title">üöó Car - Quick & Comfortable</h5>
                    <button class="close-details" onclick="closeTransportDetails()">√ó</button>
                  </div>
                  <div class="details-content">
                    <div class="detail-row">
                      <span class="detail-label">‚è±Ô∏è Duration:</span>
                      <span class="detail-value">15-20 minutes</span>
                    </div>
                    <div class="detail-row">
                      <span class="detail-label">üí∞ Cost:</span>
                      <span class="detail-value">‚Çπ50-80 (including parking)</span>
                    </div>
                    <div class="detail-row">
                      <span class="detail-label">üåç Environment:</span>
                      <span class="detail-value">Medium impact</span>
                    </div>
                    <div class="detail-row">
                      <span class="detail-label">üéØ Best for:</span>
                      <span class="detail-value">Groups, luggage, weather protection</span>
                    </div>
                    <div class="detail-features">
                      <span class="feature-tag">‚úì Door-to-door</span>
                      <span class="feature-tag">‚úì Climate control</span>
                      <span class="feature-tag">‚úì Privacy</span>
                    </div>
                  </div>
                </div>

                <!-- Filter Options -->
                <div class="transport-filters mt-3">
                  <label class="filter-label">Quick filters:</label>
                  <div class="filter-buttons">
                    <button class="filter-btn" onclick="filterTransports('fastest')">
                      ‚ö° Fastest
                    </button>
                    <button class="filter-btn" onclick="filterTransports('cheapest')">
                      üí∞ Cheapest
                    </button>
                    <button class="filter-btn" onclick="filterTransports('eco')">
                      üå± Eco-friendly
                    </button>
                    <button class="filter-btn active" onclick="filterTransports('all')">
                      üîÑ All
                    </button>
                  </div>
                </div>

                <!-- Hidden select for compatibility -->
                <select id="transport-mode" class="d-none">
                  <option value="driving" selected>üöó Car</option>
                  <option value="walking">üö∂ Walking</option>
                  <option value="cycling">üö¥ Cycling</option>
                  <option value="bus">üöå Bus</option>
                </select>
              </div>

              <style>
                .transport-selector-container {
                  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                  border-radius: 15px;
                  padding: 20px;
                  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
                  border: 1px solid rgba(255, 107, 107, 0.1);
                }

                .transport-label {
                  color: #2c3e50;
                  font-size: 1.1rem;
                  margin-bottom: 15px !important;
                }

                /* Comparison Bar */
                .transport-comparison {
                  gap: 20px;
                  margin-bottom: 20px !important;
                }

                .comparison-item {
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  padding: 8px 12px;
                  background: white;
                  border-radius: 8px;
                  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
                }

                .comparison-label {
                  font-size: 11px;
                  color: #666;
                  margin-bottom: 2px;
                }

                .comparison-value {
                  font-weight: bold;
                  font-size: 14px;
                }

                .comparison-value.fastest {
                  color: #ff6b6b;
                }

                .comparison-value.cheapest {
                  color: #28a745;
                }

                .comparison-value.eco {
                  color: #17a2b8;
                }

                /* Transport Buttons */
                .transport-modes {
                  gap: 12px;
                }

                .transport-btn {
                  background: white;
                  border: 2px solid #e9ecef;
                  border-radius: 12px;
                  padding: 12px 16px;
                  cursor: pointer;
                  transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  min-width: 90px;
                  position: relative;
                  overflow: hidden;
                }

                .transport-btn:hover {
                  transform: translateY(-2px);
                  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
                  border-color: #ff6b6b;
                }

                .transport-btn.active {
                  background: linear-gradient(135deg, #ff6b6b, #ff8e53);
                  color: white;
                  border-color: #ff6b6b;
                  transform: scale(1.05);
                  box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
                }

                .transport-btn.active::before {
                  content: '';
                  position: absolute;
                  top: 0;
                  left: -100%;
                  width: 100%;
                  height: 100%;
                  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
                  animation: shimmer 2s infinite;
                }

                @keyframes shimmer {
                  0% {
                    left: -100%;
                  }

                  100% {
                    left: 100%;
                  }
                }

                .transport-icon {
                  font-size: 24px;
                  margin-bottom: 4px;
                  display: block;
                }

                .transport-text {
                  font-weight: 600;
                  font-size: 14px;
                  margin-bottom: 2px;
                }

                .transport-time {
                  font-size: 11px;
                  opacity: 0.8;
                  font-weight: 500;
                  margin-bottom: 2px;
                }

                .transport-cost {
                  font-size: 10px;
                  font-weight: 600;
                  color: #666;
                  margin-bottom: 4px;
                }

                .transport-btn:hover .transport-icon {
                  transform: scale(1.1);
                }

                .transport-btn.active .transport-time,
                .transport-btn.active .transport-cost {
                  opacity: 1;
                  color: white;
                }

                /* Badges */
                .transport-badges {
                  display: flex;
                  gap: 2px;
                  margin-top: 4px;
                }

                .badge {
                  font-size: 9px;
                  padding: 2px 4px;
                  border-radius: 4px;
                  background: rgba(0, 0, 0, 0.1);
                  color: #666;
                }

                .transport-btn.active .badge {
                  background: rgba(255, 255, 255, 0.2);
                  color: white;
                }

                /* Details Panel */
                .transport-details-panel {
                  background: white;
                  border-radius: 10px;
                  padding: 15px;
                  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                  border: 1px solid #e9ecef;
                  display: none;
                }

                .transport-details-panel.show {
                  display: block;
                  animation: slideDown 0.3s ease-out;
                }

                @keyframes slideDown {
                  from {
                    opacity: 0;
                    transform: translateY(-10px);
                  }

                  to {
                    opacity: 1;
                    transform: translateY(0);
                  }
                }

                .details-header {
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 10px;
                }

                .details-title {
                  margin: 0;
                  font-size: 16px;
                  color: #2c3e50;
                }

                .close-details {
                  background: none;
                  border: none;
                  font-size: 20px;
                  cursor: pointer;
                  color: #666;
                  padding: 0;
                  width: 24px;
                  height: 24px;
                  border-radius: 50%;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                }

                .close-details:hover {
                  background: #f0f0f0;
                }

                .detail-row {
                  display: flex;
                  justify-content: space-between;
                  margin-bottom: 8px;
                  padding: 5px 0;
                  border-bottom: 1px solid #f0f0f0;
                }

                .detail-label {
                  font-weight: 600;
                  color: #666;
                  font-size: 13px;
                }

                .detail-value {
                  font-weight: 500;
                  color: #333;
                  font-size: 13px;
                }

                .detail-features {
                  display: flex;
                  flex-wrap: wrap;
                  gap: 6px;
                  margin-top: 10px;
                }

                .feature-tag {
                  background: #e8f5e8;
                  color: #28a745;
                  padding: 4px 8px;
                  border-radius: 12px;
                  font-size: 11px;
                  font-weight: 500;
                }

                /* Filters */
                .transport-filters {
                  margin-top: 15px;
                  padding-top: 15px;
                  border-top: 1px solid #e9ecef;
                }

                .filter-label {
                  font-size: 13px;
                  color: #666;
                  margin-bottom: 8px;
                  display: block;
                }

                .filter-buttons {
                  display: flex;
                  gap: 8px;
                  justify-content: center;
                  flex-wrap: wrap;
                }

                .filter-btn {
                  background: white;
                  border: 1px solid #e9ecef;
                  border-radius: 20px;
                  padding: 6px 12px;
                  font-size: 12px;
                  cursor: pointer;
                  transition: all 0.2s ease;
                }

                .filter-btn:hover {
                  background: #f8f9fa;
                  border-color: #ff6b6b;
                }

                .filter-btn.active {
                  background: #ff6b6b;
                  color: white;
                  border-color: #ff6b6b;
                }

                /* Filtered states */
                .transport-btn.filtered-out {
                  opacity: 0.3;
                  transform: scale(0.9);
                  pointer-events: none;
                }
              </style>

              <script>
                document.addEventListener('DOMContentLoaded', function () {
                  const transportBtns = document.querySelectorAll('.transport-btn');
                  const transportSelect = document.getElementById('transport-mode');
                  const detailsPanel = document.getElementById('transport-details');

                  // Transport details data
                  const transportDetails = {
                    driving: {
                      title: 'üöó Car - Quick & Comfortable',
                      duration: '15-20 minutes',
                      cost: '‚Çπ50-80 (including parking)',
                      environment: 'Medium impact',
                      bestFor: 'Groups, luggage, weather protection',
                      features: ['‚úì Door-to-door', '‚úì Climate control', '‚úì Privacy', '‚úì Flexible timing']
                    },
                    walking: {
                      title: 'üö∂ Walking - Healthy & Free',
                      duration: '40-50 minutes',
                      cost: 'Completely free',
                      environment: 'Zero impact',
                      bestFor: 'Short distances, exercise, sightseeing',
                      features: ['‚úì No cost', '‚úì Great exercise', '‚úì See the city', '‚úì Eco-friendly']
                    },
                    cycling: {
                      title: 'üö¥ Bike - Fast & Eco-friendly',
                      duration: '20-30 minutes',
                      cost: '‚Çπ20-40 (bike rental)',
                      environment: 'Low impact',
                      bestFor: 'Moderate distances, fitness enthusiasts',
                      features: ['‚úì Eco-friendly', '‚úì Avoid traffic', '‚úì Good exercise', '‚úì Easy parking']
                    },
                    bus: {
                      title: 'üöå Bus - Economical & Convenient',
                      duration: '25-35 minutes',
                      cost: '‚Çπ15-25 (public transport)',
                      environment: 'Low impact',
                      bestFor: 'Budget travelers, longer distances',
                      features: ['‚úì Very affordable', '‚úì No parking worries', '‚úì Regular service', '‚úì Climate controlled']
                    }
                  };

                  transportBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                      // Remove active class from all buttons
                      transportBtns.forEach(b => b.classList.remove('active'));

                      // Add active class to clicked button
                      this.classList.add('active');

                      // Update hidden select
                      const mode = this.dataset.mode;
                      transportSelect.value = mode;

                      // Show transport details
                      showTransportDetails(mode);

                      // Trigger change event for existing functionality
                      transportSelect.dispatchEvent(new Event('change'));

                      // Add pulse animation
                      this.style.animation = 'pulse 0.6s ease-in-out';
                      setTimeout(() => {
                        this.style.animation = '';
                      }, 600);
                    });

                    // Add hover details preview
                    btn.addEventListener('mouseenter', function () {
                      const mode = this.dataset.mode;
                      updateComparisonHighlight(mode);
                    });
                  });

                  // Show transport details
                  function showTransportDetails(mode) {
                    const details = transportDetails[mode];
                    if (!details) return;

                    detailsPanel.querySelector('.details-title').textContent = details.title;

                    const detailRows = detailsPanel.querySelectorAll('.detail-value');
                    detailRows[0].textContent = details.duration;
                    detailRows[1].textContent = details.cost;
                    detailRows[2].textContent = details.environment;
                    detailRows[3].textContent = details.bestFor;

                    // Update features
                    const featuresContainer = detailsPanel.querySelector('.detail-features');
                    featuresContainer.innerHTML = details.features.map(feature =>
                      `<span class="feature-tag">${feature}</span>`
                    ).join('');

                    // Show panel with animation
                    detailsPanel.classList.add('show');
                  }

                  // Close transport details
                  window.closeTransportDetails = function () {
                    detailsPanel.classList.remove('show');
                  };

                  // Filter transports
                  window.filterTransports = function (filterType) {
                    // Update filter buttons
                    document.querySelectorAll('.filter-btn').forEach(btn => {
                      btn.classList.remove('active');
                    });
                    event.target.classList.add('active');

                    // Filter transport buttons
                    transportBtns.forEach(btn => {
                      btn.classList.remove('filtered-out');

                      if (filterType === 'fastest' && btn.dataset.speed !== 'fast') {
                        btn.classList.add('filtered-out');
                      } else if (filterType === 'cheapest' && btn.dataset.cost !== 'free' && btn.dataset.cost !== 'low') {
                        btn.classList.add('filtered-out');
                      } else if (filterType === 'eco' && btn.dataset.eco !== 'high') {
                        btn.classList.add('filtered-out');
                      }
                    });
                  };

                  // Update comparison highlight
                  function updateComparisonHighlight(mode) {
                    const comparisons = document.querySelectorAll('.comparison-value');
                    comparisons.forEach(comp => comp.style.fontWeight = 'normal');

                    if (mode === 'driving') {
                      document.querySelector('.comparison-value.fastest').style.fontWeight = 'bold';
                    } else if (mode === 'walking') {
                      document.querySelector('.comparison-value.cheapest').style.fontWeight = 'bold';
                    } else if (mode === 'cycling') {
                      document.querySelector('.comparison-value.eco').style.fontWeight = 'bold';
                    }
                  }

                  // Add pulse animation
                  const style = document.createElement('style');
                  style.textContent = `
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
  `;
                  document.head.appendChild(style);

                  // Show details for initially selected transport
                  const activeBtn = document.querySelector('.transport-btn.active');
                  if (activeBtn) {
                    showTransportDetails(activeBtn.dataset.mode);
                  }
                });
              </script>



              <!-- Calendar Component Script -->
              <script src="/js/calendar-component-new.js"></script>
              <script>
                // Function to format date as YYYY-MM-DD
                function formatDate(date) {
                  const d = new Date(date);
                  let month = '' + (d.getMonth() + 1);
                  let day = '' + d.getDate();
                  const year = d.getFullYear();

                  if (month.length < 2) month = '0' + month;
                  if (day.length < 2) day = '0' + day;

                  return [year, month, day].join('-');
                }

                // Function to ensure the calendar is visible
                function ensureCalendarVisibility() {
                  const calendarEl = document.getElementById('availabilityCalendar');
                  if (calendarEl) {
                    // Force show the calendar with important styles
                    calendarEl.style.opacity = '1';
                    calendarEl.style.visibility = 'visible';
                    calendarEl.style.display = 'block';

                    // Make sure all text is visible
                    const allText = calendarEl.querySelectorAll('*');
                    allText.forEach(el => {
                      el.style.color = '#222222';
                      el.style.opacity = '1';
                    });
                  }
                }

                // Load and initialize calendar
                function initCalendar() {
                  try {
                    if (typeof WanderlustCalendar === 'function') {
                      // Get the current date
                      const today = new Date();
                      const nextMonth = new Date(today);
                      nextMonth.setMonth(today.getMonth() + 3);

                      // Initialize the calendar with options
                      const calendar = new WanderlustCalendar('availabilityCalendar', {
                        showHeader: true,
                        showWeekdays: true,
                        showToday: true,
                        showClearBtn: true,
                        showWeekNumbers: false,
                        minDate: today,
                        maxDate: nextMonth,
                        onDateSelect: function (date) {
                          console.log('Selected date:', date);
                          // You can add your date selection logic here
                        },
                        onMonthChange: function (month, year) {
                          console.log(`Month changed to: ${month + 1}/${year}`);
                          // Ensure calendar remains visible after month change
                          setTimeout(ensureCalendarVisibility, 10);
                        }
                      });

                      // Force visibility after a short delay
                      setTimeout(ensureCalendarVisibility, 100);

                      console.log('Calendar initialized successfully');
                      return true;
                    } else {
                      console.error('WanderlustCalendar class not found');
                      return false;
                    }
                  } catch (error) {
                    console.error('Error initializing calendar:', error);
                    return false;
                  }
                }

                // Initialize when DOM is loaded
                document.addEventListener("DOMContentLoaded", function () {
                  // Initialize calendar with retry logic
                  if (!initCalendar()) {
                    const maxRetries = 5;
                    let retryCount = 0;

                    const retryInterval = setInterval(() => {
                      if (initCalendar() || retryCount >= maxRetries) {
                        clearInterval(retryInterval);
                        // One final check to ensure visibility
                        setTimeout(ensureCalendarVisibility, 100);
                      }
                      retryCount++;
                    }, 500);
                  }

                  // Initialize Enhanced Map
                  const listingCoords = listing.geometry.coordinates;
                  if (!listingCoords || listingCoords.length !== 2) {
                    document.getElementById("map").innerHTML = "<p class='text-center mt-3'>Map location not available</p>";
                    return;
                  }

                  // Initialize enhanced map with all features
                  const enhancedMap = new EnhancedMap('map', {
                    mapToken: mapToken,
                    center: listingCoords,
                    zoom: 16,
                    searchEnabled: true,
                    clusterEnabled: false,
                    mapStyle: 'mapbox://styles/mapbox/streets-v12',
                    showControls: true,
                    showScale: true,
                    showCompass: true,
                    showZoom: true,
                    showFullscreen: true,
                    showGeolocate: true
                  });

                  // Add listing marker with enhanced styling
                  enhancedMap.addMarker('listing', listingCoords, {
                    color: '#dc2626',
                    icon: 'home',
                    size: 'large',
                    title: listing.title,
                    description: `‚Çπ${listing.price.toLocaleString("en-IN")} per night | ${listing.location}`,
                    popup: true,
                    animate: true
                  });

                  // User location (default)
                  const userLat = 19.85;
                  const userLng = 75.93;
                  const userCoords = [userLng, userLat];

                  // Add user location marker with enhanced styling
                  enhancedMap.addMarker('user', userCoords, {
                    color: '#3b82f6',
                    icon: 'user',
                    size: 'medium',
                    title: 'Your Location',
                    description: 'Starting point',
                    popup: true,
                    animate: true
                  });

                  // Add route on transport mode change
                  async function updateRoute() {
                    const transportSelect = document.getElementById("transport-mode");
                    const transportMode = transportSelect.value;

                    try {
                      const routeData = await enhancedMap.addRoute('listing-route', [
                        userCoords,
                        listingCoords
                      ], {
                        color: '#007bff',
                        width: 4,
                        transportMode: transportMode
                      });

                      // Route calculated successfully
                    } catch (err) {
                      console.error('Route error:', err);
                    }
                  }

                  // Initial route
                  updateRoute();

                  // Event listeners
                  document.getElementById("refresh-location").addEventListener("click", updateRoute);
                  document.getElementById("transport-mode").addEventListener("change", updateRoute);
                });
              </script>

              <script>
                document.addEventListener("DOMContentLoaded", () => {
                  const bookingForm = document.getElementById("listing-booking-form");
                  if (!bookingForm) return;

                  const guestsInput = document.getElementById("booking-guests");
                  const amountDisplay = document.getElementById("listing-booking-amount");
                  const errorBox = document.getElementById("listing-booking-error");
                  const successBox = document.getElementById("listing-booking-success");
                  const submitBtn = document.getElementById("listing-booking-submit-btn");
                  const spinner = document.getElementById("listing-booking-spinner");
                  const startDateInput = document.getElementById("booking-start-date");
                  const endDateInput = document.getElementById("booking-end-date");
                  const messageInput = document.getElementById("booking-message");

                  const perNightPrice = Number(listing.price || 0);

                  const updateAmount = () => {
                    if (!amountDisplay || !startDateInput || !endDateInput) return;
                    const start = new Date(startDateInput.value);
                    const end = new Date(endDateInput.value);
                    if (start >= end) return;
                    const nights = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                    const guests = Math.max(1, Number(guestsInput?.value || 1));
                    const total = perNightPrice * nights * guests;
                    amountDisplay.textContent = `‚Çπ${total.toLocaleString("en-IN")}`;
                  };

                  if (startDateInput && endDateInput) {
                    const today = new Date();
                    const yyyy = today.getFullYear();
                    const mm = String(today.getMonth() + 1).padStart(2, "0");
                    const dd = String(today.getDate()).padStart(2, "0");
                    const minDate = `${yyyy}-${mm}-${dd}`;
                    startDateInput.min = minDate;
                    endDateInput.min = minDate;

                    startDateInput.addEventListener("change", () => {
                      endDateInput.min = startDateInput.value;
                      updateAmount();
                    });
                    endDateInput.addEventListener("change", updateAmount);
                  }

                  guestsInput?.addEventListener("input", updateAmount);
                  updateAmount();

                  const setFeedback = (type, message) => {
                    if (!errorBox || !successBox) return;
                    errorBox.classList.add("d-none");
                    successBox.classList.add("d-none");
                    if (type === "error") {
                      errorBox.textContent = message;
                      errorBox.classList.remove("d-none");
                    } else if (type === "success") {
                      successBox.textContent = message;
                      successBox.classList.remove("d-none");
                    }
                  };

                  const setLoading = (loading) => {
                    if (!submitBtn || !spinner) return;
                    submitBtn.disabled = loading;
                    spinner.classList.toggle("d-none", !loading);
                  };

                  bookingForm.addEventListener("submit", async (event) => {
                    event.preventDefault();

                    const startDate = startDateInput?.value;
                    const endDate = endDateInput?.value;
                    const guests = Math.max(1, Number(guestsInput?.value || 1));
                    const message = messageInput?.value || "";
                    const listingId = document.getElementById("listing-id")?.value;

                    if (!startDate || !endDate || new Date(endDate) <= new Date(startDate)) {
                      setFeedback("error", "Please select valid check-in and check-out dates.");
                      return;
                    }

                    if (!listingId) {
                      setFeedback("error", "Listing ID is missing. Please try again.");
                      return;
                    }

                    setFeedback();
                    setLoading(true);

                    try {
                      const bookingData = {
                        type: 'listing',
                        listingId,
                        startDate,
                        endDate,
                        guests,
                        totalPrice: Number(amountDisplay.textContent.replace(/[^\d]/g, '')),
                        nights: Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24))
                      };

                      console.log('Sending booking data:', bookingData);

                      // Create Stripe checkout session directly with all booking details
                      const checkoutRes = await fetch('/bookings/create-checkout-session', {
                        method: 'POST',
                        headers: {
                          'Content-Type': 'application/json',
                          'Accept': 'application/json'
                        },
                        credentials: 'same-origin',
                        body: JSON.stringify(bookingData)
                      });

                      let checkoutPayload;
                      try {
                        checkoutPayload = await checkoutRes.json();
                        console.log('Checkout response:', checkoutPayload);
                      } catch (e) {
                        console.error('Failed to parse checkout response:', e);
                        throw new Error('Invalid response from server');
                      }

                      if (!checkoutRes.ok) {
                        throw new Error(checkoutPayload.error || checkoutPayload.details || 'Payment setup failed');
                      }

                      if (!checkoutPayload.url) {
                        console.error('Missing URL in response:', checkoutPayload);
                        throw new Error('No checkout URL received');
                      }

                      setFeedback("success", "Redirecting to secure payment...");

                      // Redirect to Stripe Checkout
                      console.log('Redirecting to:', checkoutPayload.url);
                      window.location.href = checkoutPayload.url;
                    } catch (err) {
                      console.error(err);
                      setFeedback("error", "Unexpected error while booking. Please retry.");
                    } finally {
                      setLoading(false);
                    }
                  });
                });
              </script>

              });
              </script>

  </body>

  ```