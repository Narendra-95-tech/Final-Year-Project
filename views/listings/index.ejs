<% layout("/layouts/boilerplate") -%>

  <!-- Link to Airbnb-style Listings CSS -->
  <link rel="stylesheet" href="/css/listings-index.css">


  <% const params=queryParams || {}; function makeQueryString(overrides={}, removeKeys=[]) { const search=new
    URLSearchParams(); Object.entries(params).forEach(([key, value])=> {
    if (removeKeys.includes(key)) return;
    if (value !== undefined && value !== null && value !== '' && value !== 'all') {
    search.set(key, value);
    }
    });
    Object.entries(overrides).forEach(([key, value]) => {
    if (value === undefined || value === null || value === '' || value === 'all') {
    search.delete(key);
    } else {
    search.set(key, value);
    }
    });
    const result = search.toString();
    return result ? `?${result}` : '';
    }

    const hasActiveFilters = Boolean(
    (query && query.trim()) ||
    (category && category !== 'all') ||
    minPrice ||
    maxPrice ||
    guests
    );
    %>

    <!-- Hero Section -->
    <% if (!query) { %>
      <section class="listings-hero animate-fade-in">
        <div class="listings-hero-content">
          <h1 class="listings-title">Find the Perfect Home</h1>
          <p class="listings-subtitle">Rent from local hosts and discover unique stays for your dream vacation.</p>
        </div>
      </section>
      <% } %>

        <!-- Scroll Progress Bar -->
        <div class="scroll-progress-container">
          <div class="scroll-progress-bar" id="scrollProgress"></div>
        </div>

        <div class="container">
          <!-- Top Filter Bar (Sticky) -->
          <div class="filters-section animate-fade-in">
            <div class="category-scroll-container">
              <!-- All -->
              <div class="filter-item <%= !category || category === 'all' ? 'active' : '' %>"
                onclick="setCategory('all')">
                <div class="filter-icon-circle">
                  <i class="fas fa-th-large"></i>
                </div>
                <span class="filter-label">All</span>
              </div>

              <!-- Categories -->
              <div class="filter-item <%= category === 'trending' ? 'active' : '' %>" onclick="setCategory('trending')">
                <div class="filter-icon-circle"><i class="fas fa-fire"></i></div>
                <span class="filter-label">Trending</span>
              </div>
              <div class="filter-item <%= category === 'rooms' ? 'active' : '' %>" onclick="setCategory('rooms')">
                <div class="filter-icon-circle"><i class="fas fa-bed"></i></div>
                <span class="filter-label">Rooms</span>
              </div>
              <div class="filter-item <%= category === 'iconic cities' ? 'active' : '' %>"
                onclick="setCategory('iconic cities')">
                <div class="filter-icon-circle"><i class="fas fa-city"></i></div>
                <span class="filter-label">Iconic Cities</span>
              </div>
              <div class="filter-item <%= category === 'mountains' ? 'active' : '' %>"
                onclick="setCategory('mountains')">
                <div class="filter-icon-circle"><i class="fas fa-mountain"></i></div>
                <span class="filter-label">Mountains</span>
              </div>
              <div class="filter-item <%= category === 'castles' ? 'active' : '' %>" onclick="setCategory('castles')">
                <div class="filter-icon-circle"><i class="fab fa-fort-awesome"></i></div>
                <span class="filter-label">Castles</span>
              </div>
              <div class="filter-item <%= category === 'pools' ? 'active' : '' %>" onclick="setCategory('pools')">
                <div class="filter-icon-circle"><i class="fas fa-swimmer"></i></div>
                <span class="filter-label">Amazing Pools</span>
              </div>
              <div class="filter-item <%= category === 'camping' ? 'active' : '' %>" onclick="setCategory('camping')">
                <div class="filter-icon-circle"><i class="fas fa-campground"></i></div>
                <span class="filter-label">Camping</span>
              </div>
              <div class="filter-item <%= category === 'farms' ? 'active' : '' %>" onclick="setCategory('farms')">
                <div class="filter-icon-circle"><i class="fas fa-tractor"></i></div>
                <span class="filter-label">Farms</span>
              </div>
              <div class="filter-item <%= category === 'arctic' ? 'active' : '' %>" onclick="setCategory('arctic')">
                <div class="filter-icon-circle"><i class="fas fa-snowflake"></i></div>
                <span class="filter-label">Arctic</span>
              </div>
              <div class="filter-item <%= category === 'domes' ? 'active' : '' %>" onclick="setCategory('domes')">
                <div class="filter-icon-circle"><i class="fas fa-igloo"></i></div>
                <span class="filter-label">Domes</span>
              </div>
              <div class="filter-item <%= category === 'boats' ? 'active' : '' %>" onclick="setCategory('boats')">
                <div class="filter-icon-circle"><i class="fas fa-ship"></i></div>
                <span class="filter-label">Boats</span>
              </div>
            </div>

            <!-- Detailed Filter Row -->
            <div class="detailed-filters-row">
              <form id="filterForm" class="filter-form">
                <!-- Hidden Category Input -->
                <input type="hidden" name="category" id="categoryInput" value="<%= category || 'all' %>">

                <div class="filter-group">
                  <label>Min Price (₹)</label>
                  <input type="number" name="minPrice" value="<%= minPrice || '' %>" placeholder="0" min="0">
                </div>

                <div class="filter-group">
                  <label>Max Price (₹)</label>
                  <input type="number" name="maxPrice" value="<%= maxPrice || '' %>" placeholder="10000" min="0">
                </div>

                <div class="filter-group">
                  <label>Guests</label>
                  <input type="number" name="guests" value="<%= guests || '' %>" placeholder="1" min="1">
                </div>

                <div class="filter-group sort-group">
                  <label>Sort By</label>
                  <select name="sort" class="form-select">
                    <option value="" <%=!sort ? 'selected' : '' %>>Default</option>
                    <option value="price_asc" <%=sort==='price_asc' ? 'selected' : '' %>>Price: Low to High</option>
                    <option value="price_desc" <%=sort==='price_desc' ? 'selected' : '' %>>Price: High to Low</option>
                    <option value="newest" <%=sort==='newest' ? 'selected' : '' %>>Newest First</option>
                  </select>
                </div>

                <button type="submit" class="btn-filter-apply">
                  <i class="fas fa-search"></i> Apply
                </button>
              </form>
            </div>
          </div>
        </div>

        <!-- Results Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3 class="mb-0">
            <i class="fas fa-list me-2 text-primary"></i>
            <%= allListings.length %> Properties Found
              <% if (query) { %>
                <small class="text-muted">for "<%= query %>"</small>
                <% } %>
          </h3>
          <% if (currUser) { %>
            <a href="/listings/new" class="btn btn-info">
              <i class="fas fa-plus me-2"></i>Add New Listing
            </a>
            <% } %>
        </div>

        <!-- Active Filters -->
        <div class="mb-4">
          <% if (hasActiveFilters) { %>
            <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
              <span class="fw-semibold">Active filters:</span>
              <% if (query) { %>
                <span class="chip">
                  Search: <b>
                    <%= query %>
                  </b>
                  <a href="/listings<%= makeQueryString({}, ['q']) %>">
                    <i class="fas fa-times"></i>
                  </a>
                </span>
                <% } %>
                  <% if (category && category !=='all' ) { %>
                    <span class="chip">
                      Category: <b>
                        <%= category %>
                      </b>
                      <a href="/listings<%= makeQueryString({}, ['category']) %>">
                        <i class="fas fa-times"></i>
                      </a>
                    </span>
                    <% } %>
                      <% if (minPrice) { %>
                        <span class="chip">
                          Min: ₹<b>
                            <%= Number(minPrice).toLocaleString('en-IN') %>
                          </b>
                          <a href="/listings<%= makeQueryString({}, ['minPrice']) %>">
                            <i class="fas fa-times"></i>
                          </a>
                        </span>
                        <% } %>
                          <% if (maxPrice) { %>
                            <span class="chip">
                              Max: ₹<b>
                                <%= Number(maxPrice).toLocaleString('en-IN') %>
                              </b>
                              <a href="/listings<%= makeQueryString({}, ['maxPrice']) %>">
                                <i class="fas fa-times"></i>
                              </a>
                            </span>
                            <% } %>
                              <% if (guests) { %>
                                <span class="chip">
                                  Guests: <b>
                                    <%= guests %>
                                  </b>
                                  <a href="/listings<%= makeQueryString({}, ['guests']) %>">
                                    <i class="fas fa-times"></i>
                                  </a>
                                </span>
                                <% } %>
                                  <a href="/listings" class="btn btn-sm btn-outline-secondary ms-2">
                                    <i class="fas fa-times me-1"></i>Clear All
                                  </a>
            </div>
            <% } %>
        </div>

        <!-- Skeleton Loader (Hidden by default, shown via JS if needed or during initial fade) -->
        <div id="listings-skeleton" class="listings-grid d-none">
          <% for(let i=0; i<8; i++) { %>
            <div class="listing-card skeleton-card">
              <div class="listing-image-container skeleton-box"></div>
              <div class="listing-info">
                <div class="skeleton-line w-75"></div>
                <div class="skeleton-line w-50"></div>
                <div class="skeleton-line w-25"></div>
              </div>
            </div>
            <% } %>
        </div>

        <!-- Listings Grid -->
        <% if (allListings.length> 0) { %>
          <!-- Trending Section -->
          <% if (!query && typeof trendingListings !=='undefined' && trendingListings.length> 0) { %>
            <div class="mb-5">
              <h4 class="mb-4 d-flex align-items-center">
                <i class="fas fa-fire text-danger me-2"></i>
                Today's Trending
              </h4>
              <div class="listings-grid">
                <% for (let t of trendingListings) { %>
                  <% var tImgs=[]; if (t.image && t.image.url) { tImgs.push(t.image.url); } if (t.images &&
                    t.images.length> 0) {
                    t.images.forEach(img => { if (img.url && !tImgs.includes(img.url)) tImgs.push(img.url); });
                    }
                    if (tImgs.length === 0)
                    tImgs.push('https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?w=400&h=250&fit=crop&crop=center');
                    tImgs = tImgs.slice(0, 5);
                    %>
                    <div class="listing-card">
                      <div class="listing-image-container">
                        <div class="carousel-track" data-listing-carousel>
                          <% tImgs.forEach(function(imgUrl) { %>
                            <div class="carousel-slide">
                              <a href="/listings/<%= t._id %>" style="display:block;width:100%;height:100%">
                                <img src="<%= imgUrl %>" class="listing-image" alt="<%= t.title %>" loading="lazy">
                              </a>
                            </div>
                            <% }) %>
                        </div>
                        <% if (tImgs.length> 1) { %>
                          <button class="carousel-arrow prev" onclick="slideListing(event, this, -1)"><i
                              class="fas fa-chevron-left"></i></button>
                          <button class="carousel-arrow next" onclick="slideListing(event, this, 1)"><i
                              class="fas fa-chevron-right"></i></button>
                          <div class="carousel-dots">
                            <% tImgs.forEach(function(_, i) { %>
                              <span class="carousel-dot <%= i === 0 ? 'active' : '' %>"></span>
                              <% }) %>
                          </div>
                          <% } %>
                            <button class="wishlist-btn" data-id="<%= t._id %>"
                              onclick="toggleWishlistAnimated(event, '<%= t._id %>', 'listing')">
                              <i class="far fa-heart"></i>
                            </button>
                            <div class="price-overlay">
                              ₹<%= t.price ? Number(t.price).toLocaleString("en-IN") : "N/A" %>
                            </div>
                            <div class="trending-badge">TRENDING</div>
                            <% if (t.reviews && t.reviews.length> 0) {
                              var tAvg = (t.reviews.reduce((sum, r) => sum + (r.rating || 5), 0) /
                              t.reviews.length).toFixed(1);
                              %>
                              <div class="rating-badge">
                                <span class="stars">★</span>
                                <span>
                                  <%= tAvg %>
                                </span>
                              </div>
                              <% } %>
                      </div>
                      <div class="listing-info">
                        <h5 class="listing-title">
                          <%= t.title %>
                        </h5>
                        <p class="listing-location">
                          <i class="fas fa-map-marker-alt me-1"></i>
                          <%= t.location %>, <%= t.country %>
                        </p>
                        <p class="listing-owner">
                          <i class="fas fa-user me-1"></i>
                          Hosted by <%= t.owner?.username || 'Unknown' %>
                        </p>
                        <div class="listing-actions">
                          <a href="/listings/<%= t._id %>" class="btn btn-outline-primary flex-fill stretched-link">
                            <i class="fas fa-eye me-1"></i>View Details
                          </a>
                        </div>
                      </div>
                    </div>
                    <% } %>
              </div>
            </div>
            <% } %>

              <!-- All Listings -->
              <div class="listings-grid">
                <% for (let listing of allListings) { %>
                  <% var cImgs=[]; if (listing.image && listing.image.url) { cImgs.push(listing.image.url); } if
                    (listing.images && listing.images.length> 0) {
                    for (var ci = 0; ci < listing.images.length; ci++) { if (listing.images[ci].url &&
                      cImgs.indexOf(listing.images[ci].url)===-1) { cImgs.push(listing.images[ci].url); } } } if
                      (cImgs.length===0)
                      cImgs.push('https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?w=400&h=250&fit=crop&crop=center');
                      if (cImgs.length> 5) cImgs = cImgs.slice(0, 5);
                      %>
                      <div class="listing-card">
                        <div class="listing-image-container">
                          <div class="carousel-track" data-listing-carousel>
                            <% cImgs.forEach(function(imgUrl) { %>
                              <div class="carousel-slide">
                                <a href="/listings/<%= listing._id %>" style="display:block;width:100%;height:100%">
                                  <img src="<%= imgUrl %>" class="listing-image" alt="<%= listing.title %>"
                                    loading="lazy">
                                </a>
                              </div>
                              <% }) %>
                          </div>
                          <% if (cImgs.length> 1) { %>
                            <button class="carousel-arrow prev" onclick="slideListing(event, this, -1)"><i
                                class="fas fa-chevron-left"></i></button>
                            <button class="carousel-arrow next" onclick="slideListing(event, this, 1)"><i
                                class="fas fa-chevron-right"></i></button>
                            <div class="carousel-dots">
                              <% cImgs.forEach(function(_, i) { %>
                                <span class="carousel-dot <%= i === 0 ? 'active' : '' %>"></span>
                                <% }) %>
                            </div>
                            <% } %>
                              <button class="wishlist-btn" data-id="<%= listing._id %>"
                                onclick="toggleWishlistAnimated(event, '<%= listing._id %>', 'listing')">
                                <i class="far fa-heart"></i>
                              </button>
                              <div class="price-overlay">
                                ₹<%= listing.price ? Number(listing.price).toLocaleString("en-IN") : "N/A" %>
                              </div>
                              <% if (listing.isTrending) { %>
                                <div class="trending-badge">TRENDING</div>
                                <% } %>
                                  <% if (listing.reviews && listing.reviews.length> 0) {
                                    var avgR = (listing.reviews.reduce(function(sum, r) { return sum + (r.rating || 5);
                                    }, 0) /
                                    listing.reviews.length).toFixed(1);
                                    if (parseFloat(avgR) >= 4.8) { %>
                                    <div class="guest-favorite-badge">
                                      <i class="fas fa-medal text-warning"></i> Guest favorite
                                    </div>
                                    <% } %>
                                      <div class="rating-badge">
                                        <span class="stars">★</span>
                                        <span>
                                          <%= avgR %>
                                        </span>
                                      </div>
                                      <% } %>
                        </div>
                        <div class="listing-info">
                          <% if (listing.propertyType) { %>
                            <span class="property-type-chip">
                              <%= listing.propertyType %>
                            </span>
                            <% } %>
                              <h5 class="listing-title">
                                <%= listing.title %>
                              </h5>
                              <p class="listing-location">
                                <i class="fas fa-map-marker-alt me-1"></i>
                                <%= listing.location %>, <%= listing.country %>
                              </p>
                              <p class="listing-owner">
                                <i class="fas fa-user me-1"></i>
                                Hosted by <%= listing.owner?.username || 'Unknown' %>
                              </p>
                              <div class="listing-actions">
                                <a href="/listings/<%= listing._id %>"
                                  class="btn btn-outline-primary flex-fill stretched-link">
                                  <i class="fas fa-eye me-1"></i>View Details
                                </a>
                                <% if (currUser && listing.owner._id.equals(currUser._id)) { %>
                                  <a href="/listings/<%= listing._id %>/edit"
                                    class="btn btn-outline-secondary flex-fill ms-2"
                                    style="position: relative; z-index: 2;">
                                    <i class="fas fa-edit me-1"></i>Edit
                                  </a>
                                  <% } %>
                              </div>
                        </div>
                      </div>
                      <% } %>
              </div>
              <% } else { %>
                <!-- No Results -->
                <div class="text-center py-5">
                  <i class="fas fa-search fa-4x text-muted mb-3"></i>
                  <h4 class="text-muted">No properties found</h4>
                  <p class="text-muted mb-4">
                    <% if (query) { %>
                      No results for "<%= query %>". Try adjusting your search criteria.
                        <% } else { %>
                          No properties are available at the moment.
                          <% } %>
                  </p>
                  <a href="/listings" class="btn btn-primary">
                    <i class="fas fa-refresh me-2"></i>Clear Filters
                  </a>
                </div>
                <% } %>
                  </div>



                  <!-- Map related elements removed -->


                  <script>
                    document.addEventListener('DOMContentLoaded', function () {
                      // 1. Scroll Progress Bar
                      window.addEventListener('scroll', function () {
                        const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
                        const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
                        const scrolled = (winScroll / height) * 100;
                        const progressBar = document.getElementById("scrollProgress");
                        if (progressBar) { progressBar.style.width = scrolled + "%"; }
                      });

                      // 2. Initial Animation Reveal
                      const cards = document.querySelectorAll('.listing-card');
                      cards.forEach((card, index) => {
                        card.style.animationDelay = (index * 0.05) + 's';
                      });
                    });

                    // ========================================
                    // CARD IMAGE CAROUSEL
                    // ========================================
                    function slideListing(e, btn, direction) {
                      e.preventDefault();
                      e.stopPropagation();
                      var container = btn.closest('.listing-image-container');
                      var track = container.querySelector('.carousel-track');
                      var slides = container.querySelectorAll('.carousel-slide');
                      var dots = container.querySelectorAll('.carousel-dot');
                      var total = slides.length;
                      var current = parseInt(track.dataset.current || '0', 10);
                      current += direction;
                      if (current < 0) current = total - 1;
                      if (current >= total) current = 0;
                      track.style.transform = 'translateX(-' + (current * 100) + '%)';
                      track.dataset.current = current;
                      for (var i = 0; i < dots.length; i++) {
                        dots[i].classList.toggle('active', i === current);
                      }
                    }

                    // ========================================
                    // WISHLIST HEART ANIMATION
                    // ========================================
                    function toggleWishlistAnimated(e, id, type) {
                      e.preventDefault();
                      e.stopPropagation();
                      var heartEl = e.currentTarget;
                      var isNowActive = !heartEl.classList.contains('active');
                      heartEl.classList.toggle('active', isNowActive);
                      var icon = heartEl.querySelector('i');
                      if (icon) {
                        icon.className = isNowActive ? 'fas fa-heart' : 'far fa-heart';
                      }
                      heartEl.classList.remove('animating');
                      void heartEl.offsetWidth;
                      heartEl.classList.add('animating');
                      setTimeout(function () { heartEl.classList.remove('animating'); }, 500);
                      if (isNowActive) {
                        var burst = document.createElement('div');
                        burst.className = 'heart-burst';
                        for (var i = 0; i < 6; i++) {
                          var particle = document.createElement('span');
                          var angle = (i / 6) * 360;
                          var distance = 12 + Math.random() * 8;
                          particle.style.setProperty('--tx', Math.cos(angle * Math.PI / 180) * distance + 'px');
                          particle.style.setProperty('--ty', Math.sin(angle * Math.PI / 180) * distance + 'px');
                          particle.style.background = ['#FF385C', '#ff6b81', '#ff9a5c', '#ffd700'][Math.floor(Math.random() * 4)];
                          burst.appendChild(particle);
                        }
                        heartEl.appendChild(burst);
                        setTimeout(function () { burst.remove(); }, 600);
                      }
                      if (typeof toggleWishlist === 'function') {
                        try { toggleWishlist(e, id, type); } catch (err) { }
                      }
                    }

                    // Filter Logic
                    function setCategory(category) {
                      document.getElementById('categoryInput').value = category;
                      document.querySelectorAll('.filter-item').forEach(function (item) {
                        item.classList.remove('active');
                      });
                      if (event && event.currentTarget) {
                        event.currentTarget.classList.add('active');
                      }
                      document.getElementById('filterForm').submit();
                    }
                  </script>
                  <script src="/js/wishlist-handler.js"></script>

                  <!-- Floating Show Map Button -->
                  <a href="/map" class="show-map-btn">
                    <i class="fas fa-map-marked-alt"></i>
                    Show map
                  </a>
                  </body>

                  </html>