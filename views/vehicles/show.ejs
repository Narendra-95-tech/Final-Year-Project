<% layout("/layouts/boilerplate") -%>

    <!-- Link Premium CSS -->
    <link rel="stylesheet" href="/css/listing-details.css">
    <link rel="stylesheet" href="/css/vehicle-premium.css">
    <link rel="stylesheet" href="/css/share-premium.css">
    <link rel="stylesheet" href="/css/vehicle-management.css">
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <style>
        /* Trip Calculator Premium Styles */
        .trip-geocoder-wrapper {
            margin-bottom: 12px;
        }

        .trip-geocoder-wrapper .mapboxgl-ctrl-geocoder {
            width: 100% !important;
            max-width: 100% !important;
            box-shadow: none;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            background-color: #f8f9fa;
        }

        .trip-geocoder-wrapper .mapboxgl-ctrl-geocoder--input {
            height: 45px;
            padding: 10px 10px 10px 40px;
        }

        .trip-geocoder-wrapper .mapboxgl-ctrl-geocoder--icon-search {
            top: 12px;
            left: 12px;
        }

        .extra-small {
            font-size: 0.65rem;
        }

        .animate-fade-in {
            animation: fadeIn 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Custom Marker style */
        .vehicle-custom-marker {
            transition: all 0.3s ease;
        }

        .vehicle-custom-marker:hover {
            transform: rotate(-45deg) scale(1.1) !important;
            box-shadow: 0 6px 16px rgba(214, 48, 49, 0.5);
        }

        /* Availability Calendar Adjustments */
        #availabilityCalendar {
            border: none !important;
            box-shadow: none !important;
        }

        /* Custom Flatpickr Visibility Improvements */
        .flatpickr-day {
            color: #222 !important;
            font-weight: 600 !important;
            font-size: 15px !important;
        }

        .flatpickr-day.flatpickr-disabled,
        .flatpickr-day.flatpickr-disabled:hover {
            color: #d1d5db !important;
            background-color: transparent !important;
            border-color: transparent !important;
            opacity: 1 !important;
            cursor: not-allowed;
            text-decoration: none !important;
        }

        .flatpickr-day.prevMonthDay,
        .flatpickr-day.nextMonthDay {
            color: #e5e7eb !important;
        }

        .flatpickr-weekday {
            color: #1a1a1a !important;
            font-weight: 700 !important;
        }

        .flatpickr-calendar.static {
            top: 100% !important;
            margin-top: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .date-input-group {
            position: relative;
        }

        .flatpickr-day.selected {
            background: #fe6b00 !important;
            border-color: #fe6b00 !important;
        }

        /* Premium Date Input Styling */
        .date-input-premium {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            width: 100%;
            font-weight: 500;
            cursor: pointer;
            background-color: #fff;
        }
    </style>

    <script src="/js/wishlist-handler.js"></script>
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- Mapbox Geocoder -->
    <script
        src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet"
        href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css"
        type="text/css">

    <body class="listing-details-page">

        <script type="application/json" id="vehicle-data">
    <%- JSON.stringify(vehicle) %>
</script>
        <script>
            const mapToken = "<%= process.env.MAP_TOKEN %>";
            const vehicle = JSON.parse(document.getElementById('vehicle-data').textContent);
        </script>

        <!-- Dynamic Image Gallery -->
        <div id="image-gallery-container"></div>

        <div class="container mt-4">
            <!-- Premium Header Section -->
            <div class="d-flex justify-content-between align-items-start mb-4">
                <div class="header-left">
                    <h1 class="vehicle-title mb-2">
                        <%= vehicle.title %>
                    </h1>
                    <div class="vehicle-subtitle d-flex align-items-center gap-2">
                        <span class="location-badge">
                            <i class="fas fa-map-marker-alt"></i>
                            <%= vehicle.location %>, <%= vehicle.country %>
                        </span>
                        <span class="separator">•</span>
                        <span class="rating-badge">
                            <i class="fas fa-star text-warning"></i>
                            <%= vehicle.averageRating || 'New' %>
                        </span>
                        <span class="separator">•</span>
                        <span class="review-count underline">
                            <%= vehicle.reviews.length %> reviews
                        </span>
                    </div>
                </div>

                <div class="header-actions d-flex gap-2">
                    <!-- Share & Save Buttons (Included in Partial) -->
                    <% const isWishlisted=currUser && currUser.wishlistVehicles && currUser.wishlistVehicles.some(id=>
                        id.toString() === vehicle._id.toString()); %>
                        <%- include('../partials/socialShare', { itemId: vehicle._id, isWishlisted, itemType: 'vehicle'
                            , iconClass: 'fas fa-share-alt' , btnClass: 'action-btn' , currentUrl:
                            `https://${process.env.HOST || 'localhost:3000' }/vehicles/${vehicle._id}`, shareText:
                            `Check out '${vehicle.title}' on WanderLust`, shareSubject: `Check out '${vehicle.title}' on
                            WanderLust` }) %>
                </div>
            </div>

            <!-- Main Content Layout -->
            <div class="detail-grid">
                <!-- Left Column: Info & Details -->
                <div class="detail-info">
                    <!-- Enhanced Host Profile -->
                    <div class="host-profile-card">
                        <div class="d-flex align-items-start gap-3">
                            <div class="host-avatar-wrapper">
                                <img src="https://ui-avatars.com/api/?name=<%= vehicle.owner.username %>&background=ff7675&color=fff&size=80"
                                    class="rounded-circle" width="80">
                                <% if(vehicle.owner.isVerified) { %>
                                    <div class="host-verified-badge" title="Verified Explorer">
                                        <i class="fas fa-check"></i>
                                    </div>
                                    <% } %>
                            </div>
                            <div class="flex-grow-1">
                                <h5 class="fw-bold mb-1">Hosted by <%= vehicle.owner.username %>
                                        <% if(vehicle.owner.isVerified) { %>
                                            <i class="fas fa-shield-check text-info ms-1" style="font-size: 16px;"></i>
                                            <% } %>
                                </h5>
                                <p class="text-muted small mb-0"><i class="fas fa-shield-check me-1"></i>
                                    <%= vehicle.owner.isVerified ? 'Verified Explorer' : 'Verified Host' %> ·
                                        Joined <%= new Date(vehicle.owner.createdAt).getFullYear() %>
                                </p>
                                <div class="host-stats">
                                    <div class="host-stat-item">
                                        <span class="host-stat-value">
                                            <%= vehicle.totalTrips || 12 %>
                                        </span>
                                        <span class="host-stat-label">Trips</span>
                                    </div>
                                    <div class="host-stat-item">
                                        <span class="host-stat-value">
                                            <%= vehicle.averageRating || 4.8 %> <i
                                                    class="fas fa-star text-warning fs-xs"></i>
                                        </span>
                                        <span class="host-stat-label">Rating</span>
                                    </div>
                                    <div class="host-stat-item">
                                        <span class="host-stat-value">~1hr</span>
                                        <span class="host-stat-label">Response</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Specs Grid -->
                    <h4 class="fw-bold mb-3">Specifications</h4>
                    <div class="specs-grid">
                        <div class="spec-card" data-aos="fade-up">
                            <i class="fas fa-user-friends"></i>
                            <span class="spec-card-label">Capacity</span>
                            <span class="spec-card-value">
                                <%= vehicle.seats || 5 %> Seats
                            </span>
                        </div>
                        <div class="spec-card" data-aos="fade-up" data-aos-delay="50">
                            <i class="fas fa-cog"></i>
                            <span class="spec-card-label">Transmission</span>
                            <span class="spec-card-value text-capitalize">
                                <%= vehicle.transmission || 'Manual' %>
                            </span>
                        </div>
                        <div class="spec-card" data-aos="fade-up" data-aos-delay="100">
                            <i class="fas fa-gas-pump"></i>
                            <span class="spec-card-label">Fuel Type</span>
                            <span class="spec-card-value text-capitalize">
                                <%= vehicle.fuelType || 'Petrol' %>
                            </span>
                        </div>
                        <div class="spec-card" data-aos="fade-up" data-aos-delay="150">
                            <i class="fas fa-calendar-alt"></i>
                            <span class="spec-card-label">Year</span>
                            <span class="spec-card-value">
                                <%= vehicle.year || '2022' %>
                            </span>
                        </div>
                        <div class="spec-card" data-aos="fade-up" data-aos-delay="200">
                            <i class="fas fa-tachometer-alt"></i>
                            <span class="spec-card-label">Mileage</span>
                            <span class="spec-card-value">
                                <%= vehicle.mileage || '15' %> km/l
                            </span>
                        </div>
                        <div class="spec-card" data-aos="fade-up" data-aos-delay="250">
                            <i class="fas fa-shield-alt"></i>
                            <span class="spec-card-label">Security</span>
                            <span class="spec-card-value">₹<%= (vehicle.securityDeposit || 5000).toLocaleString() %>
                            </span>
                        </div>
                    </div>

                    <div class="mt-5">
                        <h4 class="fw-bold mb-3">About this vehicle</h4>
                        <p class="text-muted lead-sm line-height-lg">
                            <%= vehicle.description %>
                        </p>
                    </div>

                    <!-- Dynamic Features Grid -->
                    <% if(vehicle.features && vehicle.features.length> 0) { %>
                        <div class="mt-5">
                            <h4 class="fw-bold mb-3">What this vehicle offers</h4>
                            <div class="features-grid">
                                <% const featureIcons={ 'AC' : 'fas fa-snowflake' , 'Air Conditioning'
                                    : 'fas fa-snowflake' , 'GPS' : 'fas fa-location-arrow' , 'Navigation'
                                    : 'fas fa-location-arrow' , 'Bluetooth' : 'fab fa-bluetooth-b' , 'USB'
                                    : 'fas fa-usb' , 'Parking Sensors' : 'fas fa-parking' , 'Reverse Camera'
                                    : 'fas fa-video' , 'Sunroof' : 'fas fa-sun' , 'Leather Seats' : 'fas fa-couch'
                                    , 'Cruise Control' : 'fas fa-gauge-high' , 'ABS' : 'fas fa-shield-halved'
                                    , 'Airbags' : 'fas fa-shield-alt' , 'Power Steering' : 'fas fa-steering-wheel'
                                    , 'Music System' : 'fas fa-music' , 'Aux Input' : 'fas fa-headphones' }; for(let
                                    feature of vehicle.features) { const icon=featureIcons[feature]
                                    || 'fas fa-check-circle' ; %>
                                    <div class="feature-item">
                                        <i class="feature-icon <%= icon %>"></i>
                                        <span class="feature-label">
                                            <%= feature %>
                                        </span>
                                    </div>
                                    <% } %>
                            </div>
                        </div>
                        <% } %>

                            <!-- Trust Sections -->
                            <div class="trust-sections mt-5 pt-4 border-top">
                                <div class="d-flex gap-4 mb-4">
                                    <i class="fas fa-broom text-teal fs-4"></i>
                                    <div>
                                        <h6 class="fw-bold mb-1">Enhanced Clean</h6>
                                        <p class="text-muted small">This host committed to WanderLust's 5-step enhanced
                                            cleaning process.</p>
                                    </div>
                                </div>
                                <div class="d-flex gap-4 mb-4">
                                    <i class="fas fa-key text-orange fs-4"></i>
                                    <div>
                                        <h6 class="fw-bold mb-1">Great Check-in Experience</h6>
                                        <p class="text-muted small">100% of recent renters gave the check-in process a
                                            5-star rating.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Map Section -->
                            <div class="mt-5 pt-4 border-top">
                                <h4 class="fw-bold mb-3">Location</h4>
                                <p class="text-muted mb-3">
                                    <%= vehicle.location %>, <%= vehicle.country %>
                                </p>
                                <div id="map" class="rounded-4" style="height:350px;"></div>
                            </div>

                            <!-- Availability Calendar Section -->
                            <div class="mt-5 pt-4 border-top">
                                <h4 class="fw-bold mb-3">Availability</h4>
                                <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                                    <div class="card-body p-0">
                                        <div id="availabilityCalendar" class="wanderlust-calendar"
                                            style="min-height: 450px;"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Reviews Section -->
                            <div class="mt-5 pt-4 border-top">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h4 class="fw-bold mb-0"><i class="fas fa-star text-warning"></i>
                                        <%= vehicle.averageRating || 'New' %> · <%= vehicle.reviews.length %> Reviews
                                    </h4>
                                </div>

                                <% if(currUser && !vehicle.owner._id.equals(currUser._id)) { %>
                                    <div class="card bg-light border-0 rounded-4 p-4 mb-4">
                                        <h5 class="fw-bold mb-3">Write a review</h5>
                                        <form action="/vehicles/<%= vehicle._id %>/reviews" method="POST" novalidate
                                            class="needs-validation" enctype="multipart/form-data">
                                            <div class="mb-3">
                                                <fieldset class="starability-slot">
                                                    <input type="radio" id="no-rate" class="input-no-rate"
                                                        name="review[rating]" value="1" checked
                                                        aria-label="No rating." />
                                                    <input type="radio" id="first-rate1" name="review[rating]"
                                                        value="1" />
                                                    <label for="first-rate1" title="Terrible">1 star</label>
                                                    <input type="radio" id="first-rate2" name="review[rating]"
                                                        value="2" />
                                                    <label for="first-rate2" title="Not good">2 stars</label>
                                                    <input type="radio" id="first-rate3" name="review[rating]"
                                                        value="3" />
                                                    <label for="first-rate3" title="Average">3 stars</label>
                                                    <input type="radio" id="first-rate4" name="review[rating]"
                                                        value="4" />
                                                    <label for="first-rate4" title="Very good">4 stars</label>
                                                    <input type="radio" id="first-rate5" name="review[rating]"
                                                        value="5" />
                                                    <label for="first-rate5" title="Amazing">5 stars</label>
                                                </fieldset>
                                            </div>
                                            <div class="mb-3">
                                                <textarea name="review[comment]" id="comment" rows="3"
                                                    class="form-control rounded-3"
                                                    placeholder="Describe your experience..." required></textarea>
                                            </div>
                                            <div class="mb-3">
                                                <label for="images" class="form-label small fw-bold text-muted">Add
                                                    Photos</label>
                                                <input type="file" name="review[images]" id="images"
                                                    class="form-control" multiple>
                                            </div>
                                            <button class="btn btn-dark rounded-pill px-4">Submit Review</button>
                                        </form>
                                    </div>
                                    <% } %>

                                        <div class="row g-4">
                                            <% for(review of vehicle.reviews) { %>
                                                <div class="col-md-6">
                                                    <div class="review-item p-3 border rounded-4 h-100">
                                                        <div class="d-flex align-items-center mb-2">
                                                            <img src="https://ui-avatars.com/api/?name=<%= review.author.username %>"
                                                                class="rounded-circle me-2" width="40">
                                                            <div>
                                                                <h6 class="fw-bold mb-0">
                                                                    @<%= review.author.username %>
                                                                        <% if(review.isVerified) { %>
                                                                            <i class="fas fa-shield-check text-success ms-1"
                                                                                title="Verified Renter"></i>
                                                                            <% } %>
                                                                </h6>
                                                                <p class="text-muted extra-small mb-0">
                                                                    <%= review.createdAt ?
                                                                        review.createdAt.toLocaleDateString('en-US', {
                                                                        month: 'short' , year: 'numeric' }) : 'Recently'
                                                                        %>
                                                                </p>
                                                            </div>
                                                        </div>
                                                        <p class="starability-result mb-2"
                                                            data-rating="<%= review.rating%>"></p>
                                                        <p class="text-muted small mb-0">
                                                            <%= review.comment %>
                                                        </p>
                                                        <% if(review.images && review.images.length> 0) { %>
                                                            <div class="review-images mt-3 d-flex flex-wrap gap-2">
                                                                <% review.images.forEach(img=> { %>
                                                                    <img src="<%= img.url %>" class="rounded"
                                                                        style="width: 70px; height: 50px; object-fit: cover; cursor: pointer;"
                                                                        onclick="window.open('<%= img.url %>', '_blank')">
                                                                    <% }) %>
                                                            </div>
                                                            <% } %>
                                                                <% if(currUser &&
                                                                    review.author._id.equals(currUser._id)) { %>
                                                                    <form class="mt-3" method="POST"
                                                                        action="/vehicles/<%=vehicle._id %>/reviews/<%= review._id %>?_method=DELETE">
                                                                        <button
                                                                            class="btn btn-sm btn-outline-danger rounded-pill px-3">
                                                                            <i class="fas fa-trash-alt me-1"></i> Delete
                                                                        </button>
                                                                    </form>
                                                                    <% } %>
                                                    </div>
                                                </div>
                                                <% } %>
                                        </div>
                            </div>
                </div>

                <!-- Right Column: Sticky Booking -->
                <div class="detail-booking">
                    <div class="sticky-booking-sidebar">
                        <div class="booking-card">
                            <% if(!currUser || (vehicle.owner && !vehicle.owner._id.equals(currUser._id))) { %>
                                <!-- Booking Highlight -->
                                <div class="booking-highlight">
                                    <p class="booking-highlight-text"><i class="fas fa-fire me-1"></i> Recently booked 3
                                        times this week</p>
                                </div>

                                <div class="booking-price-row">
                                    <div>
                                        <span class="card-price-tag">₹<%= vehicle.price ?
                                                Number(vehicle.price).toLocaleString("en-IN") : "0" %></span>
                                        <span class="card-price-unit">/ day</span>
                                    </div>
                                    <div class="text-muted small">
                                        <i class="fas fa-shield-alt text-success me-1"></i> WanderCheck
                                    </div>
                                </div>

                                <form id="vehicle-premium-booking-form">
                                    <div class="row g-2 mb-3">
                                        <div class="col-6">
                                            <label class="extra-small fw-bold text-uppercase text-muted">Pick-up</label>
                                            <div class="date-input-group">
                                                <input type="text" id="booking-start-date" name="startDate"
                                                    class="date-input-premium" placeholder="Select Date" required
                                                    readonly>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <label class="extra-small fw-bold text-uppercase text-muted">Return</label>
                                            <div class="date-input-group">
                                                <input type="text" id="booking-end-date" name="endDate"
                                                    class="date-input-premium" placeholder="Select Date" required
                                                    readonly>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="extra-small fw-bold text-uppercase text-muted">Add Message
                                            (Optional)</label>
                                        <textarea name="message" class="form-control" rows="2"
                                            placeholder="Tell the host about your trip..."></textarea>
                                    </div>

                                    <button type="submit" class="premium-btn-book">Book Now</button>

                                    <p class="text-center text-muted extra-small mt-3">You won't be charged yet</p>

                                    <div class="price-breakdown">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="text-muted text-decoration-underline">₹<%=
                                                    Number(vehicle.price).toLocaleString() %> x <span
                                                        id="days-count">1</span> day</span>
                                            <span id="base-total">₹<%= Number(vehicle.price).toLocaleString() %></span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="text-muted text-decoration-underline">Cleaning fee</span>
                                            <span>₹500</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="text-muted text-decoration-underline">Service fee</span>
                                            <span>₹250</span>
                                        </div>
                                        <hr>
                                        <div class="d-flex justify-content-between fw-bold">
                                            <span>Total (INR)</span>
                                            <span id="final-total">₹<%= (Number(vehicle.price) + 750).toLocaleString()
                                                    %>
                                            </span>
                                        </div>
                                    </div>
                                </form>
                                <% } %>

                                    <% if(currUser && vehicle.owner._id.equals(currUser._id)) { %>
                                        <div class="owner-management-section">
                                            <div class="management-header">
                                                <i class="fas fa-tools"></i>
                                                <h6 class="fw-bold mb-0">Manage Vehicle</h6>
                                            </div>
                                            <div class="management-stats">
                                                <div class="stat-item">
                                                    <i class="fas fa-road text-primary"></i>
                                                    <div>
                                                        <span class="stat-value">
                                                            <%= vehicle.totalTrips || 0 %>
                                                        </span>
                                                        <span class="stat-label">Trips</span>
                                                    </div>
                                                </div>
                                                <div class="stat-item">
                                                    <i class="fas fa-star text-warning"></i>
                                                    <div>
                                                        <span class="stat-value">
                                                            <%= vehicle.averageRating || 'N/A' %>
                                                        </span>
                                                        <span class="stat-label">Rating</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="management-actions">
                                                <a href="/vehicles/<%= vehicle._id %>/edit"
                                                    class="management-btn edit-btn">
                                                    <i class="fas fa-edit"></i>
                                                    <span>Edit Details</span>
                                                </a>
                                                <button class="management-btn delete-btn"
                                                    onclick="if(confirm('Are you sure you want to delete this vehicle?')) document.getElementById('delete-form').submit()">
                                                    <i class="fas fa-trash-alt"></i>
                                                    <span>Delete Vehicle</span>
                                                </button>
                                            </div>
                                            <form id="delete-form" method="POST"
                                                action="/vehicles/<%= vehicle._id %>?_method=DELETE"
                                                style="display: none;"></form>
                                        </div>
                                        <% } %>
                        </div>

                        <!-- Trip & Fuel Calculator Widget -->
                        <div class="booking-card mt-3">
                            <div class="d-flex align-items-center gap-2 mb-3">
                                <i class="fas fa-calculator text-primary"></i>
                                <h6 class="fw-bold mb-0">Trip & Fuel Estimator</h6>
                            </div>

                            <div class="mb-3">
                                <label class="extra-small fw-bold text-uppercase text-muted">Destination</label>
                                <div id="trip-geocoder" class="trip-geocoder-wrapper"></div>
                            </div>

                            <div id="trip-stats" class="d-none animate-fade-in">
                                <div class="p-3 bg-light rounded-3 border mb-3">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="text-muted small">Distance</span>
                                        <span id="trip-distance" class="fw-bold">0 km</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="text-muted small">Est. Fuel Needed</span>
                                        <span id="fuel-needed" class="fw-bold">0 L</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="text-muted small">Fuel Type</span>
                                        <span class="badge bg-secondary text-capitalize">
                                            <%= vehicle.fuelType %>
                                        </span>
                                    </div>
                                    <hr class="my-2">
                                    <div class="d-flex justify-content-between">
                                        <span class="fw-bold">Est. Fuel Cost</span>
                                        <span id="fuel-cost" class="text-success fw-bold">₹0</span>
                                    </div>
                                </div>
                                <div class="alert alert-info py-2 px-3 small border-0 mb-0">
                                    <i class="fas fa-leaf me-1"></i> Based on <strong>
                                        <%= vehicle.mileage || 15 %> km/l
                                    </strong> efficiency.
                                </div>
                            </div>

                            <div id="trip-placeholder" class="text-center py-3">
                                <p class="text-muted small mb-0">Enter a destination to calculate trip costs.</p>
                            </div>
                        </div>

                        <!-- Trust Badges -->
                        <div class="text-center mt-3 px-3">
                            <p class="text-muted small"><i class="fas fa-lock me-1"></i> Secure Payment Guaranteed</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- JavaScript Files -->
        <script src="/js/image-gallery.js"></script>
        <script src="/js/wanderlust-calendar.js?v=<%= Date.now() %>"></script>
        <script>
            document.addEventListener("DOMContentLoaded", async () => {
                const startDateInput = document.getElementById("booking-start-date");
                const endDateInput = document.getElementById("booking-end-date");
                const daysCount = document.getElementById("days-count");
                const baseTotal = document.getElementById("base-total");
                const finalTotal = document.getElementById("final-total");

                // Set Mapbox Access Token Globally
                if (typeof mapboxgl !== 'undefined') {
                    mapboxgl.accessToken = mapToken;
                }

                // Use the already parsed 'vehicle' object from line 143
                const pricePerDay = vehicle.price || 0;
                const vehicleMileage = vehicle.mileage || 15;
                const fuelPrice = vehicle.fuelType === 'diesel' ? 88 : 95;

                const updatePrice = () => {
                    if (!startDateInput.value || !endDateInput.value) return;
                    const start = new Date(startDateInput.value);
                    const end = new Date(endDateInput.value);
                    const diff = Math.ceil((end - start) / (1000 * 60 * 60 * 24));

                    if (diff > 0) {
                        if (daysCount) daysCount.innerText = diff;
                        const base = pricePerDay * diff;
                        if (baseTotal) baseTotal.innerText = `₹${base.toLocaleString()}`;
                        if (finalTotal) finalTotal.innerText = `₹${(base + 750).toLocaleString()}`;
                    }
                };

                // Initialize Flatpickr
                let fpStart, fpEnd;
                if (startDateInput && endDateInput) {
                    fpStart = flatpickr(startDateInput, {
                        minDate: "today",
                        dateFormat: "Y-m-d",
                        altInput: true,
                        altFormat: "D, d M",
                        disableMobile: "true",
                        static: true,
                        monthSelectorType: "static",
                        onChange: function (selectedDates, dateStr, instance) {
                            if (selectedDates.length > 0) {
                                fpEnd.set('minDate', selectedDates[0]);
                                setTimeout(() => fpEnd.open(), 100);
                            }
                            updatePrice();
                        }
                    });

                    fpEnd = flatpickr(endDateInput, {
                        minDate: "today",
                        dateFormat: "Y-m-d",
                        altInput: true,
                        altFormat: "D, d M",
                        disableMobile: "true",
                        static: true,
                        monthSelectorType: "static",
                        onChange: updatePrice
                    });
                }

                // Initialize WanderLustCalendar
                if (typeof WanderLustCalendar !== 'undefined') {
                    const wlCalendar = new WanderLustCalendar('availabilityCalendar', {
                        primary: '#00A699',
                        onDateSelect: (date, range) => {
                            if (range.startDate && fpStart) {
                                fpStart.setDate(range.startDate);
                                if (range.endDate && fpEnd) {
                                    fpEnd.setDate(range.endDate);
                                }
                                updatePrice();
                            }
                        }
                    });

                    // Fetch and Mark Booked Dates
                    try {
                        const response = await fetch(`/vehicles/${vehicle._id}/bookings`);
                        const bookedEvents = await response.json();
                        const bookedDates = [];
                        bookedEvents.forEach(event => {
                            let current = new Date(event.start);
                            const end = new Date(event.end);
                            while (current <= end) {
                                bookedDates.push(new Date(current));
                                current.setDate(current.getDate() + 1);
                            }
                        });
                        wlCalendar.setBookedDates(bookedDates);
                        if (fpStart) fpStart.set('disable', bookedDates);
                        if (fpEnd) fpEnd.set('disable', bookedDates);
                    } catch (err) {
                        console.error("Failed to load bookings:", err);
                    }
                }

                // --- Trip & Fuel Calculator Logic ---
                const geocoderContainer = document.getElementById('trip-geocoder');
                if (geocoderContainer && typeof MapboxGeocoder !== 'undefined') {
                    const tripGeocoder = new MapboxGeocoder({
                        accessToken: mapboxgl.accessToken,
                        mapboxgl: mapboxgl,
                        placeholder: 'Where are you going?',
                        marker: false,
                    });

                    tripGeocoder.addTo('#trip-geocoder');

                    tripGeocoder.on('result', (e) => {
                        const destCoords = e.result.geometry.coordinates;
                        const startCoords = vehicle.geometry.coordinates;

                        fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${startCoords[0]},${startCoords[1]};${destCoords[0]},${destCoords[1]}?access_token=${mapboxgl.accessToken}`)
                            .then(res => res.json())
                            .then(data => {
                                if (data.routes && data.routes[0]) {
                                    const distanceKm = (data.routes[0].distance / 1000).toFixed(1);
                                    const fuelNeeded = (distanceKm / vehicleMileage).toFixed(1);
                                    const estimatedCost = Math.round(fuelNeeded * fuelPrice);

                                    document.getElementById('trip-placeholder')?.classList.add('d-none');
                                    document.getElementById('trip-stats')?.classList.remove('d-none');
                                    const distEl = document.getElementById('trip-distance');
                                    const fuelEl = document.getElementById('fuel-needed');
                                    const costEl = document.getElementById('fuel-cost');
                                    if (distEl) distEl.innerText = `${distanceKm} km`;
                                    if (fuelEl) fuelEl.innerText = `${fuelNeeded} L`;
                                    if (costEl) costEl.innerText = `₹${estimatedCost.toLocaleString()}`;
                                }
                            });
                    });
                }

                // Booking Form Submission
                const bookingForm = document.getElementById('vehicle-premium-booking-form');
                if (bookingForm) {
                    bookingForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const btn = e.target.querySelector('button');
                        if (btn) {
                            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
                            btn.disabled = true;
                        }

                        const formData = new FormData(e.target);
                        const data = Object.fromEntries(formData.entries());
                        const start = new Date(data.startDate);
                        const end = new Date(data.endDate);
                        const diff = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                        const totalPrice = (diff > 0 ? (pricePerDay * diff) + 750 : 0);

                        try {
                            const res = await fetch('/bookings/initiate', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    type: 'vehicle',
                                    vehicleId: vehicle._id,
                                    startDate: data.startDate,
                                    endDate: data.endDate,
                                    message: data.message,
                                    totalPrice: totalPrice,
                                    guests: 1
                                })
                            });

                            const result = await res.json();
                            if (res.ok && result.success) {
                                window.location.href = result.redirectUrl;
                            } else {
                                alert(result.message || 'Booking failed');
                            }
                        } catch (err) {
                            console.error(err);
                            alert('Something went wrong');
                        } finally {
                            if (btn) {
                                btn.innerHTML = 'Book Now';
                                btn.disabled = false;
                            }
                        }
                    });
                }

                // Initialize Image Gallery
                const imageGalleryContainer = document.getElementById('image-gallery-container');
                if (imageGalleryContainer && typeof ImageGallery !== 'undefined') {
                    const images = vehicle.images && vehicle.images.length > 0
                        ? vehicle.images
                        : vehicle.image ? [vehicle.image] : [{ url: 'https://images.unsplash.com/photo-1503376785-2acd3d0a0821', caption: vehicle.title }];
                    new ImageGallery('image-gallery-container', images);
                }

                // Initialize Enhanced Map
                const mapContainer = document.getElementById('map');
                if (mapContainer && vehicle.geometry && vehicle.geometry.coordinates && typeof EnhancedMap !== 'undefined' && typeof mapToken !== 'undefined') {
                    const vehicleCoords = vehicle.geometry.coordinates;
                    const enhancedMap = new EnhancedMap('map', {
                        mapToken: mapToken,
                        center: vehicleCoords,
                        zoom: 14,
                        searchEnabled: true,
                        clusterEnabled: false,
                        mapStyle: 'mapbox://styles/mapbox/streets-v12',
                        showControls: true
                    });

                    const markerEl = document.createElement('div');
                    markerEl.className = 'vehicle-custom-marker';
                    markerEl.innerHTML = '<i class="fas fa-car"></i>';
                    Object.assign(markerEl.style, {
                        width: '50px', height: '50px',
                        background: 'linear-gradient(135deg, #ff7675, #d63031)',
                        borderRadius: '50% 50% 50% 0',
                        transform: 'rotate(-45deg)',
                        display: 'flex', alignItems: 'center', justifyContent: 'center',
                        boxShadow: '0 4px 12px rgba(214, 48, 49, 0.4)',
                        border: '3px solid white', cursor: 'pointer', color: 'white', fontSize: '20px'
                    });
                    markerEl.querySelector('i').style.transform = 'rotate(45deg)';

                    enhancedMap.addMarker('vehicle', vehicleCoords, {
                        customElement: markerEl,
                        title: vehicle.title,
                        description: `<div style="padding:4px;">
                            <h6 style="margin:0; font-weight:700;">${vehicle.title}</h6>
                            <span style="color:#717171; font-size:12px;">${vehicle.location}, ${vehicle.country}</span>
                        </div>`,
                        popup: true,
                        offset: [0, -20]
                    });
                }
            });
        </script>