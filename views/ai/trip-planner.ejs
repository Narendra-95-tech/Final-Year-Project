<%- include('../layouts/boilerplate') %>

<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm border-0 rounded-lg">
                <div class="card-header bg-primary text-white">
                    <h2 class="h4 mb-0">AI Trip Planner</h2>
                    <p class="mb-0">Let us help you plan your perfect trip</p>
                </div>
                <div class="card-body p-4">
                    <div class="text-center mb-4">
                        <i class="fas fa-robot text-primary mb-3" style="font-size: 3rem;"></i>
                        <h3 class="h5">How can I assist you with your travel plans?</h3>
                        <p class="text-muted">Describe your ideal trip in natural language</p>
                    </div>

                    <div class="trip-planner-form mb-4">
                        <div class="input-group input-group-lg">
                            <input type="text" 
                                   class="form-control form-control-lg" 
                                   id="tripQueryInput" 
                                   placeholder="e.g., Plan a 3-day trip to Manali under ₹10,000 for 2 people"
                                   autocomplete="off">
                            <button class="btn btn-primary" type="button" id="planTripBtn">
                                <i class="fas fa-magic me-2"></i>Plan My Trip
                            </button>
                        </div>
                        <div class="form-text text-muted small mt-2">
                            Try: "Romantic weekend getaway in Goa" or "Adventure trip to Rishikesh with river rafting"
                        </div>
                    </div>

                    <div class="trip-options mb-4">
                        <div class="d-flex flex-wrap gap-2 justify-content-center">
                            <button class="btn btn-outline-primary btn-sm" data-prompt="Plan a 3-day trip to Manali under ₹10,000">
                                <i class="fas fa-mountain me-1"></i> Manali Getaway
                            </button>
                            <button class="btn btn-outline-primary btn-sm" data-prompt="Romantic weekend in Goa with beach stay">
                                <i class="fas fa-umbrella-beach me-1"></i> Goa Weekend
                            </button>
                            <button class="btn btn-outline-primary btn-sm" data-prompt="Adventure trip to Rishikesh with rafting and camping">
                                <i class="fas fa-hiking me-1"></i> Rishikesh Adventure
                            </button>
                            <button class="btn btn-outline-primary btn-sm" data-prompt="Family vacation to Kerala with houseboat stay">
                                <i class="fas fa-ship me-1"></i> Kerala Backwaters
                            </button>
                        </div>
                    </div>

                    <div class="divider my-4">
                        <span class="px-3 bg-white text-muted">OR</span>
                    </div>

                    <div class="text-center">
                        <button class="btn btn-outline-secondary me-2" id="voiceInputBtn">
                            <i class="fas fa-microphone me-2"></i>Use Voice Input
                        </button>
                        <label class="btn btn-outline-secondary" for="imageUpload">
                            <i class="fas fa-camera me-2"></i>Upload Image
                            <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                        </label>
                    </div>
                </div>
            </div>

            <div id="tripResults" class="mt-4" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="h5 mb-0">Your Personalized Trip Plan</h3>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-2" id="editPlanBtn">
                            <i class="fas fa-edit me-1"></i>Edit
                        </button>
                        <button class="btn btn-sm btn-outline-primary" id="savePlanBtn">
                            <i class="far fa-bookmark me-1"></i>Save Plan
                        </button>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-body">
                        <div class="trip-summary">
                            <h4 id="tripSummaryTitle">3-Day Manali Getaway</h4>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="far fa-calendar-alt text-primary me-2"></i>
                                        <div>
                                            <div class="small text-muted">Duration</div>
                                            <div id="tripDuration">3 days, 2 nights</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-users text-primary me-2"></i>
                                        <div>
                                            <div class="small text-muted">Travelers</div>
                                            <div id="tripTravelers">2 people</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-wallet text-primary me-2"></i>
                                        <div>
                                            <div class="small text-muted">Estimated Cost</div>
                                            <div id="tripCost">₹9,500 - ₹11,000</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tripItinerary">
                    <!-- Itinerary will be dynamically inserted here -->
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Crafting your perfect itinerary...</p>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-body">
                        <h5 class="card-title">Ready to book your trip?</h5>
                        <p class="card-text">Save your plan or book accommodations and activities with a single click.</p>
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary">
                                <i class="fas fa-shopping-cart me-2"></i>Book Now
                            </button>
                            <button class="btn btn-outline-secondary">
                                <i class="far fa-envelope me-2"></i>Email Itinerary
                            </button>
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-share-alt me-2"></i>Share
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#"><i class="fab fa-whatsapp me-2"></i>WhatsApp</a></li>
                                    <li><a class="dropdown-item" href="#"><i class="fab fa-facebook me-2"></i>Facebook</a></li>
                                    <li><a class="dropdown-item" href="#"><i class="fas fa-link me-2"></i>Copy Link</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tripQueryInput = document.getElementById('tripQueryInput');
    const planTripBtn = document.getElementById('planTripBtn');
    const voiceInputBtn = document.getElementById('voiceInputBtn');
    const imageUpload = document.getElementById('imageUpload');
    const tripResults = document.getElementById('tripResults');
    const quickOptionBtns = document.querySelectorAll('[data-prompt]');

    // Initialize voice recognition if available
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    
    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.lang = 'en-US';
        recognition.interimResults = false;
        
        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            tripQueryInput.value = transcript;
            planTrip(transcript);
        };
        
        recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            showToast('Error: ' + event.error, 'error');
        };
    } else {
        voiceInputBtn.disabled = true;
        voiceInputBtn.title = 'Speech recognition not supported in your browser';
    }

    // Event Listeners
    planTripBtn.addEventListener('click', () => {
        const query = tripQueryInput.value.trim();
        if (query) {
            planTrip(query);
        } else {
            showToast('Please enter your trip details', 'warning');
            tripQueryInput.focus();
        }
    });

    tripQueryInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            planTripBtn.click();
        }
    });

    voiceInputBtn.addEventListener('click', () => {
        if (recognition) {
            recognition.start();
            voiceInputBtn.innerHTML = '<i class="fas fa-microphone-slash me-2"></i>Listening...';
            
            // Reset button after 5 seconds if no result
            setTimeout(() => {
                if (voiceInputBtn.innerHTML.includes('Listening')) {
                    voiceInputBtn.innerHTML = '<i class="fas fa-microphone me-2"></i>Use Voice Input';
                }
            }, 5000);
        }
    });

    quickOptionBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const prompt = btn.getAttribute('data-prompt');
            tripQueryInput.value = prompt;
            planTrip(prompt);
        });
    });

    imageUpload.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            // In a real app, you would upload the image to your server
            // and process it with a computer vision API
            showToast('Analyzing image...', 'info');
            
            // Simulate image processing
            setTimeout(() => {
                // This would be replaced with actual image recognition results
                const mockLocation = 'Manali, Himachal Pradesh';
                tripQueryInput.value = `Plan a trip to ${mockLocation}`;
                planTrip(tripQueryInput.value);
                showToast(`Detected location: ${mockLocation}`, 'success');
            }, 2000);
        }
    });

    // Functions
    async function planTrip(query) {
        if (!query) return;
        
        // Show loading state
        tripResults.style.display = 'block';
        document.getElementById('tripSummaryTitle').textContent = 'Your Trip Plan';
        document.getElementById('tripDuration').textContent = 'Loading...';
        document.getElementById('tripTravelers').textContent = 'Loading...';
        document.getElementById('tripCost').textContent = 'Calculating...';
        
        // Scroll to results
        tripResults.scrollIntoView({ behavior: 'smooth' });
        
        try {
            // In a real app, this would call your backend API
            const response = await fetch('/api/ai/trip/plan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || ''
                },
                body: JSON.stringify({ query }),
                credentials: 'include'
            });
            
            const tripPlan = await response.json();
            
            if (response.ok) {
                displayTripPlan(tripPlan);
            } else {
                throw new Error(tripPlan.error || 'Failed to generate trip plan');
            }
        } catch (error) {
            console.error('Error planning trip:', error);
            showToast('Failed to generate trip plan. Please try again.', 'error');
            
            // Show error state
            document.getElementById('tripItinerary').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Failed to generate trip plan. ${error.message || 'Please try again with different parameters.'}
                </div>
            `;
        }
    }
    
    function displayTripPlan(tripPlan) {
        // Update summary
        if (tripPlan.summary) {
            document.getElementById('tripSummaryTitle').textContent = tripPlan.summary;
        }
        
        if (tripPlan.days) {
            document.getElementById('tripDuration').textContent = 
                `${tripPlan.days.length} day${tripPlan.days.length > 1 ? 's' : ''}, ${tripPlan.days.length - 1} night${tripPlan.days.length > 2 ? 's' : ''}`;
        }
        
        // Update travelers and cost if available in the plan
        if (tripPlan.travelers) {
            document.getElementById('tripTravelers').textContent = 
                `${tripPlan.travelers} traveler${tripPlan.travelers > 1 ? 's' : ''}`;
        }
        
        if (tripPlan.totalEstimatedCost) {
            document.getElementById('tripCost').textContent = tripPlan.totalEstimatedCost;
        }
        
        // Generate itinerary HTML
        let itineraryHtml = '';
        
        if (tripPlan.days && tripPlan.days.length > 0) {
            tripPlan.days.forEach((day, dayIndex) => {
                itineraryHtml += `
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Day ${day.day}: ${day.date || ''}</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush">
                `;
                
                if (day.activities && day.activities.length > 0) {
                    day.activities.forEach((activity, activityIndex) => {
                        const activityTypeClass = getActivityTypeClass(activity.type);
                        
                        itineraryHtml += `
                            <div class="list-group-item">
                                <div class="d-flex">
                                    <div class="me-3 text-center" style="min-width: 60px;">
                                        <div class="text-primary fw-bold">${activity.time || '--:--'}</div>
                                        <span class="badge ${activityTypeClass} mt-1">
                                            ${getActivityIcon(activity.type)} ${activity.type || 'Activity'}
                                        </span>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">${activity.title || 'Activity'}</h6>
                                        ${activity.description ? `<p class="mb-1 small">${activity.description}</p>` : ''}
                                        <div class="d-flex flex-wrap gap-3 mt-2">
                                            ${activity.location ? `
                                                <span class="text-muted small">
                                                    <i class="fas fa-map-marker-alt me-1"></i> ${activity.location}
                                                </span>
                                            ` : ''}
                                            ${activity.duration ? `
                                                <span class="text-muted small">
                                                    <i class="far fa-clock me-1"></i> ${activity.duration}
                                                </span>
                                            ` : ''}
                                            ${activity.cost ? `
                                                <span class="text-muted small">
                                                    <i class="fas fa-rupee-sign me-1"></i> ${activity.cost}
                                                </span>
                                            ` : ''}
                                        </div>
                                    </div>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li><a class="dropdown-item" href="#"><i class="fas fa-edit me-2"></i>Edit</a></li>
                                            <li><a class="dropdown-item" href="#"><i class="fas fa-trash-alt me-2"></i>Remove</a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item" href="#"><i class="fas fa-info-circle me-2"></i>More Info</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    itineraryHtml += `
                        <div class="list-group-item text-center py-4 text-muted">
                            <i class="far fa-calendar-plus fa-2x mb-2"></i>
                            <p class="mb-0">No activities planned for this day</p>
                            <button class="btn btn-sm btn-outline-primary mt-2">
                                <i class="fas fa-plus me-1"></i>Add Activity
                            </button>
                        </div>
                    `;
                }
                
                itineraryHtml += `
                            </div>
                        </div>
                    </div>
                `;
            });
        } else {
            itineraryHtml = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    No itinerary details available. Try customizing your search.
                </div>
            `;
        }
        
        document.getElementById('tripItinerary').innerHTML = itineraryHtml;
    }
    
    function getActivityTypeClass(type) {
        if (!type) return 'bg-secondary';
        
        const typeLower = type.toLowerCase();
        
        if (typeLower.includes('meal') || typeLower.includes('food') || typeLower.includes('dining')) {
            return 'bg-success text-white';
        } else if (typeLower.includes('transport') || typeLower.includes('travel') || typeLower.includes('flight')) {
            return 'bg-info text-dark';
        } else if (typeLower.includes('hotel') || typeLower.includes('stay') || typeLower.includes('accommodation')) {
            return 'bg-warning text-dark';
        } else if (typeLower.includes('activity') || typeLower.includes('tour') || typeLower.includes('sightseeing')) {
            return 'bg-primary text-white';
        } else {
            return 'bg-secondary text-white';
        }
    }
    
    function getActivityIcon(type) {
        if (!type) return '<i class="far fa-calendar"></i>';
        
        const typeLower = type.toLowerCase();
        
        if (typeLower.includes('meal') || typeLower.includes('food') || typeLower.includes('dining')) {
            return '<i class="fas fa-utensils"></i>';
        } else if (typeLower.includes('transport') || typeLower.includes('travel')) {
            return '<i class="fas fa-car"></i>';
        } else if (typeLower.includes('flight')) {
            return '<i class="fas fa-plane"></i>';
        } else if (typeLower.includes('hotel') || typeLower.includes('stay') || typeLower.includes('accommodation')) {
            return '<i class="fas fa-hotel"></i>';
        } else if (typeLower.includes('activity') || typeLower.includes('tour') || typeLower.includes('sightseeing')) {
            return '<i class="fas fa-binoculars"></i>';
        } else {
            return '<i class="far fa-calendar"></i>';
        }
    }
    
    function showToast(message, type = 'info') {
        // In a real app, you would use a toast library or create a toast component
        alert(`${type.toUpperCase()}: ${message}`);
    }
});
</script>

<style>
.trip-planner-form .input-group {
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    overflow: hidden;
}

.trip-planner-form .form-control {
    border: none;
    padding: 1rem 1.5rem;
    font-size: 1.1rem;
}

.trip-planner-form .form-control:focus {
    box-shadow: none;
}

.trip-planner-form .btn {
    padding: 0 2rem;
    font-weight: 500;
}

.divider {
    height: 1px;
    background-color: #e9ecef;
    text-align: center;
    position: relative;
}

.divider span {
    position: relative;
    top: -0.7em;
    font-size: 0.9rem;
}

.trip-option-card {
    transition: all 0.3s ease;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    overflow: hidden;
    height: 100%;
}

.trip-option-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    border-color: #0d6efd;
}

.trip-option-card .card-img-top {
    height: 120px;
    object-fit: cover;
}

.trip-option-card .card-body {
    padding: 1.25rem;
}

.trip-option-card .card-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.trip-option-card .card-text {
    font-size: 0.85rem;
    color: #6c757d;
    margin-bottom: 1rem;
}

.trip-option-card .btn {
    font-size: 0.8rem;
    padding: 0.25rem 0.75rem;
}

/* Activity timeline */
.activity-timeline {
    position: relative;
    padding-left: 30px;
    margin: 20px 0;
}

.activity-timeline::before {
    content: '';
    position: absolute;
    left: 10px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #e9ecef;
}

.timeline-item {
    position: relative;
    padding-bottom: 20px;
}

.timeline-item:last-child {
    padding-bottom: 0;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: -30px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #0d6efd;
    border: 2px solid #fff;
    box-shadow: 0 0 0 2px #0d6efd;
}

.timeline-time {
    font-size: 0.8rem;
    color: #6c757d;
    margin-bottom: 5px;
}

.timeline-content {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.timeline-title {
    font-weight: 600;
    margin-bottom: 5px;
    color: #212529;
}

.timeline-description {
    font-size: 0.9rem;
    color: #6c757d;
    margin-bottom: 0;
}

/* Responsive adjustments */
@media (max-width: 767.98px) {
    .trip-planner-form .btn {
        padding: 0.5rem 1rem;
    }
    
    .trip-option-card {
        margin-bottom: 1.5rem;
    }
}
</style>
